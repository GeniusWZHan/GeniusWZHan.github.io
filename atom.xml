<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>戒修-沉迷技术的小沙弥</title>
  <subtitle>我喜欢GO</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://leokongwq.github.io/"/>
  <updated>2018-07-15T13:20:06.000Z</updated>
  <id>https://leokongwq.github.io/</id>
  
  <author>
    <name>kongwenqiang</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>servlet如何正确处理302跳转</title>
    <link href="https://leokongwq.github.io/2018/07/15/how-to-process-302-in-j2ee-correctly.html"/>
    <id>https://leokongwq.github.io/2018/07/15/how-to-process-302-in-j2ee-correctly.html</id>
    <published>2018-07-15T02:08:31.000Z</published>
    <updated>2018-07-15T13:20:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>某天，将线上的resin容器替换为tomcat．　过了一段时间发现有个接口处理失败，提示异常．查看应用日志发现如下的日志：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line">Caused by: javax.servlet.ServletException: java.lang.IllegalStateException: Cannot create a session after the response has been committed</span>
<span class="line">        at org.apache.jsp.WEB_002dINF.content.order.page.error_jsp._jspService(error_jsp.java:<span class="number">293</span>) ~[na:na]</span>
<span class="line">        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:<span class="number">70</span>) ~[jasper.jar:<span class="number">8.5</span>.12]</span>
<span class="line">        at javax.servlet.http.HttpServlet.service(HttpServlet.java:<span class="number">742</span>) ~[servlet-api.jar:na]</span>
<span class="line">        at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:<span class="number">443</span>) ~[jasper.jar:<span class="number">8.5</span>.12]</span>
<span class="line">        ... <span class="number">38</span> common frames omitted</span>
</pre></td></tr></table></figure>
<p>查询相关接口的代码发现，代码对<code>302</code>跳转的逻辑处理有问题，具体如下：</p>
<a id="more"></a>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Actions</span>(value = &#123;</span>
<span class="line">            <span class="meta">@Action</span>(value = <span class="string">"dopay"</span>, results = &#123;<span class="meta">@Result</span>(name = ERROR, location = <span class="string">"/WEB-INF/content/order/page/error.jsp"</span>)&#125;),</span>
<span class="line">    &#125;)</span>
<span class="line">    <span class="meta">@ActionMonitor</span>(value = <span class="string">"pay.doPay"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">doPay</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="comment">// 省略代码</span></span>
<span class="line">        String _result = dealWapClient(params);</span>
<span class="line">        <span class="comment">// 问题之所在，　当dealWapClient处理成功时，返回值就是null</span></span>
<span class="line">        <span class="comment">// 此时，返回ERROR， Struts2会继续执行，渲染错误页面(客户端就能看到错误页面了)</span></span>
<span class="line">        <span class="comment">// tomcat 能看到，　resin下看不到，原因下面分析</span></span>
<span class="line">        <span class="keyword">if</span> (_result == <span class="keyword">null</span>) &#123;</span>
<span class="line">            <span class="keyword">return</span> ERROR;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="comment">// 省略代码</span></span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">dealWapClient</span><span class="params">(Map&lt;String, String&gt; params)</span> </span>&#123;</span>
<span class="line">        <span class="comment">// 省略代码</span></span>
<span class="line">        redirect(returnParams, returnUrl);</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">null</span>;</span>
<span class="line">        <span class="comment">// 省略代码</span></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="302跳转解释"><a href="#302跳转解释" class="headerlink" title="302跳转解释"></a>302跳转解释</h3><p>关于302临时跳转的详细解释可以参考<a href="https://zh.wikipedia.org/wiki/HTTP_302" target="_blank" rel="external">HTTP_302</a>.<br>也可以参考RFC规范<a href="http://www.ietf.org/rfc/rfc3986.txt" target="_blank" rel="external">http://www.ietf.org/rfc/rfc3986.txt</a><br>再次就不再赘述．</p>
<h3 id="servlet-api对302处理的规定"><a href="#servlet-api对302处理的规定" class="headerlink" title="servlet　api对302处理的规定"></a>servlet　api对302处理的规定</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line">* Sends a temporary redirect response to the client using the</span>
<span class="line">* specified redirect location URL and clears the buffer. The buffer will</span>
<span class="line">* be replaced with the data set by this method. Calling this method sets the</span>
<span class="line">* status code to &#123;<span class="doctag">@link</span> #SC_FOUND&#125; 302 (Found).</span>
<span class="line">* This method can accept relative URLs;the servlet container must convert</span>
<span class="line">* the relative URL to an absolute URL</span>
<span class="line">* before sending the response to the client. If the location is relative </span>
<span class="line">* without a leading '/' the container interprets it as relative to</span>
<span class="line">* the current request URI. If the location is relative with a leading</span>
<span class="line">* '/' the container interprets it as relative to the servlet container root.</span>
<span class="line">* If the location is relative with two leading '/' the container interprets</span>
<span class="line">* it as a network-path reference (see</span>
<span class="line">* &lt;a href="http://www.ietf.org/rfc/rfc3986.txt"&gt;</span>
<span class="line">* RFC 3986: Uniform Resource Identifier (URI): Generic Syntax&lt;/a&gt;, section 4.2</span>
<span class="line">* &amp;quot;Relative Reference&amp;quot;).</span>
<span class="line">*</span>
<span class="line">* &lt;p&gt;If the response has already been committed, this method throws </span>
<span class="line">* an IllegalStateException.</span>
<span class="line">* After using this method, the response should be considered</span>
<span class="line">* to be committed and should not be written to.</span>
<span class="line">*</span>
<span class="line">* <span class="doctag">@param</span>		location	the redirect location URL</span>
<span class="line">* <span class="doctag">@exception</span>	IOException	If an input or output exception occurs</span>
<span class="line">* <span class="doctag">@exception</span>	IllegalStateException	If the response was committed or</span>
<span class="line">*              if a partial URL is given and cannot be converted into a valid URL</span>
<span class="line">*/</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRedirect</span><span class="params">(String location)</span> <span class="keyword">throws</span> IOException</span>;</span>
</pre></td></tr></table></figure>
<blockquote>
<p>翻译过来意思就是： 通过该方法告诉客户端临时重定向到一个指定的URL，并且清空缓存区，之前还没有发送到客户端的数据．<br>并使用该方法设置的数据填充缓存区．<br>该方法设置http响应的状态码为302.<br>如果重定向的地址为相对地址，该方法内部会将相对地址转为绝对地址．　<br>如果response已经committed，再次调用该方法会抛出<code>IllegalStateException</code>异常.<br>调用该方法后，　response对象的状态应该是<code>committed</code>，并且不应该再写入数据．</p>
</blockquote>
<p>servlet-api已经详细说明了该方法的用法和需要注意的事项．但是不同的servlet容器在实现机制上可能不尽相同．<br>项目中发现的问题主要有两个原因：</p>
<ol>
<li>代码有bug．这个是主要原因．</li>
<li>servlet容器实现不同．</li>
</ol>
<p>下面就分析下该方法在resin和tomcat中实现的细节：</p>
<h3 id="resin对302的处理"><a href="#resin对302的处理" class="headerlink" title="resin对302的处理"></a>resin对302的处理</h3><p>在resin中，<code>HttpServletResponse</code>接口的实现类是<code>HttpServletResponseImpl</code>．代码如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
<span class="line">78</span>
<span class="line">79</span>
<span class="line">80</span>
<span class="line">81</span>
<span class="line">82</span>
<span class="line">83</span>
<span class="line">84</span>
<span class="line">85</span>
<span class="line">86</span>
<span class="line">87</span>
<span class="line">88</span>
<span class="line">89</span>
<span class="line">90</span>
<span class="line">91</span>
<span class="line">92</span>
<span class="line">93</span>
<span class="line">94</span>
<span class="line">95</span>
<span class="line">96</span>
<span class="line">97</span>
<span class="line">98</span>
<span class="line">99</span>
<span class="line">100</span>
<span class="line">101</span>
<span class="line">102</span>
<span class="line">103</span>
<span class="line">104</span>
<span class="line">105</span>
<span class="line">106</span>
<span class="line">107</span>
<span class="line">108</span>
<span class="line">109</span>
<span class="line">110</span>
<span class="line">111</span>
</pre></td><td class="code"><pre><span class="line">abstract public class AbstractCauchoResponse implements CauchoResponse &#123;</span>
<span class="line"></span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">public interface CauchoResponse extends HttpServletResponse &#123;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">public final class HttpServletResponseImpl extends AbstractCauchoResponse</span>
<span class="line">  implements CauchoResponse</span>
<span class="line">&#123;</span>
<span class="line">    /**</span>
<span class="line">   * Sends a redirect to the browser.  If the URL is relative, it gets</span>
<span class="line">   * combined with the current url.</span>
<span class="line">   *</span>
<span class="line">   * @param url the possibly relative url to send to the browser</span>
<span class="line">   */</span>
<span class="line">  @Override</span>
<span class="line">  public void sendRedirect(String url)</span>
<span class="line">    throws IOException</span>
<span class="line">  &#123;</span>
<span class="line">    if (url == null)</span>
<span class="line">      throw new NullPointerException();</span>
<span class="line"></span>
<span class="line">    if (isCommitted())</span>
<span class="line">      throw new IllegalStateException(L.l("Can't sendRedirect() after data has committed to the client."));</span>
<span class="line"></span>
<span class="line">    _responseStream.clearBuffer();</span>
<span class="line"></span>
<span class="line">    // server/10c4</span>
<span class="line">    // reset();</span>
<span class="line">    resetBuffer();</span>
<span class="line"></span>
<span class="line">    setStatus(SC_MOVED_TEMPORARILY);</span>
<span class="line"></span>
<span class="line">    String encoding = getCharacterEncoding();</span>
<span class="line">    boolean isLatin1 = "iso-8859-1".equals(encoding);</span>
<span class="line">    </span>
<span class="line">    String path = encodeAbsoluteRedirect(url);</span>
<span class="line"></span>
<span class="line">    setHeader("Location", path);</span>
<span class="line">    </span>
<span class="line">    if (isLatin1)</span>
<span class="line">      setHeader("Content-Type", "text/html; charset=iso-8859-1");</span>
<span class="line">    else</span>
<span class="line">      setHeader("Content-Type", "text/html; charset=utf-8");</span>
<span class="line"></span>
<span class="line">    String msg = "The URL has moved &lt;a href=\"" + path + "\"&gt;here&lt;/a&gt;";</span>
<span class="line"></span>
<span class="line">    // The data is required for some WAP devices that can't handle an</span>
<span class="line">    // empty response.</span>
<span class="line">    if (_writer != null) &#123;</span>
<span class="line">      _writer.println(msg);</span>
<span class="line">    &#125;</span>
<span class="line">    else &#123;</span>
<span class="line">      ServletOutputStream out = getOutputStream();</span>
<span class="line">      out.println(msg);</span>
<span class="line">    &#125;</span>
<span class="line">    // closeConnection();</span>
<span class="line"></span>
<span class="line">    _request.saveSession(); // #503</span>
<span class="line">    // 非常重要，这个就是resion和tomcat的不同之处．</span>
<span class="line">    // 已经关闭了，肯定不能再写入数据．</span>
<span class="line">    close();</span>
<span class="line">  &#125;</span>
<span class="line">   @Override</span>
<span class="line">  public void close()</span>
<span class="line">    throws IOException</span>
<span class="line">  &#123;</span>
<span class="line">    // tck - jsp include</span>
<span class="line">    AbstractHttpResponse response = _response;</span>
<span class="line">    </span>
<span class="line">    if (response != null) &#123;</span>
<span class="line">      response.close();</span>
<span class="line">    &#125;</span>
<span class="line">  &#125;</span>
<span class="line"></span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line">resin处理`302`方式其实非常简单，步骤如下：</span>
<span class="line"></span>
<span class="line">1. 清空缓存区内容并进行重置</span>
<span class="line">2. 设置302状态码</span>
<span class="line">3. 设置`Location`　和　`Content-Type` 响应头</span>
<span class="line">4. 写响应体数据</span>
<span class="line">5. 保存session</span>
<span class="line">6. 关闭连接</span>
<span class="line"></span>
<span class="line">整个处理流程非常简单明了．</span>
<span class="line"></span>
<span class="line">### tomcat对302的处理</span>
<span class="line"></span>
<span class="line">在tomcat中，`HttpServletResponse`接口的实现类是`ResponseFacade`．该类指示一个Facade,</span>
<span class="line">代码如下：</span>
<span class="line"></span>
<span class="line">```java ResponseFacade</span>
<span class="line">public class ResponseFacade implements HttpServletResponse &#123;</span>
<span class="line">    @Override</span>
<span class="line">    public void sendRedirect(String location)</span>
<span class="line">        throws IOException &#123;</span>
<span class="line"></span>
<span class="line">        if (isCommitted()) &#123;</span>
<span class="line">            throw new IllegalStateException</span>
<span class="line">                (sm.getString("coyoteResponse.sendRedirect.ise"));</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        response.setAppCommitted(true);</span>
<span class="line"></span>
<span class="line">        response.sendRedirect(location);</span>
<span class="line"></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>真正的处理由<code>Response</code>来进行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Response</span> <span class="keyword">implements</span> <span class="title">HttpServletResponse</span> </span>&#123;</span>
<span class="line">    <span class="comment">/**</span>
<span class="line">    * Send a temporary redirect to the specified redirect location URL.</span>
<span class="line">    *</span>
<span class="line">    * <span class="doctag">@param</span> location Location URL to redirect to</span>
<span class="line">    *</span>
<span class="line">    * <span class="doctag">@exception</span> IllegalStateException if this response has</span>
<span class="line">    *  already been committed</span>
<span class="line">    * <span class="doctag">@exception</span> IOException if an input/output error occurs</span>
<span class="line">    */</span></span>
<span class="line">    <span class="meta">@Override</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRedirect</span><span class="params">(String location)</span> <span class="keyword">throws</span> IOException </span>&#123;</span>
<span class="line">        sendRedirect(location, SC_FOUND);</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * Internal method that allows a redirect to be sent with a status other</span>
<span class="line">     * than &#123;<span class="doctag">@link</span> HttpServletResponse#SC_FOUND&#125; (302). No attempt is made to</span>
<span class="line">     * validate the status code.</span>
<span class="line">     *</span>
<span class="line">     * <span class="doctag">@param</span> location Location URL to redirect to</span>
<span class="line">     * <span class="doctag">@param</span> status HTTP status code that will be sent</span>
<span class="line">     * <span class="doctag">@throws</span> IOException an IO exception occurred</span>
<span class="line">     */</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">sendRedirect</span><span class="params">(String location, <span class="keyword">int</span> status)</span> <span class="keyword">throws</span> IOException </span>&#123;</span>
<span class="line">        <span class="keyword">if</span> (isCommitted()) &#123;</span>
<span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"coyoteResponse.sendRedirect.ise"</span>));</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// Ignore any call from an included servlet</span></span>
<span class="line">        <span class="keyword">if</span> (included) &#123;</span>
<span class="line">            <span class="keyword">return</span>;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 清空缓存区内容并进行重置</span></span>
<span class="line">        resetBuffer(<span class="keyword">true</span>);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// Generate a temporary redirect to the specified location</span></span>
<span class="line">        <span class="keyword">try</span> &#123;</span>
<span class="line">            String locationUri;</span>
<span class="line">            <span class="comment">// Relative redirects require HTTP/1.1</span></span>
<span class="line">            <span class="keyword">if</span> (getRequest().getCoyoteRequest().getSupportsRelativeRedirects() &amp;&amp;</span>
<span class="line">                    getContext().getUseRelativeRedirects()) &#123;</span>
<span class="line">                locationUri = location;</span>
<span class="line">            &#125; <span class="keyword">else</span> &#123;</span>
<span class="line">                locationUri = toAbsolute(location);</span>
<span class="line">            &#125;</span>
<span class="line">            setStatus(status);</span>
<span class="line">            setHeader(<span class="string">"Location"</span>, locationUri);</span>
<span class="line">            <span class="comment">//　这里有个小魔法</span></span>
<span class="line">            <span class="keyword">if</span> (getContext().getSendRedirectBody()) &#123;</span>
<span class="line">                PrintWriter writer = getWriter();</span>
<span class="line">                writer.print(sm.getString(<span class="string">"coyoteResponse.sendRedirect.note"</span>,</span>
<span class="line">                        Escape.htmlElementContent(locationUri)));</span>
<span class="line">                flushBuffer();</span>
<span class="line">            &#125;</span>
<span class="line">        &#125; <span class="keyword">catch</span> (IllegalArgumentException e) &#123;</span>
<span class="line">            log.warn(sm.getString(<span class="string">"response.sendRedirectFail"</span>, location), e);</span>
<span class="line">            setStatus(SC_NOT_FOUND);</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 设置缓存区的suspended标志位　</span></span>
<span class="line">        <span class="comment">// 从应用视图的角度看，该响应已经结束了． 但其实连接并没有关闭.</span></span>
<span class="line">        setSuspended(<span class="keyword">true</span>);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>tomcat处理<code>302</code>步骤如下：</p>
<ol>
<li>清空缓存区内容并进行重置</li>
<li>设置302状态码</li>
<li>设置<code>Location</code> 响应头</li>
<li>写响应体数据</li>
<li>保存session</li>
<li>关闭连接</li>
</ol>
<h4 id="tomcat-context配置"><a href="#tomcat-context配置" class="headerlink" title="tomcat context配置"></a>tomcat context配置</h4><p>详细配置项参考:<a href="https://tomcat.apache.org/tomcat-7.0-doc/config/context.html" target="_blank" rel="external">https://tomcat.apache.org/tomcat-7.0-doc/config/context.html</a></p>
<p>其中和302处理相关的一个配置项为:<code>sendRedirectBody</code>,文档解释如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">If <span class="keyword">true</span>, redirect responses will include a <span class="keyword">short</span> response body that includes details of the redirect as recommended by RFC <span class="number">2616</span>. This is disabled by <span class="keyword">default</span> since including a response body may cause problems <span class="keyword">for</span> some application component such as compression filters.</span>
</pre></td></tr></table></figure>
<p>根据<a href="https://tools.ietf.org/html/rfc2616" target="_blank" rel="external">RFC 2616</a>规范，302跳转是可以带有响应体数据的(resin就按规范进行了实现).　tomcat默认处理是不带的，原因是可能与其它组件冲突，例如压缩组件.</p>
<p>如果将<code>sendRedirectBody</code>的值设为true,则tomcat在处理302时，在写完响应体数据后，会执行缓存区的刷新，客户端能收到对应的响应头数据，完成跳转，且不会应为后续继续写数据导致客户端不能正常跳转.</p>
<p>因为默认是false,导致302响应头数据没有及时发送给客户端，在<code>sendRedirect</code>后如果应用发生了异常，则已经设置了的302响应码会被500所替代，客户端不能正常跳转．</p>
<p>###　tomcat　<code>sendRedirect</code>后不能跳转的逻辑分析</p>
<p>tomcat　处理请求的流程一部分流程如下：</p>
<p><code>StandardHostValve</code> -&gt; <code>StandardContextValve</code> -&gt; <code>StandardWrapperValve</code></p>
<p>请求入口由<code>StandardWrapperValve</code>处理，　结束还是需要<code>StandardHostValve</code>来处理．</p>
<figure class="highlight java"><figcaption><span>StandardWrapperValve</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span>
<span class="line">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="comment">// Allocate a servlet instance to process this request</span></span>
<span class="line">    <span class="keyword">try</span> &#123;</span>
<span class="line">        <span class="keyword">if</span> (!unavailable) &#123;</span>
<span class="line">            servlet = wrapper.allocate();</span>
<span class="line">        &#125;</span>
<span class="line">    &#125; <span class="keyword">catch</span> (UnavailableException e) &#123;</span>
<span class="line">       </span>
<span class="line">    &#125; <span class="keyword">catch</span> (ServletException e) &#123;</span>
<span class="line">        </span>
<span class="line">        exception(request, response, e);</span>
<span class="line">    &#125; <span class="keyword">catch</span> (Throwable e) &#123;</span>
<span class="line">        exception(request, response, e);</span>
<span class="line">        servlet = <span class="keyword">null</span>;</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="comment">//　当请求发送异常时, 已经设置的302状态码此时变为500</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">exception</span><span class="params">(Request request, Response response,</span>
<span class="line">                           Throwable exception)</span> </span>&#123;</span>
<span class="line">        request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, exception);</span>
<span class="line">        response.setStatus(HttpServletResponse.SC_INTERNAL_SERVER_ERROR);</span>
<span class="line">        response.setError();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>StandardHostValve　处理逻辑</p>
<figure class="highlight java"><figcaption><span>StandardHostValve</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">invoke</span><span class="params">(Request request, Response response)</span></span>
<span class="line">    <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">try</span> &#123;</span>
<span class="line">        <span class="comment">// 省略代码</span></span>
<span class="line">        <span class="keyword">try</span> &#123;</span>
<span class="line">            <span class="keyword">if</span> (!asyncAtStart || asyncDispatching) &#123;</span>
<span class="line">                context.getPipeline().getFirst().invoke(request, response);</span>
<span class="line">            &#125; <span class="keyword">else</span> &#123;</span>
<span class="line">                <span class="comment">// Make sure this request/response is here because an error</span></span>
<span class="line">                <span class="comment">// report is required.</span></span>
<span class="line">                <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span>
<span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(sm.getString(<span class="string">"standardHost.asyncStateError"</span>));</span>
<span class="line">                &#125;</span>
<span class="line">            &#125;</span>
<span class="line">        &#125; <span class="keyword">catch</span> (Throwable t) &#123;</span>
<span class="line">            ExceptionUtils.handleThrowable(t);</span>
<span class="line">            container.getLogger().error(<span class="string">"Exception Processing "</span> + request.getRequestURI(), t);</span>
<span class="line">            <span class="comment">// If a new error occurred while trying to report a previous</span></span>
<span class="line">            <span class="comment">// error allow the original error to be reported.</span></span>
<span class="line">            <span class="keyword">if</span> (!response.isErrorReportRequired()) &#123;</span>
<span class="line">                request.setAttribute(RequestDispatcher.ERROR_EXCEPTION, t);</span>
<span class="line">                throwable(request, response, t);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="comment">// 在sendRedirect方法设置的suspended标志位此时又被置为false</span></span>
<span class="line">        <span class="comment">// 也就是说　response由可以使用了．这就是resin和tomcat设计实现的不同        </span></span>
<span class="line">        <span class="comment">// Now that the request/response pair is back under container</span></span>
<span class="line">        <span class="comment">// control lift the suspension so that the error handling can</span></span>
<span class="line">        <span class="comment">// complete and/or the container can flush any remaining data</span></span>
<span class="line">        response.setSuspended(<span class="keyword">false</span>);</span>
<span class="line"></span>
<span class="line">        Throwable t = (Throwable) request.getAttribute(RequestDispatcher.ERROR_EXCEPTION);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// Protect against NPEs if the context was destroyed during a</span></span>
<span class="line">        <span class="comment">// long running request.</span></span>
<span class="line">        <span class="keyword">if</span> (!context.getState().isAvailable()) &#123;</span>
<span class="line">            <span class="keyword">return</span>;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// Look for (and render if found) an application level error page</span></span>
<span class="line">        <span class="keyword">if</span> (response.isErrorReportRequired()) &#123;</span>
<span class="line">            <span class="keyword">if</span> (t != <span class="keyword">null</span>) &#123;</span>
<span class="line">                throwable(request, response, t);</span>
<span class="line">            &#125; <span class="keyword">else</span> &#123;</span>
<span class="line">                status(request, response);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="keyword">if</span> (!request.isAsync() &amp;&amp; !asyncAtStart) &#123;</span>
<span class="line">            context.fireRequestDestroyEvent(request.getRequest());</span>
<span class="line">        &#125;</span>
<span class="line">    &#125; <span class="keyword">finally</span> &#123;</span>
<span class="line">        <span class="comment">// Access a session (if present) to update last accessed time, based</span></span>
<span class="line">        <span class="comment">// on a strict interpretation of the specification</span></span>
<span class="line">        <span class="keyword">if</span> (ACCESS_SESSION) &#123;</span>
<span class="line">            request.getSession(<span class="keyword">false</span>);</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        context.unbind(Globals.IS_SECURITY_ENABLED, MY_CLASSLOADER);</span>
<span class="line">    &#125;        </span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>线上替换应用组件，尤其是底层的应用软件需要非常注意．不可全量替换．一定要逐步替换．虽然已经在测试环境，线上灰度替换了一台机器，<br>但是因为访问量小，导致问题发现的比较晚，直至大批量替换才发现问题．　还有就是：同一个规范，但不同的实现细节还是有差异．</li>
<li>应用开发一定需要遵守API规范，否则会导致奇怪问题的发生．好多人总是说遇到的问题多，踩坑多，那是因为你从来不仔细阅读相关api规范文档或官方文档．不遵守规范导致的问题能叫坑吗？</li>
<li>在使用任何一项技术时，优先查询官方文档．不要随手google或baidu．　实话说，网上的文章质量参差不齐，难免找到理解错误的文档．</li>
<li>养成阅读源代码的习惯，好处不言而喻．如果３年前没有读过tomcat6的源代码，今天排查起来问题就非常困难了.</li>
</ol>
<h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><a href="https://zh.wikipedia.org/wiki/HTTP_302" target="_blank" rel="external">https://zh.wikipedia.org/wiki/HTTP_302</a><br><a href="https://tools.ietf.org/html/rfc2616#section-10.3.3" target="_blank" rel="external">https://tools.ietf.org/html/rfc2616#section-10.3.3</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h2&gt;&lt;p&gt;某天，将线上的resin容器替换为tomcat．　过了一段时间发现有个接口处理失败，提示异常．查看应用日志发现如下的日志：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;Caused by: javax.servlet.ServletException: java.lang.IllegalStateException: Cannot create a session after the response has been committed&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;        at org.apache.jsp.WEB_002dINF.content.order.page.error_jsp._jspService(error_jsp.java:&lt;span class=&quot;number&quot;&gt;293&lt;/span&gt;) ~[na:na]&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;        at org.apache.jasper.runtime.HttpJspBase.service(HttpJspBase.java:&lt;span class=&quot;number&quot;&gt;70&lt;/span&gt;) ~[jasper.jar:&lt;span class=&quot;number&quot;&gt;8.5&lt;/span&gt;.12]&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;        at javax.servlet.http.HttpServlet.service(HttpServlet.java:&lt;span class=&quot;number&quot;&gt;742&lt;/span&gt;) ~[servlet-api.jar:na]&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;        at org.apache.jasper.servlet.JspServletWrapper.service(JspServletWrapper.java:&lt;span class=&quot;number&quot;&gt;443&lt;/span&gt;) ~[jasper.jar:&lt;span class=&quot;number&quot;&gt;8.5&lt;/span&gt;.12]&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;        ... &lt;span class=&quot;number&quot;&gt;38&lt;/span&gt; common frames omitted&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;查询相关接口的代码发现，代码对&lt;code&gt;302&lt;/code&gt;跳转的逻辑处理有问题，具体如下：&lt;/p&gt;
    
    </summary>
    
    
      <category term="web" scheme="https://leokongwq.github.io/tags/web/"/>
    
      <category term="tomcat" scheme="https://leokongwq.github.io/tags/tomcat/"/>
    
      <category term="resin" scheme="https://leokongwq.github.io/tags/resin/"/>
    
  </entry>
  
  <entry>
    <title>consul之acl配置</title>
    <link href="https://leokongwq.github.io/2018/07/08/consul-acl.html"/>
    <id>https://leokongwq.github.io/2018/07/08/consul-acl.html</id>
    <published>2018-07-08T15:08:31.000Z</published>
    <updated>2018-07-15T13:20:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><h2 id="配置项"><a href="#配置项" class="headerlink" title="配置项"></a>配置项</h2><h3 id="acl-datacenter"><a href="#acl-datacenter" class="headerlink" title="acl_datacenter"></a>acl_datacenter</h3><p>该配置项指定了对ACL信息具有权威性的数据中心。 必须提供它才能启用ACL。 所有Server实例和数据中心必须就ACL数据中心达成一致。<br>必须在整个集群的Server节点上设置该配置项。但是针对API来说，如果要使客户端的请求能被正确转发，那么也需要在客户端节点设置。<br>在Consul 0.8及更高版本中，还可以启用代理级别的ACL。 有关详细信息，请参阅<a href="https://www.consul.io/docs/guides/acl.html" target="_blank" rel="external">ACL指南</a>。</p>
<h3 id="acl-default-policy"><a href="#acl-default-policy" class="headerlink" title="acl_default_policy"></a>acl_default_policy</h3><p>该配置项可选的值为<code>allow</code>和<code>deny</code>。默认值为’allow’。默认的策略控制token在没有匹配的规则时的行为。<br>在<code>allow</code>模式下，ACL规则是一个黑名单：任何没有被禁止的操作都是可以执行的。<br>在<code>deny</code>模式下，ACL规则是一个白名单，任何没有明确指定的操作都是被禁止的。</p>
<blockquote>
<p>注意：该配置项只有在配置了<code>acl_datacenter</code>后才起作用</p>
</blockquote>
<a id="more"></a>
<h3 id="acl-down-policy"><a href="#acl-down-policy" class="headerlink" title="acl_down_policy"></a>acl_down_policy</h3><p>该配置项可选的值为<code>allow</code>，<code>deny</code>或<code>extend-cache</code>，　默认值是<code>extend-cache</code>。假如不能从<code>acl_datacenter</code>或<code>Leader</code>节点获取一个token的acl信息，则该配置项指定的策略被使用。</p>
<ul>
<li><code>allow</code>模式下，所有的操作都允许。 </li>
<li><code>deny</code>模式下，所有的操作都被禁止。 </li>
<li><code>extend-cache</code>模式下,使用缓存的 ACL规则并忽略这些规则的过期时间。如果一个不可缓存的ＡＣＬ的规则被使用，则当作<code>deny</code>策略来处理。</li>
</ul>
<h3 id="acl-master-token"><a href="#acl-master-token" class="headerlink" title="acl_master_token"></a>acl_master_token</h3><p>该配置项只能用在<code>acl_datacenter</code>中的Server节点上。 如果该令牌不存在，则将使用管理级权限创建该令牌。 它允许操作员使用众所周知的令牌ID来引导ACL系统。</p>
<p>仅当服务器获得集群领导时才安装acl_master_token。 如果要安装或更改acl_master_token，请在所有服务器的配置中为acl_master_token设置新值。 完成此操作后，重新启动当前领导者以强制进行领导者选举。 如果未提供acl_master_token，则服务器不会创建主令牌。 提供值时，它可以是任何字符串值。 使用UUID可以确保它看起来与其他令牌相同，但并不是绝对必要的。</p>
<h3 id="acl-agent-master-token"><a href="#acl-agent-master-token" class="headerlink" title="acl_agent_master_token"></a>acl_agent_master_token</h3><p>用作特殊访问 token，在配置它的每个 agent 上具有 agent ACL 策略 write 特权。 只有当 Consul server 不可用于解析 ACL token 时， 此 tokone 才应由运维人员在服务中断期间使用。 应用程序应在正常操作期间使用常规 ACL token。该配置项从版本<code>0.7.2</code>开始使用，并且只有当配置项<code>acl_enforce_version_8</code>设置为true时才起作用。更多信息参考<a href="https://www.consul.io/docs/guides/acl.html#acl-agent-master-token" target="_blank" rel="external"> ACL Agent Master Token </a></p>
<h3 id="acl-agent-token"><a href="#acl-agent-token" class="headerlink" title="acl_agent_token"></a>acl_agent_token</h3><p>由客户端和<code>Server</code>节点执行内部操作使用。如果没有设置该配置项的值，则<code>acl_token</code>配置项的被使用。该配置项从版本<code>0.7.2</code>开始使用。</p>
<p>此令牌必须至少具有对其将注册的节点名称的写访问权，以便设置目录中的任何节点级信息，例如元数据或节点的标记地址。 使用此令牌还有其他地方，请参阅<a href="https://www.consul.io/docs/guides/acl.html#acl-agent-token" target="_blank" rel="external">ACL代理令牌</a>以获取更多详细信息。</p>
<h3 id="acl-enforce-version-8"><a href="#acl-enforce-version-8" class="headerlink" title="acl_enforce_version_8"></a>acl_enforce_version_8</h3><p>用于客户端和服务器，以确定是否应在Consul 0.8之前预览新的ACL策略。 在Consul 0.7.2中添加，在0.8之前的Consul版本中默认为false，在Consul 0.8及更高版本中默认为true。 通过在实施开始之前允许策略到位，这有助于简化向新ACL功能的过渡。 有关详细信息，请参阅ACL指南。</p>
<h3 id="acl-replication-token"><a href="#acl-replication-token" class="headerlink" title="acl_replication_token"></a>acl_replication_token</h3><p>仅用于运行Consul 0.7或更高版本的<code>acl_datacenter</code>之外的服务器。 提供时，这将启用使用此令牌进行ACL复制，以检索ACL并将其复制到非权威的本地数据中心。 在Consul 0.9.1和更高版本中，您可以使用<code>enable_acl_replication</code>启用ACL复制，然后稍后使用每个服务器上的代理令牌API设置令牌。 如果在配置文件中设置了<code>acl_replication_token</code> ，它将自动将<code>enable_acl_replication</code>设置为true以实现向后兼容性。</p>
<p>如果存在影响权威数据中心的分区或其他中断，并且<code>acl_down_policy</code>设置为<code>extend-cache</code>，则可以在中断期间使用复制的ACL集解析不在缓存中的令牌。 有关更多详细信息，请参阅<a href="https://www.consul.io/docs/guides/acl.html#replication" target="_blank" rel="external">ACL指南复制部分</a>。</p>
<h3 id="acl-token"><a href="#acl-token" class="headerlink" title="acl_token"></a>acl_token</h3><p>如果设置了该配置项，代理将在向Consul服务器发出请求时使用此令牌。 客户端可以通过提供<code>？token</code>查询参数，基于每个请求覆盖此令牌。 如果未提供，则使用映射到“匿名”ACL策略的空标记。</p>
<h3 id="acl-ttl"><a href="#acl-ttl" class="headerlink" title="acl_ttl"></a>acl_ttl</h3><p>用于控制ACL缓存的过期时间。 默认是30秒。 此设置会对性能产生重大影响：减少它会导致更频繁的刷新，增加它会减少刷新次数。 但是，由于缓存未被主动失效，因此ACL策略可能会过时到TTL值。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;h2 id=&quot;配置项&quot;&gt;&lt;a href=&quot;#配置项&quot; class=&quot;headerlink&quot; title=&quot;配置项&quot;&gt;&lt;/a&gt;配置项&lt;/h2&gt;&lt;h3 id=&quot;acl-datacenter&quot;&gt;&lt;a href=&quot;#acl-datacenter&quot; class=&quot;headerlink&quot; title=&quot;acl_datacenter&quot;&gt;&lt;/a&gt;acl_datacenter&lt;/h3&gt;&lt;p&gt;该配置项指定了对ACL信息具有权威性的数据中心。 必须提供它才能启用ACL。 所有Server实例和数据中心必须就ACL数据中心达成一致。&lt;br&gt;必须在整个集群的Server节点上设置该配置项。但是针对API来说，如果要使客户端的请求能被正确转发，那么也需要在客户端节点设置。&lt;br&gt;在Consul 0.8及更高版本中，还可以启用代理级别的ACL。 有关详细信息，请参阅&lt;a href=&quot;https://www.consul.io/docs/guides/acl.html&quot;&gt;ACL指南&lt;/a&gt;。&lt;/p&gt;
&lt;h3 id=&quot;acl-default-policy&quot;&gt;&lt;a href=&quot;#acl-default-policy&quot; class=&quot;headerlink&quot; title=&quot;acl_default_policy&quot;&gt;&lt;/a&gt;acl_default_policy&lt;/h3&gt;&lt;p&gt;该配置项可选的值为&lt;code&gt;allow&lt;/code&gt;和&lt;code&gt;deny&lt;/code&gt;。默认值为’allow’。默认的策略控制token在没有匹配的规则时的行为。&lt;br&gt;在&lt;code&gt;allow&lt;/code&gt;模式下，ACL规则是一个黑名单：任何没有被禁止的操作都是可以执行的。&lt;br&gt;在&lt;code&gt;deny&lt;/code&gt;模式下，ACL规则是一个白名单，任何没有明确指定的操作都是被禁止的。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注意：该配置项只有在配置了&lt;code&gt;acl_datacenter&lt;/code&gt;后才起作用&lt;/p&gt;
&lt;/blockquote&gt;
    
    </summary>
    
    
      <category term="consul" scheme="https://leokongwq.github.io/tags/consul/"/>
    
  </entry>
  
  <entry>
    <title>springcloud服务注册之consul</title>
    <link href="https://leokongwq.github.io/2018/07/08/spring-cloud-consul.html"/>
    <id>https://leokongwq.github.io/2018/07/08/spring-cloud-consul.html</id>
    <published>2018-07-08T05:28:16.000Z</published>
    <updated>2018-07-09T02:59:36.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>使用springcloud构建微服务，除了可以使用eureka来实现服务注册和发现外，springcloud对consul也提供了良好的支持。本文就简单介绍下使用springcloud和consul实现服务注册和发现。</p>
<h3 id="consul安装"><a href="#consul安装" class="headerlink" title="consul安装"></a>consul安装</h3><p>consul的安装非常简单，只需要在官网<a href="https://www.consul.io/downloads.html" target="_blank" rel="external">下载</a>对应平台的安装文件即可。</p>
<p>具体安装步骤参考<a href="https://www.consul.io/intro/getting-started/install.html" target="_blank" rel="external">install</a></p>
<a id="more"></a>
<h3 id="服务注册"><a href="#服务注册" class="headerlink" title="服务注册"></a>服务注册</h3><h4 id="maven-配置"><a href="#maven-配置" class="headerlink" title="maven 配置"></a>maven 配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependencyManagement</span>&gt;</span></span>
<span class="line">   <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span>
<span class="line">       <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">           <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">           <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-dependencies<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">           <span class="tag">&lt;<span class="name">version</span>&gt;</span>Camden.SR6<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">           <span class="tag">&lt;<span class="name">type</span>&gt;</span>pom<span class="tag">&lt;/<span class="name">type</span>&gt;</span></span>
<span class="line">           <span class="tag">&lt;<span class="name">scope</span>&gt;</span>import<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span>
<span class="line">       <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">   <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependencyManagement</span>&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-actuator<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-consul-discovery<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h4 id="相关注解配置"><a href="#相关注解配置" class="headerlink" title="相关注解配置"></a>相关注解配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line"></span>
<span class="line"><span class="meta">@EnableDiscoveryClient</span></span>
<span class="line"><span class="meta">@SpringBootApplication</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span>
<span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span>
<span class="line">		SpringApplication.run(Application.class, args);</span>
<span class="line">	&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="application-properties配置"><a href="#application-properties配置" class="headerlink" title="application.properties配置"></a>application.properties配置</h4><figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line">#默认就是true</span>
<span class="line">spring.cloud.consul.enabled=true</span>
<span class="line">spring.cloud.consul.host=127.0.0.1</span>
<span class="line">spring.cloud.consul.port=8500</span>
<span class="line">#默认就是true</span>
<span class="line">spring.cloud.consul.discovery.enabled=true</span>
<span class="line">#服务名</span>
<span class="line">spring.cloud.consul.discovery.serviceName=$&#123;spring.application.name&#125;</span>
<span class="line">#服务注册实例名</span>
<span class="line">spring.cloud.consul.discovery.instanceId=$&#123;spring.application.name&#125;-$&#123;spring.cloud.client.ipAddress&#125;-$&#123;server.port&#125;</span>
<span class="line">#服务所在的主机名</span>
<span class="line">spring.cloud.consul.discovery.hostname=$&#123;spring.cloud.client.ipAddress&#125;</span>
<span class="line">#服务所在的端口</span>
<span class="line">spring.cloud.consul.discovery.port=$&#123;server.port&#125;</span>
<span class="line">#服务的健康检查url</span>
<span class="line">spring.cloud.consul.discovery.healthCheckUrl=http://localhost:$&#123;server.port&#125;/</span>
<span class="line">spring.cloud.consul.discovery.healthCheckInterval=10s</span>
<span class="line">spring.cloud.consul.discovery.healthCheckTimeout=10s</span>
<span class="line">spring.cloud.consul.discovery.healthCheckPath=/</span>
<span class="line">spring.cloud.consul.discovery.tags=dev,dev1</span>
</pre></td></tr></table></figure>
<blockquote>
<p>healthCheckUrl 是consul检查应用健康状态的地址，可以选择一个自定义地址， 也可以使用<code>actuator</code>提供的<code>/health</code>地址。需要注意的是：如果你使用<code>actuator</code>提供的<code>/health</code>地址，则需要确保返回的json注解中的<code>status</code>字段为<code>UP</code>。也就是说<code>actuator</code>实施健康检查的所有组件的健康状态都必须是<code>UP</code>状态，有一个不是，则整个返回界都就是<code>DOWN</code>状态。</p>
</blockquote>
<h3 id="服务调用"><a href="#服务调用" class="headerlink" title="服务调用"></a>服务调用</h3><p>properties文件配置和服务注册端都是一致的。Spring的java Bean配置也基本相同。</p>
<h4 id="maven-配置-1"><a href="#maven-配置-1" class="headerlink" title="maven 配置"></a>maven 配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-ribbon<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.cloud<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">  <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-cloud-starter-hystrix<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h4 id="java-Bean-配置"><a href="#java-Bean-配置" class="headerlink" title="java Bean 配置"></a>java Bean 配置</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@EnableDiscoveryClient</span></span>
<span class="line"><span class="meta">@EnableCircuitBreaker</span></span>
<span class="line"><span class="meta">@SpringBootApplication</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Application</span> </span>&#123;</span>
<span class="line">    </span>
<span class="line">    <span class="comment">//启动负载均衡功能</span></span>
<span class="line">    <span class="meta">@Bean</span></span>
<span class="line">    <span class="meta">@LoadBalanced</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> RestTemplate();</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span>
<span class="line">        SpringApplication.run(Application.class, args);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>服务调用示例：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookService</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Resource</span></span>
<span class="line">    <span class="keyword">private</span> RestTemplate restTemplate;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@HystrixCommand</span>(fallbackMethod = <span class="string">"addServiceFallback"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">add</span><span class="params">()</span></span>&#123;</span>
<span class="line">        <span class="comment">//url格式为服务名 + 请求的URI</span></span>
<span class="line">        <span class="keyword">return</span> restTemplate.getForEntity(<span class="string">"http://bookservice/add?a=10&amp;b=20"</span>, String.class).getBody();</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">addServiceFallback</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> <span class="string">"error"</span>;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;使用springcloud构建微服务，除了可以使用eureka来实现服务注册和发现外，springcloud对consul也提供了良好的支持。本文就简单介绍下使用springcloud和consul实现服务注册和发现。&lt;/p&gt;
&lt;h3 id=&quot;consul安装&quot;&gt;&lt;a href=&quot;#consul安装&quot; class=&quot;headerlink&quot; title=&quot;consul安装&quot;&gt;&lt;/a&gt;consul安装&lt;/h3&gt;&lt;p&gt;consul的安装非常简单，只需要在官网&lt;a href=&quot;https://www.consul.io/downloads.html&quot;&gt;下载&lt;/a&gt;对应平台的安装文件即可。&lt;/p&gt;
&lt;p&gt;具体安装步骤参考&lt;a href=&quot;https://www.consul.io/intro/getting-started/install.html&quot;&gt;install&lt;/a&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
      <category term="springcloud" scheme="https://leokongwq.github.io/tags/springcloud/"/>
    
  </entry>
  
  <entry>
    <title>ActiveMQ 延迟消息</title>
    <link href="https://leokongwq.github.io/2018/06/27/activemq-deleyQueue.html"/>
    <id>https://leokongwq.github.io/2018/06/27/activemq-deleyQueue.html</id>
    <published>2018-06-27T15:08:31.000Z</published>
    <updated>2018-07-15T13:20:06.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>有非常多的业务场景需要用到延迟消息功能。例如：订单待支付提醒，订单超时取消等。但并不是所有的消息中间件都支持延迟消息的功能，为了实现延迟消息，各路大神也是创造了很多的方案。<br>我们的系统使用的是ActiveMQ，ActiveMQ从版本<code>5.4</code>开始提供了持久化的延迟消息功能。下文就ActiveMQ提供的延迟消息功能进行介绍。</p>
<h3 id="启用ActiveMQ定时消息功能"><a href="#启用ActiveMQ定时消息功能" class="headerlink" title="启用ActiveMQ定时消息功能"></a>启用ActiveMQ定时消息功能</h3><p>为了使用ActiveMQ的延迟消息功能，我们需要修改ActiveMQ的配置文件<code>activemq.xml</code>，<br>在broker节点上添加<code>schedulerSupport=&quot;true&quot;</code>，如下所示:</p>
<a id="more"></a>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">broker</span> <span class="attr">xmlns</span>=<span class="string">"http://activemq.apache.org/schema/core"</span> <span class="attr">schedulerSupport</span>=<span class="string">"true"</span> &gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">broker</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h3 id="创建延迟消息并发送"><a href="#创建延迟消息并发送" class="headerlink" title="创建延迟消息并发送"></a>创建延迟消息并发送</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line">jmsTemplate.send(orderCreatedTopic, session -&gt; &#123;</span>
<span class="line">	MapMessage orderCreatedMsg = session.createMapMessage();</span>
<span class="line">	orderCreatedMsg.setString(<span class="string">"orderCode"</span>, orderCode);</span>
<span class="line">	<span class="comment">//延迟10分钟进行投递</span></span>
<span class="line">	<span class="keyword">long</span> time = <span class="number">10</span> * <span class="number">60</span> * <span class="number">1000</span>;</span>
<span class="line">	orderCreatedMsg.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, time);</span>
<span class="line">	<span class="keyword">return</span> orderCreatedMsg;</span>
<span class="line">&#125;);</span>
</pre></td></tr></table></figure>
<h3 id="延时消息属性总结"><a href="#延时消息属性总结" class="headerlink" title="延时消息属性总结"></a>延时消息属性总结</h3><p>ActiveM提供了很多高级的延时消息配置属性，解释如下：</p>
<table>
<thead>
<tr>
<th>属性</th>
<th>类型</th>
<th>描述</th>
</tr>
</thead>
<tbody>
<tr>
<td>　AMQ_SCHEDULED_DELAY</td>
<td>long</td>
<td>broker在投递该消息前等待的毫秒数</td>
</tr>
<tr>
<td>　AMQ_SCHEDULED_PERIOD</td>
<td>long</td>
<td>每次重新投递该消息的时间间隔</td>
</tr>
<tr>
<td>　AMQ_SCHEDULED_REPEAT</td>
<td>int</td>
<td>重复投递该消息的次数</td>
</tr>
<tr>
<td>　AMQ_SCHEDULED_CRON　</td>
<td>String</td>
<td>使用一个cron表达式来表示消息投递的策略</td>
</tr>
</tbody>
</table>
<p>例子:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line">MessageProducer producer = session.createProducer(destination);</span>
<span class="line">TextMessage message = session.createTextMessage(<span class="string">"test msg"</span>);</span>
<span class="line">message.setStringProperty(ScheduledMessage.AMQ_SCHEDULED_CRON, <span class="string">"0 * * * *"</span>);</span>
<span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_DELAY, <span class="number">1000</span>);</span>
<span class="line">message.setLongProperty(ScheduledMessage.AMQ_SCHEDULED_PERIOD, <span class="number">1000</span>);</span>
<span class="line">message.setIntProperty(ScheduledMessage.AMQ_SCHEDULED_REPEAT, <span class="number">9</span>);</span>
<span class="line">producer.send(message);</span>
</pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://activemq.apache.org/delay-and-schedule-message-delivery.html" target="_blank" rel="external">http://activemq.apache.org/delay-and-schedule-message-delivery.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;有非常多的业务场景需要用到延迟消息功能。例如：订单待支付提醒，订单超时取消等。但并不是所有的消息中间件都支持延迟消息的功能，为了实现延迟消息，各路大神也是创造了很多的方案。&lt;br&gt;我们的系统使用的是ActiveMQ，ActiveMQ从版本&lt;code&gt;5.4&lt;/code&gt;开始提供了持久化的延迟消息功能。下文就ActiveMQ提供的延迟消息功能进行介绍。&lt;/p&gt;
&lt;h3 id=&quot;启用ActiveMQ定时消息功能&quot;&gt;&lt;a href=&quot;#启用ActiveMQ定时消息功能&quot; class=&quot;headerlink&quot; title=&quot;启用ActiveMQ定时消息功能&quot;&gt;&lt;/a&gt;启用ActiveMQ定时消息功能&lt;/h3&gt;&lt;p&gt;为了使用ActiveMQ的延迟消息功能，我们需要修改ActiveMQ的配置文件&lt;code&gt;activemq.xml&lt;/code&gt;，&lt;br&gt;在broker节点上添加&lt;code&gt;schedulerSupport=&amp;quot;true&amp;quot;&lt;/code&gt;，如下所示:&lt;/p&gt;
    
    </summary>
    
      <category term="消息中间件" scheme="https://leokongwq.github.io/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="MQ" scheme="https://leokongwq.github.io/tags/MQ/"/>
    
      <category term="ActiveMQ" scheme="https://leokongwq.github.io/tags/ActiveMQ/"/>
    
  </entry>
  
  <entry>
    <title>zookeeper使用之curator</title>
    <link href="https://leokongwq.github.io/2018/06/17/zookeeper-curator.html"/>
    <id>https://leokongwq.github.io/2018/06/17/zookeeper-curator.html</id>
    <published>2018-06-17T10:26:10.000Z</published>
    <updated>2018-06-24T13:48:19.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>Apache <a href="http://curator.apache.org/" target="_blank" rel="external">Curator</a>是Netflix开源的操作Zookeeper的，功能非常强大的客户端。提供了很多非常好用的功能来帮助我们构建分布式应用。</p>
<h2 id="分布式锁"><a href="#分布式锁" class="headerlink" title="分布式锁"></a>分布式锁</h2><p>Curator 提供的分布式锁分为以下三类：</p>
<ul>
<li>可重入公平锁 InterProcessMutex</li>
<li>不可重入的非公平锁 InterProcessSemaphoreMutex</li>
<li>可重入的读写锁 InterProcessReadWriteLock</li>
<li>锁集合 InterProcessMultiLock</li>
</ul>
<a id="more"></a>
<h3 id="InterProcessMutex"><a href="#InterProcessMutex" class="headerlink" title="InterProcessMutex"></a>InterProcessMutex</h3><p>Curator提供了<code>InterProcessMutex</code>来实现该功能。样例代码如下：</p>
<figure class="highlight java"><figcaption><span>InterProcessMutex</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">//创建锁</span></span>
<span class="line">InterProcessLock lock = <span class="keyword">new</span> InterProcessMutex(client, lockPath);</span>
<span class="line"><span class="comment">//获取</span></span>
<span class="line">lock.acquire(<span class="number">1</span>，TimeUnit.SECONDS)</span>
<span class="line"><span class="keyword">try</span> &#123;</span>
<span class="line"><span class="comment">//业务代码</span></span>
<span class="line">&#125; <span class="keyword">finally</span> &#123;</span>
<span class="line">    lock.release();</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>实现原理分析：</p>
<p><code>InterProcessMutex</code>通过创建一个 Zookeeper 临时，顺序结点来实现锁的公平获取，代码如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
</pre></td><td class="code"><pre><span class="line"> <span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">acquire</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   <span class="keyword">if</span> ( !internalLock(-<span class="number">1</span>, <span class="keyword">null</span>) ) &#123;</span>
<span class="line">       <span class="keyword">throw</span> <span class="keyword">new</span> IOException(<span class="string">"Lost connection while trying to acquire lock: "</span> + basePath);</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">internalLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   <span class="comment">/*</span>
<span class="line">      Note on concurrency: a given lockData instance</span>
<span class="line">      can be only acted on by a single thread so locking isn't necessary</span>
<span class="line">   */</span></span>
<span class="line">   </span>
<span class="line">   <span class="comment">//下面的代码实现：可重入性。</span></span>
<span class="line">   Thread currentThread = Thread.currentThread();</span>
<span class="line">   LockData lockData = threadData.get(currentThread);</span>
<span class="line">   <span class="keyword">if</span> ( lockData != <span class="keyword">null</span> )</span>
<span class="line">   &#123;</span>
<span class="line">       <span class="comment">// re-entering </span></span>
<span class="line">       lockData.lockCount.incrementAndGet();</span>
<span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="comment">//创建：临时，顺序结点 </span></span>
<span class="line">   String lockPath = internals.attemptLock(time, unit, getLockNodeBytes());</span>
<span class="line">   <span class="keyword">if</span> ( lockPath != <span class="keyword">null</span> )</span>
<span class="line">   &#123;</span>
<span class="line">       LockData newLockData = <span class="keyword">new</span> LockData(currentThread, lockPath);</span>
<span class="line">       threadData.put(currentThread, newLockData);</span>
<span class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   <span class="keyword">return</span> <span class="keyword">false</span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>创建：临时，顺序结点 </p>
<figure class="highlight java"><figcaption><span>LockInternals.attemptLock</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
</pre></td><td class="code"><pre><span class="line"><span class="function">String <span class="title">attemptLock</span><span class="params">(<span class="keyword">long</span> time, TimeUnit unit, <span class="keyword">byte</span>[] lockNodeBytes)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line"><span class="keyword">while</span> ( !isDone )</span>
<span class="line">   &#123;</span>
<span class="line">       isDone = <span class="keyword">true</span>;</span>
<span class="line"></span>
<span class="line">       <span class="keyword">try</span></span>
<span class="line">       &#123;   </span>
<span class="line">           <span class="comment">// 通过LockInternalsDriver创建Zookeeper结点</span></span>
<span class="line">           ourPath = driver.createsTheLock(client, path, localLockNodeBytes);</span>
<span class="line">           <span class="comment">// 判断是否获取了锁， 其实就是判定该线程创建的临时结点的顺序是否最小</span></span>
<span class="line">           hasTheLock = internalLockLoop(startMillis, millisToWait, ourPath);</span>
<span class="line">       &#125;</span>
<span class="line">       <span class="keyword">catch</span> ( KeeperException.NoNodeException e )</span>
<span class="line">       &#123;</span>
<span class="line">           <span class="comment">// gets thrown by StandardLockInternalsDriver when it can't find the lock node</span></span>
<span class="line">           <span class="comment">// this can happen when the session expires, etc. So, if the retry allows, just try it all again</span></span>
<span class="line">           <span class="keyword">if</span> ( client.getZookeeperClient().getRetryPolicy().allowRetry(retryCount++, System.currentTimeMillis() - startMillis, RetryLoop.getDefaultRetrySleeper()) )</span>
<span class="line">           &#123;</span>
<span class="line">               isDone = <span class="keyword">false</span>;</span>
<span class="line">           &#125;</span>
<span class="line">           <span class="keyword">else</span></span>
<span class="line">           &#123;</span>
<span class="line">               <span class="keyword">throw</span> e;</span>
<span class="line">           &#125;</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
</pre></td><td class="code"><pre><span class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">internalLockLoop</span><span class="params">(<span class="keyword">long</span> startMillis, Long millisToWait, String ourPath)</span> <span class="keyword">throws</span> Exception</span>
<span class="line"></span>&#123;</span>
<span class="line">   <span class="keyword">boolean</span>     haveTheLock = <span class="keyword">false</span>;</span>
<span class="line">   <span class="keyword">boolean</span>     doDelete = <span class="keyword">false</span>;</span>
<span class="line">   <span class="keyword">try</span></span>
<span class="line">   &#123;</span>
<span class="line">       <span class="keyword">if</span> ( revocable.get() != <span class="keyword">null</span> )</span>
<span class="line">       &#123;</span>
<span class="line">           client.getData().usingWatcher(revocableWatcher).forPath(ourPath);</span>
<span class="line">       &#125;</span>
<span class="line">       <span class="comment">// 循环来获取锁</span></span>
<span class="line">       <span class="keyword">while</span> ( (client.getState() == CuratorFrameworkState.STARTED) &amp;&amp; !haveTheLock )</span>
<span class="line">       &#123;</span>
<span class="line">           <span class="comment">//获取所有的排序后的子节点列表（升序排列） </span></span>
<span class="line">           List&lt;String&gt;        children = getSortedChildren();</span>
<span class="line">           String              sequenceNodeName = ourPath.substring(basePath.length() + <span class="number">1</span>); <span class="comment">// +1 to include the slash</span></span>
<span class="line">           <span class="comment">// 判断该进程或线程创建的子节点：sequenceNodeName 是否是第一个</span></span>
<span class="line">           PredicateResults    predicateResults = driver.getsTheLock(client, children, sequenceNodeName, maxLeases);</span>
<span class="line">           <span class="keyword">if</span> ( predicateResults.getsTheLock() )</span>
<span class="line">           &#123;</span>
<span class="line">               haveTheLock = <span class="keyword">true</span>;</span>
<span class="line">           &#125;</span>
<span class="line">           <span class="keyword">else</span></span>
<span class="line">           &#123;</span>
<span class="line">               String  previousSequencePath = basePath + <span class="string">"/"</span> + predicateResults.getPathToWatch();</span>
<span class="line">                <span class="comment">// JVM 进程能同步，</span></span>
<span class="line">               <span class="keyword">synchronized</span>(<span class="keyword">this</span>)</span>
<span class="line">               &#123;</span>
<span class="line">                   <span class="keyword">try</span> </span>
<span class="line">                   &#123;</span>
<span class="line">                       <span class="comment">// use getData() instead of exists() to avoid leaving unneeded watchers which is a type of resource leak</span></span>
<span class="line">                       client.getData().usingWatcher(watcher).forPath(previousSequencePath);</span>
<span class="line">                       <span class="keyword">if</span> ( millisToWait != <span class="keyword">null</span> )</span>
<span class="line">                       &#123;</span>
<span class="line">                           millisToWait -= (System.currentTimeMillis() - startMillis);</span>
<span class="line">                           startMillis = System.currentTimeMillis();</span>
<span class="line">                           <span class="keyword">if</span> ( millisToWait &lt;= <span class="number">0</span> )</span>
<span class="line">                           &#123;</span>
<span class="line">                               doDelete = <span class="keyword">true</span>;    <span class="comment">// timed out - delete our node</span></span>
<span class="line">                               <span class="keyword">break</span>;</span>
<span class="line">                           &#125;</span>
<span class="line">                            <span class="comment">// 线程超时等待</span></span>
<span class="line">                           wait(millisToWait);</span>
<span class="line">                       &#125;</span>
<span class="line">                       <span class="keyword">else</span></span>
<span class="line">                       &#123;</span>
<span class="line">                          <span class="comment">// 线程等待(需要其它线程唤醒，其它线程在释放锁时会进行唤醒)</span></span>
<span class="line">                           wait();</span>
<span class="line">                       &#125;</span>
<span class="line">                       </span>
<span class="line">                        <span class="comment">//  watcher 的执行在另一个线程中，会唤醒等待锁的线程</span></span>
<span class="line">                   &#125;</span>
<span class="line">                   <span class="keyword">catch</span> ( KeeperException.NoNodeException e ) </span>
<span class="line">                   &#123;</span>
<span class="line">                       <span class="comment">// it has been deleted (i.e. lock released). Try to acquire again</span></span>
<span class="line">                   &#125;</span>
<span class="line">               &#125;</span>
<span class="line">           &#125;</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="keyword">catch</span> ( Exception e )</span>
<span class="line">   &#123;   </span>
<span class="line">        <span class="comment">// 处理线程中断  </span></span>
<span class="line">       ThreadUtils.checkInterrupted(e);</span>
<span class="line">       doDelete = <span class="keyword">true</span>;</span>
<span class="line">       <span class="keyword">throw</span> e;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="keyword">finally</span></span>
<span class="line">   &#123;</span>
<span class="line">        <span class="comment">//被中断后，删除结点，释放锁（一点会删除成功，具体实现查询源代码）</span></span>
<span class="line">       <span class="keyword">if</span> ( doDelete )</span>
<span class="line">       &#123;</span>
<span class="line">           deleteOurPath(ourPath);</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="keyword">return</span> haveTheLock;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="InterProcessSemaphoreMutex"><a href="#InterProcessSemaphoreMutex" class="headerlink" title="InterProcessSemaphoreMutex"></a>InterProcessSemaphoreMutex</h3><p>该功能的锁是由：<code>InterProcessSemaphoreMutex</code>实现的，具体原理就不分析代码。</p>
<p>提一句：该锁的功能是通过：<code>InterProcessMutex</code>和<code>InterProcessSemaphoreV2</code>实现的。</p>
<p><code>InterProcessSemaphoreV2</code>：从名称上来说，该类是一个信号量，也就是说它可以提供N个可用的许可，可以用来管理同时访问共享资源的并发数。</p>
<blockquote>
<p>许可数量为:1的信号量可以当做锁来用。</p>
</blockquote>
<h3 id="InterProcessReadWriteLock"><a href="#InterProcessReadWriteLock" class="headerlink" title="InterProcessReadWriteLock"></a>InterProcessReadWriteLock</h3><p>读写锁和JDK提供的：<code>ReadWriteLock</code>功能是类似的</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testReadWriteLock</span><span class="params">()</span> </span>&#123;</span>
<span class="line">   String lockPath = <span class="string">"/config/lock/123"</span>;</span>
<span class="line">   InterProcessReadWriteLock readWriteLock = <span class="keyword">new</span> InterProcessReadWriteLock(client, lockPath);</span>
<span class="line"></span>
<span class="line">   InterProcessMutex readLock = readWriteLock.readLock();</span>
<span class="line">   InterProcessMutex writeLock = readWriteLock.writeLock();</span>
<span class="line"></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>特点总结：</p>
<ol>
<li>可重入，读锁和写锁都是可重入的。</li>
<li>读锁非互斥，写锁是互斥的，只能有一个客户端获取</li>
<li>读写是互斥的</li>
<li>支持锁降级。支持写锁降级为读锁，读锁不能升级为写锁。</li>
</ol>
<h3 id="InterProcessMultiLock"><a href="#InterProcessMultiLock" class="headerlink" title="InterProcessMultiLock"></a>InterProcessMultiLock</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line">InterProcessMultiLock lock = <span class="keyword">new</span> InterProcessMultiLock(List&lt;InterProcessLock&gt; locks);</span>
<span class="line"></span>
<span class="line">或</span>
<span class="line"></span>
<span class="line">InterProcessMultiLock lock = <span class="keyword">new</span> InterProcessMultiLock(CuratorFramework client,</span>
<span class="line">                             List&lt;String&gt; paths);</span>
</pre></td></tr></table></figure>
<p><code>InterProcessMultiLock</code>维护一组锁。在获取锁时，只有获取所有的锁时才返回，释放时会释放所有的锁。</p>
<h2 id="Leader选举"><a href="#Leader选举" class="headerlink" title="Leader选举"></a>Leader选举</h2><p>在分布式系统中，Leader选举是一个非常基础和重要的能力。通过Zookeeper和Curator能非常容易的实现Leader选举。</p>
<p>Curator提供了两种机制来实现Leader选举：</p>
<h3 id="方法一：LeaderSelector"><a href="#方法一：LeaderSelector" class="headerlink" title="方法一：LeaderSelector"></a>方法一：LeaderSelector</h3><p>直接上代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> String leaderSelectionPath = <span class="string">"/config/vip/db/master"</span>;</span>
<span class="line"></span>
<span class="line"><span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLeaderElection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">5</span>);</span>
<span class="line"></span>
<span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span>
<span class="line">       threadPool.execute(<span class="keyword">new</span> Contender(buildLeaderSelectorListener()));</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   Thread.sleep(<span class="number">1000</span> * <span class="number">1000</span>);</span>
<span class="line"></span>
<span class="line">   threadPool.shutdown();</span>
<span class="line">&#125;</span>
<span class="line"><span class="comment">/**</span>
<span class="line">* 公平的选举（顺序性）</span>
<span class="line">*/</span></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Contender</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span>
<span class="line">   <span class="keyword">private</span> LeaderSelectorListener listener;</span>
<span class="line"></span>
<span class="line">   Contender(LeaderSelectorListener listener) &#123;</span>
<span class="line">       <span class="keyword">this</span>.listener = listener;</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   <span class="meta">@Override</span></span>
<span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">       LeaderSelector selector = <span class="keyword">new</span> LeaderSelector(client, leaderSelectionPath, listener);</span>
<span class="line">       <span class="comment">// 自动加入Leader选举</span></span>
<span class="line">       selector.autoRequeue();</span>
<span class="line">       <span class="comment">//开始进行选举，不过该方法会立即返回。选举的结果是通过异步回调实现的</span></span>
<span class="line">       selector.start();</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
<span class="line"><span class="function"><span class="keyword">private</span> LeaderSelectorListener <span class="title">buildLeaderSelectorListener</span><span class="params">()</span> </span>&#123;</span>
<span class="line">   LeaderSelectorListener listener = <span class="keyword">new</span> LeaderSelectorListenerAdapter() &#123;</span>
<span class="line">        <span class="comment">//该方法只有在该客户端被选为Leader才会被调用。</span></span>
<span class="line">        <span class="comment">//方法返回就表示客户端放弃Leader角色。</span></span>
<span class="line">       <span class="meta">@Override</span></span>
<span class="line">       <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">takeLeadership</span><span class="params">(CuratorFramework client)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">          <span class="comment">// 模式业务操作</span></span>
<span class="line">            System.out.println(<span class="string">"Current Leader is : "</span> + Thread.currentThread().getName());</span>
<span class="line">           Thread.sleep(<span class="number">5000</span>)</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;;</span>
<span class="line">   <span class="keyword">return</span> listener;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="方法二：LeaderLatch"><a href="#方法二：LeaderLatch" class="headerlink" title="方法二：LeaderLatch"></a>方法二：LeaderLatch</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
</pre></td><td class="code"><pre><span class="line"> <span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testLeaderRandomElection</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   ExecutorService threadPool = Executors.newFixedThreadPool(<span class="number">5</span>);</span>
<span class="line"></span>
<span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span>
<span class="line">       LeaderLatch leaderLatch = <span class="keyword">new</span> LeaderLatch(client, leaderSelectionPath, String.valueOf(i));</span>
<span class="line">       threadPool.execute(<span class="keyword">new</span> RandomSelectLeader(leaderLatch));</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   Thread.sleep(<span class="number">1000</span> * <span class="number">1000</span>);</span>
<span class="line"></span>
<span class="line">   threadPool.shutdown();</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">RandomSelectLeader</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">   <span class="keyword">private</span> LeaderLatch leaderLatch;</span>
<span class="line"></span>
<span class="line">   RandomSelectLeader(LeaderLatch leaderLatch) &#123;</span>
<span class="line">       <span class="keyword">this</span>.leaderLatch = leaderLatch;</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   <span class="meta">@Override</span></span>
<span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">       <span class="keyword">try</span> &#123;</span>
<span class="line">           <span class="comment">//强烈建议添加Listener来监听链接变化，　处理Leader丢失问题</span></span>
<span class="line">           leaderLatch.addListener(<span class="keyword">new</span> LeaderLatchListener() &#123;</span>
<span class="line">               <span class="meta">@Override</span></span>
<span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">isLeader</span><span class="params">()</span> </span>&#123;</span>
<span class="line">                   System.out.println(<span class="string">"I'am Selected to be a Leader"</span> + Thread.currentThread().getName());</span>
<span class="line">               &#125;</span>
<span class="line"></span>
<span class="line">               <span class="meta">@Override</span></span>
<span class="line">               <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">notLeader</span><span class="params">()</span> </span>&#123;</span>
<span class="line">                   System.out.println(<span class="string">"I'am Not Leader"</span> + Thread.currentThread().getName());</span>
<span class="line">               &#125;</span>
<span class="line">           &#125;);</span>
<span class="line">           <span class="comment">//调用该方法后才能开始参与选举（随机的）</span></span>
<span class="line">           leaderLatch.start();</span>
<span class="line">           <span class="comment">//死等，　直到被选为Leader</span></span>
<span class="line">           leaderLatch.await();</span>
<span class="line"></span>
<span class="line">           System.out.println(<span class="string">"Current Leader is : "</span> + Thread.currentThread().getName());</span>
<span class="line"></span>
<span class="line">           Thread.sleep(<span class="number">2000</span>);</span>
<span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">           e.printStackTrace();</span>
<span class="line">       &#125; <span class="keyword">finally</span> &#123;</span>
<span class="line">           <span class="keyword">try</span> &#123;</span>
<span class="line">               <span class="comment">// 退出选举，如果自己是Leader，则放弃Leader位置，其它的成员就可以再次选举</span></span>
<span class="line">               leaderLatch.close();</span>
<span class="line">           &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">               e.printStackTrace();</span>
<span class="line">           &#125;</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="小结"><a href="#小结" class="headerlink" title="小结"></a>小结</h4><p>推荐使用<code>LeaderSelector</code>来实现Leader选举，因为参加选举的结点代码编写简单，能自动完成丢失Leader角色后从新参加选举的功能，而且能灵活的控制释放Leader角色的时机。</p>
<h2 id="分布式栅栏"><a href="#分布式栅栏" class="headerlink" title="分布式栅栏"></a>分布式栅栏</h2><h3 id="DistributedBarrier"><a href="#DistributedBarrier" class="headerlink" title="DistributedBarrier"></a>DistributedBarrier</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDistributedBarrier</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   String barrierPath = <span class="string">"/config/barriers"</span>;</span>
<span class="line">   DistributedBarrier barrier = <span class="keyword">new</span> DistributedBarrier(client, barrierPath);</span>
<span class="line"></span>
<span class="line">   ExecutorService executorService = Executors.newCachedThreadPool();</span>
<span class="line"></span>
<span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">5</span>; i++) &#123;</span>
<span class="line">       executorService.execute(<span class="keyword">new</span> Worker(barrier));</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);</span>
<span class="line"></span>
<span class="line">   <span class="comment">//主线程设置结点，worker线程等待</span></span>
<span class="line">   barrier.setBarrier();</span>
<span class="line"></span>
<span class="line">   Thread.sleep(<span class="number">1000</span> * <span class="number">10</span>);</span>
<span class="line">   System.out.println(<span class="string">"ALL Done!"</span>);</span>
<span class="line"></span>
<span class="line">   barrier.removeBarrier();</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">   <span class="keyword">private</span> DistributedBarrier barrier;</span>
<span class="line"></span>
<span class="line">   Worker(DistributedBarrier barrier) &#123;</span>
<span class="line">       <span class="keyword">this</span>.barrier = barrier;</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   <span class="meta">@Override</span></span>
<span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">       <span class="keyword">try</span> &#123;</span>
<span class="line">           barrier.waitOnBarrier();</span>
<span class="line">           System.out.println(Thread.currentThread().getName() + <span class="string">" &gt;&gt;&gt;&gt; Finished"</span>);</span>
<span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">           e.printStackTrace();</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="DistributedDoubleBarrier"><a href="#DistributedDoubleBarrier" class="headerlink" title="DistributedDoubleBarrier"></a>DistributedDoubleBarrier</h3><p>双栅栏允许客户端在计算的开始和结束时同步。当足够的进程加入到双栅栏时，进程开始计算， 当计算完成时，离开栅栏。</p>
<p>构造函数为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DistributedDoubleBarrier</span><span class="params">(CuratorFramework client,</span>
<span class="line">                                String barrierPath,</span>
<span class="line">                                <span class="keyword">int</span> memberQty)</span></span>
<span class="line">Creates the barrier abstraction. memberQty is the number of members in the barrier. When <span class="title">enter</span><span class="params">()</span> is called, it blocks until</span>
<span class="line">all members have entered. When <span class="title">leave</span><span class="params">()</span> is called, it blocks until all members have left.</span>
<span class="line">Parameters:</span>
<span class="line">client - the client</span>
<span class="line">barrierPath - path to use</span>
<span class="line">memberQty - the number of members in the barrier</span></span>
</pre></td></tr></table></figure>
<p><code>memberQty</code>是成员数量，当<code>enter</code>方法被调用时，成员被阻塞，直到所有的成员都调用了<code>enter</code>。 当<code>leave</code>方法被调用时，它也阻塞调用线程， 直到所有的成员都调用了<code>leave</code>。</p>
<p><code>DistributedDoubleBarrier</code>会监控连接状态，当连接断掉时<code>enter</code>和<code>leave</code>方法会抛出异常。</p>
<p>下面是一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="keyword">int</span> QTY = <span class="number">5</span>;</span>
<span class="line"></span>
<span class="line"><span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDistributedDoubleBarrier</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">   String barrierPath = <span class="string">"/config/barriers"</span>;</span>
<span class="line"></span>
<span class="line">   ExecutorService executorService = Executors.newFixedThreadPool(QTY);</span>
<span class="line">   <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; QTY; i++) &#123;</span>
<span class="line">       <span class="keyword">final</span> DistributedDoubleBarrier barrier = <span class="keyword">new</span> DistributedDoubleBarrier(client, barrierPath, QTY);</span>
<span class="line">       executorService.execute(<span class="keyword">new</span> Worker(barrier));</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);</span>
<span class="line">   System.out.println(<span class="string">"ALL Done!"</span>);</span>
<span class="line"></span>
<span class="line">   executorService.shutdown();</span>
<span class="line">   executorService.awaitTermination(<span class="number">10</span>, TimeUnit.MINUTES);</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">Worker</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">   DistributedDoubleBarrier doubleBarrier;</span>
<span class="line"></span>
<span class="line">   Worker(DistributedDoubleBarrier doubleBarrier) &#123;</span>
<span class="line">       <span class="keyword">this</span>.doubleBarrier = doubleBarrier;</span>
<span class="line">   &#125;</span>
<span class="line"></span>
<span class="line">   <span class="meta">@Override</span></span>
<span class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">       <span class="keyword">try</span> &#123;</span>
<span class="line">           <span class="comment">//等待所有客户端都到达</span></span>
<span class="line">           doubleBarrier.enter();</span>
<span class="line">           System.out.println(<span class="string">"I'am arrival"</span>);</span>
<span class="line">           System.out.println(Thread.currentThread().getName() + <span class="string">" &gt;&gt;&gt;&gt; Finished"</span>);</span>
<span class="line">           <span class="comment">//等待所有客户端都到达</span></span>
<span class="line">           doubleBarrier.leave();</span>
<span class="line">           System.out.println(<span class="string">"I'am leave"</span>);</span>
<span class="line">       &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">           e.printStackTrace();</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="分布式计数器"><a href="#分布式计数器" class="headerlink" title="分布式计数器"></a>分布式计数器</h2><h3 id="SharedCount"><a href="#SharedCount" class="headerlink" title="SharedCount"></a>SharedCount</h3><p><code>SharedCount</code> 管理一个共享的整型数字。所有监听该同一个Zookeeper Path的客户端都能获取到该整型数字的最新值。</p>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SharedCountTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNTER_PATH = <span class="string">"/config/conunter/total"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSharedCount</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        SharedCount sharedCount = <span class="keyword">new</span> SharedCount(client, COUNTER_PATH, <span class="number">0</span>);</span>
<span class="line">        sharedCount.start();</span>
<span class="line"></span>
<span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">3</span>);</span>
<span class="line"></span>
<span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">3</span>; i++) &#123;</span>
<span class="line">            <span class="keyword">final</span> SharedCount count = <span class="keyword">new</span> SharedCount(client, COUNTER_PATH, <span class="number">0</span>);</span>
<span class="line">            count.start();</span>
<span class="line">            executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span>
<span class="line">                <span class="meta">@Override</span></span>
<span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">                    count.addListener(<span class="keyword">new</span> SharedCountListener() &#123;</span>
<span class="line">                        <span class="meta">@Override</span></span>
<span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">countHasChanged</span><span class="params">(SharedCountReader sharedCount, <span class="keyword">int</span> newCount)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">"===="</span> + newCount);</span>
<span class="line">                        &#125;</span>
<span class="line"></span>
<span class="line">                        <span class="meta">@Override</span></span>
<span class="line">                        <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">stateChanged</span><span class="params">(CuratorFramework client, ConnectionState newState)</span> </span>&#123;</span>
<span class="line">                            System.out.println(newState);</span>
<span class="line">                        &#125;</span>
<span class="line">                    &#125;);</span>
<span class="line"></span>
<span class="line">                    <span class="keyword">try</span> &#123;</span>
<span class="line">                        Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);</span>
<span class="line">                    &#125; <span class="keyword">catch</span> (InterruptedException e) &#123;</span>
<span class="line">                        e.printStackTrace();</span>
<span class="line">                    &#125;</span>
<span class="line">                &#125;</span>
<span class="line">            &#125;);</span>
<span class="line">        &#125;</span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">3</span>);</span>
<span class="line">        sharedCount.setCount(<span class="number">123</span>);</span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">3</span>);</span>
<span class="line">        sharedCount.setCount(<span class="number">456</span>);</span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">20</span>);</span>
<span class="line">        sharedCount.close();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<blockquote>
<p>注意： 如果连续两次调用<code>setCount</code>方法，在客户端只能观察到最后一次的结果。<code>trySetCount</code> 只有当该客户端的缓存的值和服务端保存的值一致才能设置成功，否则该客户端的值会自动更新（<code>trySetCount</code>返回false）。</p>
</blockquote>
<h3 id="DistributedAtomicLong"><a href="#DistributedAtomicLong" class="headerlink" title="DistributedAtomicLong"></a>DistributedAtomicLong</h3><p><code>DistributedAtomicLong</code> 是一个原子更新的计数器。它在更新值时，第一次尝试采用乐观锁机制，如果更新失败，则使用<code>InterProcessMutex</code>来实现更新。 不管采用哪种机制，它都会采用重试机制，直到更新成功。</p>
<p>一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TestDistributedAtomicLong</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String COUNTER_PATH = <span class="string">"/config/conunter/123"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testDistributedAtomicLong</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        RetryPolicy retryPolicy = <span class="keyword">new</span> RetryForever(<span class="number">10</span>);</span>
<span class="line">        DistributedAtomicLong atomicLong = <span class="keyword">new</span> DistributedAtomicLong(client, COUNTER_PATH, retryPolicy);</span>
<span class="line"></span>
<span class="line">        ExecutorService executorService = Executors.newFixedThreadPool(<span class="number">10</span>);</span>
<span class="line">        <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span>
<span class="line">            <span class="keyword">final</span> RetryPolicy retryPolicyTmp = <span class="keyword">new</span> RetryForever(<span class="number">10</span>);</span>
<span class="line">            <span class="keyword">final</span> DistributedAtomicLong distCounter = <span class="keyword">new</span> DistributedAtomicLong(client, COUNTER_PATH, retryPolicyTmp);</span>
<span class="line"></span>
<span class="line">            executorService.execute(<span class="keyword">new</span> Runnable() &#123;</span>
<span class="line">                <span class="meta">@Override</span></span>
<span class="line">                <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">                    System.out.println(distCounter);</span>
<span class="line"></span>
<span class="line">                    AtomicValue&lt;Long&gt; result = <span class="keyword">null</span>;</span>
<span class="line">                    <span class="keyword">try</span> &#123;</span>
<span class="line">                        result = distCounter.increment();</span>
<span class="line">                        <span class="keyword">if</span> (result.succeeded()) &#123;</span>
<span class="line">                            System.out.println(Thread.currentThread().getName() + <span class="string">"===&gt; current value = "</span> + result.preValue());</span>
<span class="line">                        &#125;</span>
<span class="line">                    &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">                        e.printStackTrace();</span>
<span class="line">                    &#125;</span>
<span class="line">                &#125;</span>
<span class="line">            &#125;);</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">5</span>);</span>
<span class="line"></span>
<span class="line">        System.out.println(<span class="string">"After all current value is = "</span> + atomicLong.get().postValue());</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<blockquote>
<p>注意：在使用<code>DistributedAtomicLong</code>时，你必须首先检查<code>AtomicValue.succeeded()</code>的返回值。如果操作成功则该方法的返回<code>true</code>，否则返回<code>false</code>，表示原子更新失败。如果更新成功，则可以通过<code>preValue</code>和<code>postValue</code>获取更新前后的值。</p>
</blockquote>
<h2 id="缓存"><a href="#缓存" class="headerlink" title="缓存"></a>缓存</h2><h3 id="PathChildrenCache"><a href="#PathChildrenCache" class="headerlink" title="PathChildrenCache"></a>PathChildrenCache</h3><p><code>PathChildrenCache</code> 用来观察一个<code>ZNode</code>。无论该结点下新增子节点，删除子节点还是子节点更新，路径缓存都会更新它的状态来包含当前的结点集合（包括状态和数据）。</p>
<p>一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PathChildrenCacheTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CACHE_PATH = <span class="string">"/config/cache"</span>;</span>
<span class="line">    </span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPathChildrenCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        PathChildrenCache pathChildrenCache = <span class="keyword">new</span> PathChildrenCache(client, CACHE_PATH, <span class="keyword">true</span>);</span>
<span class="line">        pathChildrenCache.start(PathChildrenCache.StartMode.BUILD_INITIAL_CACHE);</span>
<span class="line"></span>
<span class="line">        pathChildrenCache.getListenable().addListener(<span class="keyword">new</span> PathChildrenCacheListener() &#123;</span>
<span class="line">            <span class="meta">@Override</span></span>
<span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, PathChildrenCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">                System.out.println(event);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;);</span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">50</span>);</span>
<span class="line"></span>
<span class="line">        List&lt;ChildData&gt; childDataList = pathChildrenCache.getCurrentData();</span>
<span class="line">        <span class="keyword">for</span> (ChildData childData : childDataList) &#123;</span>
<span class="line">            System.out.println(childData);</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        pathChildrenCache.close();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="NodeCache"><a href="#NodeCache" class="headerlink" title="NodeCache"></a>NodeCache</h3><p><code>NodeCache</code>用来观察一个<code>ZNode</code>。当该结点的数据被更新，或被删除，<code>NodeCache</code>会同步到结点当前最新的数据，如果结点被删除，则<code>NodeCache</code>包含的数据为null。</p>
<p>一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">NodeCacheTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CACHE_NODE_PATH = <span class="string">"/config/cache/123"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testNodeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        <span class="keyword">final</span> NodeCache nodeCache = <span class="keyword">new</span> NodeCache(client, CACHE_NODE_PATH);</span>
<span class="line">        nodeCache.start(<span class="keyword">true</span>);</span>
<span class="line">        nodeCache.getListenable().addListener(<span class="keyword">new</span> NodeCacheListener() &#123;</span>
<span class="line">            <span class="meta">@Override</span></span>
<span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">nodeChanged</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">                System.out.println(<span class="keyword">new</span> String(nodeCache.getCurrentData().getData()));</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;);</span>
<span class="line"></span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">50</span>);</span>
<span class="line">        nodeCache.close();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="TreeCache"><a href="#TreeCache" class="headerlink" title="TreeCache"></a>TreeCache</h3><p><code>TreeCache</code>是一个工具类，它试图将服务端某个<code>Path</code>下所有所有的结点数据缓存到本地。该类会监听指定的ZK路径，处理<code>update</code>,<code>create</code>,<code>delete</code>事件并拉取服务端的数据。你可以通过注册一个Listener来获取数据的变化通知。</p>
<p>一个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">TreeCacheTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String CACHE_PATH = <span class="string">"/config/cache"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testTreeCache</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        TreeCache treeCache = <span class="keyword">new</span> TreeCache(client, CACHE_PATH);</span>
<span class="line">        treeCache.getListenable().addListener(<span class="keyword">new</span> TreeCacheListener() &#123;</span>
<span class="line">            <span class="meta">@Override</span></span>
<span class="line">            <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">childEvent</span><span class="params">(CuratorFramework client, TreeCacheEvent event)</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">                System.out.println(event);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;);</span>
<span class="line">        treeCache.start();</span>
<span class="line"></span>
<span class="line">        Thread.sleep(<span class="number">1000</span> * <span class="number">50</span>);</span>
<span class="line"></span>
<span class="line">        Map&lt;String, ChildData&gt; dataMap = treeCache.getCurrentChildren(CACHE_PATH);</span>
<span class="line">        <span class="keyword">for</span> (Map.Entry&lt;String, ChildData&gt; entry : dataMap.entrySet()) &#123;</span>
<span class="line">            System.out.println(entry.getKey() + <span class="string">" =====》"</span> +  <span class="keyword">new</span> String(entry.getValue().getData()));</span>
<span class="line">        &#125;</span>
<span class="line">        treeCache.close();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="Nodes"><a href="#Nodes" class="headerlink" title="Nodes"></a>Nodes</h2><h3 id="Persistent-Node"><a href="#Persistent-Node" class="headerlink" title="Persistent Node"></a>Persistent Node</h3><p>持久化结点是数据保存在Zookeeper服务端，并且在连接断开，session过期任然存在的结点。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersistentNodeTest</span> <span class="keyword">extends</span> <span class="title">BaseTest</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String NODE_PATH = <span class="string">"/persons/sky"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Test</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testPersistentNode</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">        PersistentNode persistentNode = <span class="keyword">new</span> PersistentNode(</span>
<span class="line">            client,</span>
<span class="line">            CreateMode.PERSISTENT,</span>
<span class="line">            <span class="keyword">true</span>,</span>
<span class="line">            NODE_PATH,</span>
<span class="line">            <span class="string">"123"</span>.getBytes()</span>
<span class="line">        );</span>
<span class="line">        <span class="comment">//必须先调用该方法(该方法会创建结点)</span></span>
<span class="line">        persistentNode.start();</span>
<span class="line"></span>
<span class="line">        System.out.println(persistentNode.getActualPath());</span>
<span class="line">        System.out.println(<span class="keyword">new</span> String(persistentNode.getData()));</span>
<span class="line">        <span class="comment">//会删除该结点</span></span>
<span class="line"><span class="comment">//        persistentNode.close();</span></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="Persistent-TTL-Node"><a href="#Persistent-TTL-Node" class="headerlink" title="Persistent TTL Node"></a>Persistent TTL Node</h3><p><code>`在你需要创建</code>TTL<code>节点，但不想通过定期设置数据手动保持它的活动状态时非常有用。</code>PersistentTtlNode<code>可以为你完成此操作。 此外，保持活动的方式不会在父节点上生成监视触发器。 它还提供了类似</code>PersistentNode`的保证，即使通过连接和会话中断，节点也会尝试保持在ZooKeeper中。</p>
<h3 id="Group-Member"><a href="#Group-Member" class="headerlink" title="Group Member"></a>Group Member</h3><h2 id="分布式队列"><a href="#分布式队列" class="headerlink" title="分布式队列"></a>分布式队列</h2><p>、、、、</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;Apache &lt;a href=&quot;http://curator.apache.org/&quot;&gt;Curator&lt;/a&gt;是Netflix开源的操作Zookeeper的，功能非常强大的客户端。提供了很多非常好用的功能来帮助我们构建分布式应用。&lt;/p&gt;
&lt;h2 id=&quot;分布式锁&quot;&gt;&lt;a href=&quot;#分布式锁&quot; class=&quot;headerlink&quot; title=&quot;分布式锁&quot;&gt;&lt;/a&gt;分布式锁&lt;/h2&gt;&lt;p&gt;Curator 提供的分布式锁分为以下三类：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;可重入公平锁 InterProcessMutex&lt;/li&gt;
&lt;li&gt;不可重入的非公平锁 InterProcessSemaphoreMutex&lt;/li&gt;
&lt;li&gt;可重入的读写锁 InterProcessReadWriteLock&lt;/li&gt;
&lt;li&gt;锁集合 InterProcessMultiLock&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="架构" scheme="https://leokongwq.github.io/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="zookeeper" scheme="https://leokongwq.github.io/tags/zookeeper/"/>
    
      <category term="curator" scheme="https://leokongwq.github.io/tags/curator/"/>
    
  </entry>
  
  <entry>
    <title>分布式系统一致性总结</title>
    <link href="https://leokongwq.github.io/2018/06/01/distributed-system-consitency.html"/>
    <id>https://leokongwq.github.io/2018/06/01/distributed-system-consitency.html</id>
    <published>2018-06-01T06:16:32.000Z</published>
    <updated>2018-06-01T06:19:46.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在学习过程中，阅读了好多关于分布式系统一致性的文章和资料，总是被分布式事务一致性和分布式数据一致性</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;在学习过程中，阅读了好多关于分布式系统一致性的文章和资料，总是被分布式事务一致性和分布式数据一致性&lt;/p&gt;

    
    </summary>
    
      <category term="架构" scheme="https://leokongwq.github.io/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
  </entry>
  
  <entry>
    <title>spring中RestTemplate简介</title>
    <link href="https://leokongwq.github.io/2018/05/30/spring-RestTemplate.html"/>
    <id>https://leokongwq.github.io/2018/05/30/spring-RestTemplate.html</id>
    <published>2018-05-30T08:44:51.000Z</published>
    <updated>2018-05-30T09:29:42.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="RestTemplate-是什么？"><a href="#RestTemplate-是什么？" class="headerlink" title="RestTemplate 是什么？"></a>RestTemplate 是什么？</h3><p>RestTemplate是Spring提供的一个访问Http服务的客户端类，非常类似JdbcTemplate, JmsTemplate。它是线程安全的（一旦创建完成）。从名称上来看，该类更多是针对RESTFUL风格API设计的。当然如果你想通过它调用普通的Http接口也是可以的。</p>
<h3 id="RestTemplate-的方法"><a href="#RestTemplate-的方法" class="headerlink" title="RestTemplate 的方法"></a>RestTemplate 的方法</h3><p>RestTemplate提供的方法都是以Http协议中的6个动词开头的：</p>
<img src="/2018/05/30/spring-RestTemplate/spring-template.png" alt="spring-template.png" title="">
<p>这些方法的名称清楚地表明它们调用的是哪个HTTP方法，而名称的第二部分表示返回的内容。 例如，<code>getForObject（）</code>将执行GET，将HTTP响应转换为你选择的对象类型，并返回该对象。<code>postForLocation</code>将执行POST，将给定对象转换为HTTP请求，并返回可以找到新创建对象的响应<code>HTTP Location</code>标头。 如你所见，这些方法试图强制执行REST最佳实践。</p>
<a id="more"></a>
<h3 id="URI-模板"><a href="#URI-模板" class="headerlink" title="URI 模板"></a>URI 模板</h3><p>这些方法中的每一个都将URI作为第一个参数。 该URI可以是URI模板，可以使用变量将模板扩展为正常的URI。 模板变量可以以两种形式传递：<code>作为String可变参数数组</code>，或作为<code>Map &lt;String，String&gt;</code>。 字符串可变数组按顺序展开复制给模板变量，例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">String result = restTemplate.getForObject(<span class="string">"http://example.com/hotels/&#123;hotel&#125;/bookings/&#123;booking&#125;"</span>, String.class, <span class="string">"42"</span>, <span class="string">"21"</span>);</span>
</pre></td></tr></table></figure>
<p>上面的代码最终会请求：<a href="http://example.com/hotels/42/bookings/21" target="_blank" rel="external">http://example.com/hotels/42/bookings/21</a>。Map类型的模板数据，则会以模板变量的名称为key, 查询对应的值来做替换。例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line">Map&lt;String, String&gt; vars = <span class="keyword">new</span> HashMap&lt;String, String&gt;();</span>
<span class="line">vars.put(<span class="string">"hotel"</span>, <span class="string">"42"</span>);</span>
<span class="line">vars.put(<span class="string">"booking"</span>, <span class="string">"21"</span>);</span>
<span class="line">String result = restTemplate.getForObject(<span class="string">"http://example.com/hotels/&#123;hotel&#125;/bookings/&#123;booking&#125;"</span>, String.class, vars);</span>
</pre></td></tr></table></figure>
<p>最终同样会发送请求：<a href="http://example.com/hotels/42/rooms/42" target="_blank" rel="external">http://example.com/hotels/42/rooms/42</a>。</p>
<h3 id="HttpMessageConverters"><a href="#HttpMessageConverters" class="headerlink" title="HttpMessageConverters"></a>HttpMessageConverters</h3><p>传递给方法<code>getForObject()</code>,<code>postForLocation()</code>,<code>put()</code>的数据对象，或是这些方法的返回数据对象都是通过<code>HttpMessageConverter</code>进行转换的。在发送请求时，将数据对象转为Http请求数据， 接收响应时，将Http响应数据转为对应的数据对象。具体参考下面的例子</p>
<h4 id="搜索图片"><a href="#搜索图片" class="headerlink" title="搜索图片"></a>搜索图片</h4><p>Flickr公开了各种API来操纵庞大的照片库。<code>flickr.photos.search</code>方法允许你通过使用<code>GET</code>方法请求地址：<a href="http://www.flickr.com/services/rest?method=flickr.photos.search&amp;api+key=xxx&amp;tags=penguins" target="_blank" rel="external">http://www.flickr.com/services/rest?method=flickr.photos.search&amp;api+key=xxx&amp;tags=penguins</a>来搜索照片，结果会以xml的形式展示:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">photos</span> <span class="attr">page</span>=<span class="string">"2"</span> <span class="attr">pages</span>=<span class="string">"89"</span> <span class="attr">perpage</span>=<span class="string">"10"</span> <span class="attr">total</span>=<span class="string">"881"</span>&gt;</span></span>
<span class="line">	<span class="tag">&lt;<span class="name">photo</span> <span class="attr">id</span>=<span class="string">"2636"</span> <span class="attr">owner</span>=<span class="string">"47058503995@N01"</span> </span>
<span class="line">		<span class="attr">secret</span>=<span class="string">"a123456"</span> <span class="attr">server</span>=<span class="string">"2"</span> <span class="attr">title</span>=<span class="string">"test_04"</span></span>
<span class="line">		<span class="attr">ispublic</span>=<span class="string">"1"</span> <span class="attr">isfriend</span>=<span class="string">"0"</span> <span class="attr">isfamily</span>=<span class="string">"0"</span> /&gt;</span></span>
<span class="line">	<span class="tag">&lt;<span class="name">photo</span> <span class="attr">id</span>=<span class="string">"2635"</span> <span class="attr">owner</span>=<span class="string">"47058503995@N01"</span></span>
<span class="line">		<span class="attr">secret</span>=<span class="string">"b123456"</span> <span class="attr">server</span>=<span class="string">"2"</span> <span class="attr">title</span>=<span class="string">"test_03"</span></span>
<span class="line">		<span class="attr">ispublic</span>=<span class="string">"0"</span> <span class="attr">isfriend</span>=<span class="string">"1"</span> <span class="attr">isfamily</span>=<span class="string">"1"</span> /&gt;</span></span>
<span class="line">	<span class="tag">&lt;<span class="name">photo</span> <span class="attr">id</span>=<span class="string">"2633"</span> <span class="attr">owner</span>=<span class="string">"47058503995@N01"</span></span>
<span class="line">		<span class="attr">secret</span>=<span class="string">"c123456"</span> <span class="attr">server</span>=<span class="string">"2"</span> <span class="attr">title</span>=<span class="string">"test_01"</span></span>
<span class="line">		<span class="attr">ispublic</span>=<span class="string">"1"</span> <span class="attr">isfriend</span>=<span class="string">"0"</span> <span class="attr">isfamily</span>=<span class="string">"0"</span> /&gt;</span></span>
<span class="line">	<span class="tag">&lt;<span class="name">photo</span> <span class="attr">id</span>=<span class="string">"2610"</span> <span class="attr">owner</span>=<span class="string">"12037949754@N01"</span></span>
<span class="line">		<span class="attr">secret</span>=<span class="string">"d123456"</span> <span class="attr">server</span>=<span class="string">"2"</span> <span class="attr">title</span>=<span class="string">"00_tall"</span></span>
<span class="line">		<span class="attr">ispublic</span>=<span class="string">"1"</span> <span class="attr">isfriend</span>=<span class="string">"0"</span> <span class="attr">isfamily</span>=<span class="string">"0"</span> /&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">photos</span>&gt;</span></span>
</pre></td></tr></table></figure>
<p>Java代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> String photoSearchUrl =</span>
<span class="line">   <span class="string">"http://www.flickr.com/services/rest?method=flickr.photos.search&amp;api+key=&#123;api-key&#125;&amp;tags=&#123;tag&#125;&amp;per_page=10"</span>;</span>
<span class="line">Source photos = restTemplate.getForObject(photoSearchUrl, Source.class, apiKey, searchTerm);</span>
</pre></td></tr></table></figure>
<h3 id="代码实例"><a href="#代码实例" class="headerlink" title="代码实例"></a>代码实例</h3><h4 id="getXXX"><a href="#getXXX" class="headerlink" title="getXXX"></a>getXXX</h4><p>GET请求的方法如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line">public &lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Object... urlVariables) throws RestClientException </span>
<span class="line"></span>
<span class="line">public &lt;T&gt; T getForObject(String url, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; urlVariables) throws RestClientException</span>
<span class="line"></span>
<span class="line">public &lt;T&gt; T getForObject(URI url, Class&lt;T&gt; responseType) throws RestClientException</span>
</pre></td></tr></table></figure>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@RequestMapping</span>(<span class="string">"/hello"</span>)</span>
<span class="line"><span class="function"><span class="keyword">public</span> String <span class="title">helloGet</span><span class="params">()</span> </span>&#123;</span>
<span class="line">    ResponseEntity&lt;String&gt; responseEntity = restTemplate.getForEntity(<span class="string">"http://abc.com"</span>, String.class);</span>
<span class="line">    String body = responseEntity.getBody();</span>
<span class="line">    HttpStatus statusCode = responseEntity.getStatusCode();</span>
<span class="line">    <span class="keyword">int</span> statusCodeValue = responseEntity.getStatusCodeValue();</span>
<span class="line">    HttpHeaders headers = responseEntity.getHeaders();</span>
<span class="line">    <span class="keyword">return</span> body;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="postXXX"><a href="#postXXX" class="headerlink" title="postXXX"></a>postXXX</h3><p>POST 请求的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> &lt;T&gt; <span class="function">T <span class="title">postForObject</span><span class="params">(String url, Object request, Class&lt;T&gt; responseType, Object... uriVariables)</span> <span class="keyword">throws</span> RestClientException</span>
<span class="line"></span>
<span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title">postForObject</span><span class="params">(String url, Object request, Class&lt;T&gt; responseType, Map&lt;String, ?&gt; uriVariables)</span> <span class="keyword">throws</span> RestClientException</span>
<span class="line"></span>
<span class="line"><span class="keyword">public</span> &lt;T&gt; T <span class="title">postForObject</span><span class="params">(URI url, Object request, Class&lt;T&gt; responseType)</span> <span class="keyword">throws</span> RestClientException</span></span>
</pre></td></tr></table></figure>
<p>例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line">HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span>
<span class="line">headers.add(<span class="string">"X-Auth-Token"</span>, <span class="string">"e348bc22-5efa-4299-9142-529f07a18ac9"</span>);</span>
<span class="line"></span>
<span class="line">MultiValueMap&lt;String, String&gt; postParameters = <span class="keyword">new</span> LinkedMultiValueMap&lt;String, String&gt;();</span>
<span class="line">postParameters.add(<span class="string">"owner"</span>, <span class="string">"11"</span>);</span>
<span class="line">postParameters.add(<span class="string">"subdomain"</span>, <span class="string">"aoa"</span>);</span>
<span class="line">postParameters.add(<span class="string">"comment"</span>, <span class="string">""</span>);</span>
<span class="line"></span>
<span class="line">HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt; requestEntity  = <span class="keyword">new</span> HttpEntity&lt;MultiValueMap&lt;String, String&gt;&gt;(postParameters, headers);</span>
<span class="line"></span>
<span class="line">WebResult&lt;Person&gt; result = <span class="keyword">null</span>;</span>
<span class="line"><span class="keyword">try</span> &#123;</span>
<span class="line">  result = restTemplate.postForObject(<span class="string">"请求地址"</span>,  requestEntity, WebResult.class);</span>
<span class="line">  logger.info(result);</span>
<span class="line">&#125; <span class="keyword">catch</span> (RestClientException e) &#123;</span>
<span class="line">  logger.info(<span class="string">"error"</span>, e);</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="RestTemplate配置"><a href="#RestTemplate配置" class="headerlink" title="RestTemplate配置"></a>RestTemplate配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">RestTemplateConfig</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Bean</span></span>
<span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123; RestOperations.class, RestTemplate.class &#125;)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> RestTemplate <span class="title">restTemplate</span><span class="params">(ClientHttpRequestFactory factory)</span> </span>&#123;</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate(factory);</span>
<span class="line"></span>
<span class="line">        List&lt;HttpMessageConverter&lt;?&gt;&gt; messageConverters = restTemplate.getMessageConverters();</span>
<span class="line">        Iterator&lt;HttpMessageConverter&lt;?&gt;&gt; iterator = messageConverters.iterator();</span>
<span class="line">        <span class="keyword">while</span> (iterator.hasNext()) &#123;</span>
<span class="line">            HttpMessageConverter&lt;?&gt; converter = iterator.next();</span>
<span class="line">            <span class="keyword">if</span> (converter <span class="keyword">instanceof</span> StringHttpMessageConverter) &#123;</span>
<span class="line">                iterator.remove();</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line">        messageConverters.add(<span class="keyword">new</span> StringHttpMessageConverter(Charset.forName(<span class="string">"UTF-8"</span>)));</span>
<span class="line">        restTemplate.getMessageConverters().add(<span class="keyword">new</span> MappingJackson2HttpMessageConverter());</span>
<span class="line">        <span class="keyword">return</span> restTemplate;</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Bean</span></span>
<span class="line">    <span class="meta">@ConditionalOnMissingBean</span>(&#123;ClientHttpRequestFactory.class&#125;)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ClientHttpRequestFactory <span class="title">simpleClientHttpRequestFactory</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        SimpleClientHttpRequestFactory factory = <span class="keyword">new</span> SimpleClientHttpRequestFactory();</span>
<span class="line">        factory.setReadTimeout(<span class="number">15000</span>);<span class="comment">// ms</span></span>
<span class="line">        <span class="keyword">return</span> factory;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://spring.io/blog/2009/03/27/rest-in-spring-3-resttemplate" target="_blank" rel="external">https://spring.io/blog/2009/03/27/rest-in-spring-3-resttemplate</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;RestTemplate-是什么？&quot;&gt;&lt;a href=&quot;#RestTemplate-是什么？&quot; class=&quot;headerlink&quot; title=&quot;RestTemplate 是什么？&quot;&gt;&lt;/a&gt;RestTemplate 是什么？&lt;/h3&gt;&lt;p&gt;RestTemplate是Spring提供的一个访问Http服务的客户端类，非常类似JdbcTemplate, JmsTemplate。它是线程安全的（一旦创建完成）。从名称上来看，该类更多是针对RESTFUL风格API设计的。当然如果你想通过它调用普通的Http接口也是可以的。&lt;/p&gt;
&lt;h3 id=&quot;RestTemplate-的方法&quot;&gt;&lt;a href=&quot;#RestTemplate-的方法&quot; class=&quot;headerlink&quot; title=&quot;RestTemplate 的方法&quot;&gt;&lt;/a&gt;RestTemplate 的方法&lt;/h3&gt;&lt;p&gt;RestTemplate提供的方法都是以Http协议中的6个动词开头的：&lt;/p&gt;
&lt;img src=&quot;/2018/05/30/spring-RestTemplate/spring-template.png&quot; alt=&quot;spring-template.png&quot; title=&quot;&quot;&gt;
&lt;p&gt;这些方法的名称清楚地表明它们调用的是哪个HTTP方法，而名称的第二部分表示返回的内容。 例如，&lt;code&gt;getForObject（）&lt;/code&gt;将执行GET，将HTTP响应转换为你选择的对象类型，并返回该对象。&lt;code&gt;postForLocation&lt;/code&gt;将执行POST，将给定对象转换为HTTP请求，并返回可以找到新创建对象的响应&lt;code&gt;HTTP Location&lt;/code&gt;标头。 如你所见，这些方法试图强制执行REST最佳实践。&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>Java 虚拟机的关机方式</title>
    <link href="https://leokongwq.github.io/2018/05/28/java-JVM-shutdown.html"/>
    <id>https://leokongwq.github.io/2018/05/28/java-JVM-shutdown.html</id>
    <published>2018-05-28T07:53:53.000Z</published>
    <updated>2018-05-28T07:57:31.000Z</updated>
    
    <content type="html"><![CDATA[<p>文章转自: <a href="https://zhuanlan.zhihu.com/p/37287644" target="_blank" rel="external">Java 虚拟机的关机方式</a></p>
<p>JVM 是一个虚拟机，既然是虚拟的机器，就必然涉及到关机操作。JVM 关闭时，首先调用关闭钩子，所有钩子执行完毕后，如果需要进行垃圾回收就调用 finalize 方法，否则直接关闭虚拟机。JVM 关闭过程中，不会中断或停止任何线程，在最终关闭虚拟机时强制关闭所有线程。</p>
<a id="more"></a>
<h3 id="关闭钩子"><a href="#关闭钩子" class="headerlink" title="关闭钩子"></a>关闭钩子</h3><p>关闭钩子是一个可以在 JVM 关闭时执行的回调，可以通过 Runtime.addShutdownHook 进行注册。JVM 关闭时首先会调用这些关闭钩子，但不会保证关闭钩子执行的顺序。关闭钩子的执行时间要尽可能短，不应该再做耗时的操作，因为这会影响 JVM 的关闭时间。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">Runtime.getRuntime().addShutdownHook(<span class="keyword">new</span> Thread()&#123;    <span class="comment">//TODO&#125;);</span></span>
</pre></td></tr></table></figure>
<p>如果调用关闭钩子时还有线程在运行，那么关闭钩子将和这些线程同时运行。因此，关闭钩子的操作必须保证是线程安全的，访问数据需要使用同步机制，要避免死锁。同时，关闭钩子需要考虑 JVM 关闭的所有可能性，不能假设关闭的原因，也不应该尝试去分析 JVM 关闭的原因。关闭钩子通常用于服务的清理工作，如 dubbo 使用关闭钩子来关闭连接并通知注册中心注销服务。但关闭钩子是并发执行的，需要考虑多个钩子之间的相互影响，如提前关闭日志服务可能导致其他钩子或线程无法再使用日志。建议只使用一个关闭钩子来处理所有的事情，这样可以确保任务串行执行，从而避免多个钩子之间的竞争和死锁。</p>
<h3 id="守护线程"><a href="#守护线程" class="headerlink" title="守护线程"></a>守护线程</h3><p>Java 中的线程分为普通线程和守护线程。一个线程被创建时会继承创建它的那个线程的守护状态。JVM 启动时创建的线程除了主线程是普通线程，其他线程（如 GC 等）都是守护线程。当线程退出时，JVM 会检查剩余线程的状态，如果剩余的线程都是守护线程已经没有普通线程，那么 JVM 会进行关闭操作。JVM 最终关闭时，守护线程会被直接抛弃，既不会执行 finally 也不会执行回卷栈。因此应该尽量不要使用守护线程，使用时也应该进行简单的操作。</p>
<h3 id="垃圾回收JVM"><a href="#垃圾回收JVM" class="headerlink" title="垃圾回收JVM"></a>垃圾回收JVM</h3><p>关闭的最后一步是进行垃圾回收，主要是文件或套接字资源。这一步主要是调用 finalize 方法进行最后的资源释放。finalize 方法访问的数据可能会被其他线程并发访问，必须对访问进行同步控制。JVM 不保证何时调用 finalize 方法，甚至无法保证是否调用 finalize 方法。因此尽量不要使用 finalize 来释放资源，而应该在 finally 中显式调用 close 方法来关闭资源。</p>
<h3 id="强行关闭"><a href="#强行关闭" class="headerlink" title="强行关闭"></a>强行关闭</h3><p>如果 JVM 遇到问题或者无法关闭，我们可以使用 kill 命令或其他虚拟机自己实现的方法进行强行关闭。强行关闭仅仅是关闭 JVM，不会运行关闭钩子。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;文章转自: &lt;a href=&quot;https://zhuanlan.zhihu.com/p/37287644&quot;&gt;Java 虚拟机的关机方式&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;JVM 是一个虚拟机，既然是虚拟的机器，就必然涉及到关机操作。JVM 关闭时，首先调用关闭钩子，所有钩子执行完毕后，如果需要进行垃圾回收就调用 finalize 方法，否则直接关闭虚拟机。JVM 关闭过程中，不会中断或停止任何线程，在最终关闭虚拟机时强制关闭所有线程。&lt;/p&gt;
    
    </summary>
    
      <category term="java" scheme="https://leokongwq.github.io/categories/java/"/>
    
    
      <category term="jvm" scheme="https://leokongwq.github.io/tags/jvm/"/>
    
  </entry>
  
  <entry>
    <title>Zookeeper简介</title>
    <link href="https://leokongwq.github.io/2018/05/24/zookeeper-learning-summary.html"/>
    <id>https://leokongwq.github.io/2018/05/24/zookeeper-learning-summary.html</id>
    <published>2018-05-24T12:46:53.000Z</published>
    <updated>2018-05-30T08:43:53.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="zookeeper-是什么？"><a href="#zookeeper-是什么？" class="headerlink" title="zookeeper 是什么？"></a>zookeeper 是什么？</h3><p>官方解释如下</p>
<blockquote>
<p>ZooKeeper是一个开源的，专门服务于分布式应用的分布式协调服务。 它提供了一组简单的<code>原语</code>，分布式应用程序可以利用这些<code>原语</code>来实现更高级别的服务，以实现同步，配置维护以及组和命名。 它被设计为易于编程，并使用类似大家所熟悉的文件系统目录树结构的数据模型。</p>
</blockquote>
<p>众所周知，协调服务很难正确实现。 它们特别容易出现诸如竞态条件和死锁等错误。 ZooKeeper背后的动机是减轻分布式应用程序从头开始实施协调服务的责任。</p>
<a id="more"></a>
<h3 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h3><h4 id="简单"><a href="#简单" class="headerlink" title="简单"></a>简单</h4><p>ZooKeeper允许分布式进程通过与标准文件系统组织相似的共享分层命名空间相互协调。 命名空间由称为znode的数据节点组成，按ZooKeeper的说法 - 这些节点类似于文件和目录。 与典型的专为存储功能而设计的文件系统不同，ZooKeeper中的数据保存在内存中，这意味着ZooKeeper可以实现高吞吐量和低延迟。</p>
<p>ZooKeeper的实现关注与高性能，高可用性，和严格有序的访问。 ZooKeeper的高性能意味着它可以用于大型分布式系统。 可靠性使它不会造成单点故障。 严格的顺序意味着可以在客户端实现复杂的同步原语。</p>
<h4 id="多副本"><a href="#多副本" class="headerlink" title="多副本"></a>多副本</h4><p>像ZooKeeper所协调的分布式进程一样，ZooKeeper本身也倾向于部署多个实例，组成一个整体。</p>
<img src="/2018/05/24/zookeeper-learning-summary/zkservice.jpg" alt="zkservice.jpg" title="">
<p>组成ZooKeeper服务的服务器必须全都彼此了解。它们保持状态的内存映像，以及持久存储中的事务日志和快照。 只要大部分服务器都可用，ZooKeeper服务将可用。</p>
<p>客户端只会连接到整个集群中的一台ZooKeeper服务器。 客户端会维护一个TCP连接，通过该连接发送请求，获取响应，获取监视事件并发送心跳。 如果到服务器的TCP连接中断，则客户端将连接到不同的服务器。</p>
<h4 id="顺序性"><a href="#顺序性" class="headerlink" title="顺序性"></a>顺序性</h4><p>ZooKeeper使用一个反映所有ZooKeeper事务顺序的数字来标记每个更新。 后续操作可以使用该顺序来实现更高级别的抽象，例如同步原语。</p>
<h4 id="高性能"><a href="#高性能" class="headerlink" title="高性能"></a>高性能</h4><p>zookeeper在读多写少的场景下速度非常快。ZooKeeper 服务可以运行在数千台机器上，在读取操作远多于写操作的场景下性能表现很好。读的性能可能10倍于写性能</p>
<h4 id="数据模型和继承结构的命名空间"><a href="#数据模型和继承结构的命名空间" class="headerlink" title="数据模型和继承结构的命名空间"></a>数据模型和继承结构的命名空间</h4><p>ZooKeeper提供的名称空间非常类似于标准文件系统。 名称是由斜线<code>/</code>分隔的一系列路径元素。 ZooKeeper名称空间中的每个节点都由一个路径标识。</p>
<img src="/2018/05/24/zookeeper-learning-summary/zknamespace.jpg" alt="zknamespace.jpg" title="">
<h4 id="节点和临时节点"><a href="#节点和临时节点" class="headerlink" title="节点和临时节点"></a>节点和临时节点</h4><p>与标准文件系统不同，ZooKeeper命名空间中的每个节点都可以拥有与其相关的数据。 这就像有一个文件系统，允许一个节点既是文件也是目录。 （ZooKeeper被设计用于存储协调数据：状态信息，配置，位置信息等，因此存储在每个节点的数据通常很小，在字节到千字节范围内。）我们使用术语znode来说明我们正在谈论ZooKeeper数据节点。</p>
<p>Znodes维护一个统计结构，包括数据更改的版本号，ACL更改和时间戳，以允许缓存验证和协调更新。 每次znode的数据更改时，版本号都会增加。 例如，每当客户端检索数据时，客户端也会收到数据的版本。</p>
<p>存储在名称空间中每个节点上的数据都是以原子方式读取和写入的。 读取获取与znode关联的所有数据字节，写入将替换所有数据。 每个节点都有一个访问控制列表（ACL），限制谁可以做什么。</p>
<p>ZooKeeper也有临时节点的概念。 只要创建znode的会话处于活动状态，这些znode就会存在。 当会话结束时，znode被删除。 当你想实现[tbd]时，临时节点很有用。</p>
<h4 id="条件更新和观察者"><a href="#条件更新和观察者" class="headerlink" title="条件更新和观察者"></a>条件更新和观察者</h4><p>ZooKeeper支持观察者的概念。 客户可以在znode上设置观察者。 当znode改变时，观察者将被<code>触发并移除</code>。 当观察者被触发时，客户端会收到一个数据包，说明znode已经改变。 如果客户端和其中一个ZooKeeper服务器之间的连接中断，客户端将收到本地通知。 这些可用于[tbd]。</p>
<h4 id="保证"><a href="#保证" class="headerlink" title="保证"></a>保证</h4><p>ZooKeeper非常快速且非常简单。 由于其目标是构建更复杂的服务（如同步）的基础，因此它提供了一组保证。 这些是：</p>
<ul>
<li>顺序一致性  来自客户端的更新将按照它们发送的顺序被执行。</li>
<li>原子性  更新或者成功或失败，不存在中间状态</li>
<li>单系统映像  无论客户端连接到哪个服务器，客户端都会看到相同的服务视图。</li>
<li>可靠性 一旦更新被成功执行，则该更新结果会从该时刻被持久化，直到客户端下一次更新它为止。</li>
<li>及时性 - 系统的客户视图保证在一定的时间范围内保持最新状态。</li>
</ul>
<h4 id="简单的-API"><a href="#简单的-API" class="headerlink" title="简单的 API"></a>简单的 API</h4><p>Zookeeper的一个设计目标就是提供非常简单的编程接口。因此，它只提供了下面的操作：</p>
<h5 id="create"><a href="#create" class="headerlink" title="create"></a>create</h5><p>创建一个节点</p>
<h5 id="delete"><a href="#delete" class="headerlink" title="delete"></a>delete</h5><p>删除一个节点</p>
<h5 id="exists"><a href="#exists" class="headerlink" title="exists"></a>exists</h5><p>判断一个节点是否存在</p>
<h5 id="get-data"><a href="#get-data" class="headerlink" title="get data"></a>get data</h5><p>获取节点的数据</p>
<h5 id="set-data"><a href="#set-data" class="headerlink" title="set data"></a>set data</h5><p>设置节点的数据</p>
<h5 id="get-children"><a href="#get-children" class="headerlink" title="get children"></a>get children</h5><p>获取节点的子节点列表</p>
<h5 id="sync"><a href="#sync" class="headerlink" title="sync"></a>sync</h5><p>等待数据传播</p>
<h4 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h4><p>ZooKeeper组件显示了ZooKeeper服务的高级组件。 除请求处理器外，构成ZooKeeper服务的每个服务器都复制其各个组件的副本。</p>
<img src="/2018/05/24/zookeeper-learning-summary/zkcomponents.jpg" alt="zkcomponents.jpg" title="">
<p>副本集数据库是一个包含整个数据树的内存数据库。更新操作会被写入磁盘以实现故障恢复，写操作会先序列化到磁盘，然后在内存数据库中执行。</p>
<p>每个ZooKeeper服务器都为客户提供服务。客户端连接至一台服务器以提交irequest。读请求的数据是从每个服务器数据库的本地副本获取。需改服务状态的请求，也就是写请求是通过一致性协议进行处理的。</p>
<p>作为一致性协议的一部分，所有来自客户端的写入请求都被转发到一台称为<code>Leader</code>的服务器。 ZooKeeper服务的其余节点服务器（称为follower）接收Leader发出的消息提议，并就消息传递达成一致。消息传递层负责在Leader宕机后选择新的Leader，并与Leader数据保存同步。</p>
<p>ZooKeeper使用自定义的原子消息传递协议<code>(ZAB)</code>。由于消息传递层是原子的，因此ZooKeeper可以保证本地数据副本永不过期。当Leader接收到一个写请求时，它会计算在写操作被执行时系统所处的状态，并将其转换成一个捕获这个新状态的事务</p>
<h3 id="zookeeper的一致性如何保证"><a href="#zookeeper的一致性如何保证" class="headerlink" title="zookeeper的一致性如何保证"></a>zookeeper的一致性如何保证</h3><h3 id="zookeeper如何选主"><a href="#zookeeper如何选主" class="headerlink" title="zookeeper如何选主"></a>zookeeper如何选主</h3><h3 id="zookeeper写数据的过程"><a href="#zookeeper写数据的过程" class="headerlink" title="zookeeper写数据的过程"></a>zookeeper写数据的过程</h3><h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://zookeeper.apache.org/doc/r3.5.4-beta/zookeeperOver.html" target="_blank" rel="external">zookeeperOver.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;zookeeper-是什么？&quot;&gt;&lt;a href=&quot;#zookeeper-是什么？&quot; class=&quot;headerlink&quot; title=&quot;zookeeper 是什么？&quot;&gt;&lt;/a&gt;zookeeper 是什么？&lt;/h3&gt;&lt;p&gt;官方解释如下&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;ZooKeeper是一个开源的，专门服务于分布式应用的分布式协调服务。 它提供了一组简单的&lt;code&gt;原语&lt;/code&gt;，分布式应用程序可以利用这些&lt;code&gt;原语&lt;/code&gt;来实现更高级别的服务，以实现同步，配置维护以及组和命名。 它被设计为易于编程，并使用类似大家所熟悉的文件系统目录树结构的数据模型。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;p&gt;众所周知，协调服务很难正确实现。 它们特别容易出现诸如竞态条件和死锁等错误。 ZooKeeper背后的动机是减轻分布式应用程序从头开始实施协调服务的责任。&lt;/p&gt;
    
    </summary>
    
      <category term="架构" scheme="https://leokongwq.github.io/categories/%E6%9E%B6%E6%9E%84/"/>
    
    
      <category term="zookeeper" scheme="https://leokongwq.github.io/tags/zookeeper/"/>
    
  </entry>
  
  <entry>
    <title>常见DNS记录解释</title>
    <link href="https://leokongwq.github.io/2018/05/24/common-dns-records.html"/>
    <id>https://leokongwq.github.io/2018/05/24/common-dns-records.html</id>
    <published>2018-05-24T06:18:58.000Z</published>
    <updated>2018-05-24T07:53:43.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="A记录"><a href="#A记录" class="headerlink" title="A记录"></a>A记录</h3><p>A记录，又称IP指向，用户可以设置域名到目标主机IP地址的映射，从而实现通过域名找到服务器。</p>
<h4 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h4><p>可以配置多条A记录，通过域名解析来实现<code>轮询</code>负载均衡。</p>
<h4 id="泛域名解析"><a href="#泛域名解析" class="headerlink" title="泛域名解析"></a>泛域名解析</h4><p>泛域名解析指的是将一个域名所有未指定的子域名统一解析到一个地址。</p>
<p>在<code>主机名</code>中填入<code>*</code>，类型为<code>A</code>，<code>IP地址/主机名</code>中填入web服务器的IP地址，点击“新增”按钮即可。</p>
<a id="more"></a>
<h3 id="NS-记录"><a href="#NS-记录" class="headerlink" title="NS 记录"></a>NS 记录</h3><p>域名服务器 (NS) 记录用于确定由哪些服务器来解析域名。</p>
<p>例如用户希望由12.34.56.78这台服务器解析news.mydomain.com，则需要设置<code>news.mydomain.com</code>的NS记录。</p>
<p>说明：<code>优先级</code>中的数字越小表示级别越高；<code>IP地址/主机名</code>中既可以填写IP地址，也可以填写像<code>ns.mydomain.com</code>这样的主机地址，但必须保证该主机地址有效。</p>
<p>如将<code>news.mydomain.com</code>的NS记录指向到<code>ns.mydomain.com</code>，在设置NS记录的同时还需要设置<code>ns.mydomain.com</code>的指向（因为<code>ns.mydomain.com</code>也是一个域名，需要解析）。</p>
<p>否则NS记录将无法正常解析；NS记录优先于A记录。即，如果一个主机地址同时存在NS记录和A记录，则A记录不生效。这里的NS记录只对子域名生效。 </p>
<h3 id="MX记录"><a href="#MX记录" class="headerlink" title="MX记录"></a>MX记录</h3><p>MX记录: 邮件交换记录。用于将以该域名为结尾的电子邮件指向对应的邮件服务器以进行处理。如：用户所用的邮件是以域名<code>mydomain.com</code>为结尾的，则需要在管理界面中添加该域名的MX记录来处理所有以<code>@mydomain.com</code>结尾的邮件。 </p>
<p>说明：MX记录可以使用主机名或IP地址；MX记录可以通过设置优先级实现主辅服务器设置，“优先级”中的数字越小表示级别越高。也可以使用相同优先级达到负载均衡的目的；如果在<code>主机名</code>中填入子域名则此MX记录只对该子域名生效。</p>
<h3 id="CNAME-记录"><a href="#CNAME-记录" class="headerlink" title="CNAME 记录"></a>CNAME 记录</h3><p><code>CNAME</code>(Canonical Name)通常称别名指向。你可以为一个主机设置别名。比如设置test.mydomain.com，用来指向一个主机www.rddns.com那么以后就可以用test.mydomain.com来代替访问www.rddns.com了。</p>
<p>说明：CNAME的目标主机地址只能使用主机名，不能使用IP地址；主机名前不能有任何其他前缀，如：<code>http://</code>等是不被允许的；A记录优先于CNAME记录。即如果一个主机地址同时存在A记录和CNAME记录，则CNAME记录不生效。  </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line">nslookup  www.baidu.com</span>
<span class="line">Server:		10.1.30.51</span>
<span class="line">Address:	10.1.30.51#53</span>
<span class="line"></span>
<span class="line">Non-authoritative answer:</span>
<span class="line">www.baidu.com	canonical name = www.a.shifen.com.</span>
<span class="line">Name:	www.a.shifen.com</span>
<span class="line">Address: 61.135.169.121</span>
<span class="line">Name:	www.a.shifen.com</span>
<span class="line">Address: 61.135.169.125</span>
</pre></td></tr></table></figure>
<p>从上面的命令输出可以知道：<code>www.baidu.com</code>的别名是<code>www.a.shifen.com.</code></p>
<p>使用 CNAME 的好处就是解耦了域名和 IP 的直接联系, 这样假如服务器 IP 发生变更, 只需要改变CNAME记录中别名的A记录中的IP。</p>
<h3 id="TXT记录"><a href="#TXT记录" class="headerlink" title="TXT记录"></a>TXT记录</h3><p>TXT记录一般是为某条记录设置说明，比如你新建了一条<code>a.ezloo.com</code>的TXT记录，TXT记录内容”this is a test TXT record.”，然后你用 <code>nslookup -qt txt a.ezloo.com</code> ，你就能看到”this is a test TXT record”的字样。</p>
<p>除外，TXT还可以用来验证域名的所有，比如你的域名使用了Google的某项服务，Google会要求你建一个TXT记录，然后Google验证你对此域名是否具备管理权限。</p>
<p>在命令行下可以使用<code>nslookup -qt=txt a.ezloo.com</code>来查看TXT记录。</p>
<h3 id="AAAA记录"><a href="#AAAA记录" class="headerlink" title="AAAA记录"></a>AAAA记录</h3><p>AAAA记录是一个指向IPv6地址的记录。</p>
<p>可以使用nslookup -qt=aaaa a.ezloo.com来查看AAAA记录。</p>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://support.google.com/a/answer/48090?hl=zh-Hans" target="_blank" rel="external">DNS 基础知识</a></p>
<p><a href="https://support.dnsimple.com/categories/dns/" target="_blank" rel="external">DNS articles</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;A记录&quot;&gt;&lt;a href=&quot;#A记录&quot; class=&quot;headerlink&quot; title=&quot;A记录&quot;&gt;&lt;/a&gt;A记录&lt;/h3&gt;&lt;p&gt;A记录，又称IP指向，用户可以设置域名到目标主机IP地址的映射，从而实现通过域名找到服务器。&lt;/p&gt;
&lt;h4 id=&quot;负载均衡&quot;&gt;&lt;a href=&quot;#负载均衡&quot; class=&quot;headerlink&quot; title=&quot;负载均衡&quot;&gt;&lt;/a&gt;负载均衡&lt;/h4&gt;&lt;p&gt;可以配置多条A记录，通过域名解析来实现&lt;code&gt;轮询&lt;/code&gt;负载均衡。&lt;/p&gt;
&lt;h4 id=&quot;泛域名解析&quot;&gt;&lt;a href=&quot;#泛域名解析&quot; class=&quot;headerlink&quot; title=&quot;泛域名解析&quot;&gt;&lt;/a&gt;泛域名解析&lt;/h4&gt;&lt;p&gt;泛域名解析指的是将一个域名所有未指定的子域名统一解析到一个地址。&lt;/p&gt;
&lt;p&gt;在&lt;code&gt;主机名&lt;/code&gt;中填入&lt;code&gt;*&lt;/code&gt;，类型为&lt;code&gt;A&lt;/code&gt;，&lt;code&gt;IP地址/主机名&lt;/code&gt;中填入web服务器的IP地址，点击“新增”按钮即可。&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
  </entry>
  
  <entry>
    <title>JWT简介</title>
    <link href="https://leokongwq.github.io/2018/05/22/json-web-token.html"/>
    <id>https://leokongwq.github.io/2018/05/22/json-web-token.html</id>
    <published>2018-05-22T04:52:27.000Z</published>
    <updated>2018-06-24T13:48:31.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="What-is-JSON-Web-Token"><a href="#What-is-JSON-Web-Token" class="headerlink" title="What is JSON Web Token?"></a>What is JSON Web Token?</h3><p>JSON Web Token（JWT）是一个开放式标准（<a href="https://tools.ietf.org/html/rfc7519" target="_blank" rel="external">RFC 7519</a>），它定义了一种紧凑且自包含的方式，用于在各方之间以JSON对象安全的传输信息。 这些信息可以通过数字签名进行验证和信任。 JWT可以使用一个秘钥（HMAC签名算法）或使用RSA的公钥/私钥对对JWT进行签名。</p>
<p>虽然JWT可以加密以提供各方之间数据传递的保密性，但我们将重点关注已签名的令牌。 签名的令牌可以验证其中包含的信息的完整性，而加密令牌隐藏来自其他方的信息。 当令牌使用公钥/私钥对进行签名时，签名还证明只有持有私钥的方是签名方。</p>
<p>下面深入了解下JWT中的概念</p>
<ul>
<li>紧凑: 因为JWT的大小比较小，因为它可以通过URL, POST参数 或者HTTP请求头来进行传递。从另一方面来说说，因为它小，所以传递速度也比较快（占用带宽小）。</li>
<li>自包含: JWT的负载包含了该用户所需的所有信息，从而避免了对DB的多次查询。</li>
</ul>
<a id="more"></a>
<h3 id="When-should-you-use-JSON-Web-Tokens"><a href="#When-should-you-use-JSON-Web-Tokens" class="headerlink" title="When should you use JSON Web Tokens?"></a>When should you use JSON Web Tokens?</h3><p>以下是JSON Web Tokens有用的一些场景：</p>
<ul>
<li>认证: 这是使用JWT最常见的情况。 一旦用户登录，每个后续请求都将包含JWT，允许用户访问该令牌允许的路由，服务和资源。 单点登录（SSO）是当今广泛使用JWT的一项功能，因为它的开销很小，并且能够轻松地跨不同域使用.</li>
<li>信息交换: JWT也是一个在各方之间安全传输信息的好方法。 因为JWT可以签名 - 例如使用公钥/私钥对，所以可以确定发件人是他们自称的人。 此外，由于使用请求头和有效载荷来参加签名的计算，因此你还可以验证内容是否未被篡改。</li>
</ul>
<h3 id="What-is-the-JSON-Web-Token-structure"><a href="#What-is-the-JSON-Web-Token-structure" class="headerlink" title="What is the JSON Web Token structure?"></a>What is the JSON Web Token structure?</h3><p>在JWT的紧凑格式中, JWT由三部分构成，每个部分以<code>.</code>号进行分割。如下所示：</p>
<ul>
<li>Header</li>
<li>Payload</li>
<li>Signature</li>
</ul>
<p>因此一个典型的JWT可能看起来是下面的样子：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">xxxxx.yyyyy.zzzzz</span>
</pre></td></tr></table></figure>
<h3 id="Header"><a href="#Header" class="headerlink" title="Header"></a>Header</h3><p>header部分通常包含两部分：令牌的类型，和其使用的哈希算法，例如：HMAC，SHA256 或 RSA.</p>
<p>例如：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line">&#123;</span>
<span class="line">  <span class="string">"alg"</span>: <span class="string">"HS256"</span>,</span>
<span class="line">  <span class="string">"typ"</span>: <span class="string">"JWT"</span></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>然后，这个JSON被Base64Url编码，形成JWT的第一部分。</p>
<h3 id="Payload"><a href="#Payload" class="headerlink" title="Payload"></a>Payload</h3><p>令牌的第二部分是包含声明的有效负载。 声明是关于实体（通常是用户）和其它元数据的声明。 有三种类型的claim：注册的claim，公开的claim和私有的claim。</p>
<ul>
<li>已登记的claims：这些是一组预先定义的claims，这些claims不是强制性的，但建议提供一套有用的，可互操作的claims。 其中一些是：iss（发行者），exp（到期时间），sub（主题），aud（受众）等。</li>
</ul>
<blockquote>
<p>Notice that the claim names are only three characters long as JWT is meant to be compact.</p>
</blockquote>
<ul>
<li>公共的claims: 这些可以由使用JWT的人员随意定义。 但为避免冲突，应在<a href="https://www.iana.org/assignments/jwt/jwt.xhtml" target="_blank" rel="external">IANA JSON Web令牌注册表</a>中定义它们，或将其定义为包含防冲突命名空间的URI。</li>
<li>私有的claims: 这些是为了同意使用它们并且既没有登记也没有公开声明的各方之间共享信息而创建的定制声明。</li>
</ul>
<p>一个有效的负载可以是:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line">&#123;</span>
<span class="line">  &quot;sub&quot;: &quot;1234567890&quot;,</span>
<span class="line">  &quot;name&quot;: &quot;John Doe&quot;,</span>
<span class="line">  &quot;admin&quot;: true</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>然后将有效载荷Base64Url进行编码以形成JSON Web令牌的第二部分。</p>
<blockquote>
<p>请注意，对于已签名的令牌，此信息尽管受到篡改保护，但任何人都可以阅读。 除非加密，否则不要将关键信息放在JWT的payload或header中。</p>
</blockquote>
<h4 id="签名"><a href="#签名" class="headerlink" title="签名"></a>签名</h4><p>要创建签名部分，你必须拥用已经编码的header，编码的有效载荷，秘钥，header中指定的算法并签名。</p>
<p>例如，如果你想使用HMAC SHA256算法，签名将按照以下方式创建：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">HMACSHA256(base64UrlEncode(header) + &quot;.&quot; + base64UrlEncode(payload), secret)</span>
</pre></td></tr></table></figure>
<p>该签名用于验证消息在一路上没有改变，并且在使用私钥签名的令牌的情况下，它还可以验证JWT的发件人是谁说的。</p>
<h4 id="组合起来"><a href="#组合起来" class="headerlink" title="组合起来"></a>组合起来</h4><p>输出是三个由<code>.</code>号分隔的Base64-URL字符串，可以在HTML和HTTP环境中轻松传递，而与基于XML的标准（如SAML）相比，它更加紧凑。</p>
<p>以下显示了一个JWT，它具有签名通过编码的header和有效负载，并且使用秘钥进行签名。</p>
<img src="/2018/05/22/json-web-token/encoded-jwt3.png" alt="encoded-jwt3.png" title="">
<p>如果你想要使用JWT并将这些概念付诸实践，则可以使用<a href="https://link.jianshu.com/?t=https://jwt.io/#debugger-io" target="_blank" rel="external">jwt.io调试器</a>来解码，验证和生成JWT。</p>
<h3 id="JWT-如何工作"><a href="#JWT-如何工作" class="headerlink" title="JWT 如何工作"></a>JWT 如何工作</h3><p>在认证场景中，相较于传统的模式(在服务端生成会话并返回一个cookie)，当用户使用他们的凭据成功登录以后，一个JSON Web Token将会被返回，该令牌必须被保存在本地(典型的场景是保存在本地存储中，不过cookie也常常用来保存这一类信息)。</p>
<p>无论何时，当用户想要访问一个受保护的资源，他必须将JWT发送到服务端，典型的发送方式是通过 Authorization 请求头字段，并指定 Bearer 模式。请求头的内容看起来会像下面这样：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">Authorization: Bearer &lt;token&gt;</span>
</pre></td></tr></table></figure>
<p>这是一个无状态的认证机制，用户信息永远也不会保存在服务器的内存中。服务器受保护的路由会检查通过Authorization头传递的令牌是否是一个正确的令牌，如果检查通过，用户将被允许访问受保护的资源。由于JWT是自包含的，所有必要的信息都包含在令牌中，进而减少了查询数据库所需要的时间。</p>
<p>正因为如此，JWT允许你的服务完全依赖于无状态的数据接口。它不关心你的APIs寄宿在哪个域名之下，因此跨域访问(CORS)将不会成为一个问题(使用cookie就不行)</p>
<p>下面的图表展示了整个处理流程</p>
<img src="/2018/05/22/json-web-token/jwt-diagram.png" alt="jwt-diagram.png" title="">
<h3 id="安全总结"><a href="#安全总结" class="headerlink" title="安全总结"></a>安全总结</h3><ol>
<li>预防XSS可以通过cookie存储JWT， http-only, secure</li>
<li>预防CSRF可以通过给请求添加CSRF token， 该token可以放在WebStorage中。如此，攻击者网站不能获取该token。</li>
</ol>
<p>当然了，如果攻击者第一步通过XSS获取了CSRF token，第二步通过CSRF攻击，则漏洞还是存在的。单此种情况发生的概率能小一点。只能通过缩短token的时间</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="https://mozillazg.com/2015/06/hello-jwt.html" target="_blank" rel="external">hello-jwt</a><br><a href="https://stormpath.com/blog/where-to-store-your-jwts-cookies-vs-html5-web-storage/" target="_blank" rel="external">where-to-store-your-jwts-cookies-vs-html5-web-storage</a><br><a href="https://stormpath.com/blog/jwt-the-right-way/" target="_blank" rel="external">jwt-the-right-way</a><br><a href="https://auth0.com/blog/2014/01/27/ten-things-you-should-know-about-tokens-and-cookies/" target="_blank" rel="external">ten-things-you-should-know-about-tokens-and-cookies</a><br><a href="http://stackoverflow.com/questions/27067251/where-to-store-jwt-in-browser-how-to-protect-against-csrf" target="_blank" rel="external">where-to-store-jwt-in-browser-how-to-protect-against-csrf</a><br><a href="http://hippoom.github.io/blogs/stoping-using-jwt-for-sessions.html" target="_blank" rel="external">别再使用JWT</a><br><a href="https://bbs.huaweicloud.com/blogs/06607ea7b53211e7b8317ca23e93a891" target="_blank" rel="external">基于JWT的Token认证机制及安全问题</a><br><a href="https://x-team.com/blog/my-experience-with-json-web-tokens/" target="_blank" rel="external">My Experience with JSON Web Tokens</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;What-is-JSON-Web-Token&quot;&gt;&lt;a href=&quot;#What-is-JSON-Web-Token&quot; class=&quot;headerlink&quot; title=&quot;What is JSON Web Token?&quot;&gt;&lt;/a&gt;What is JSON Web Token?&lt;/h3&gt;&lt;p&gt;JSON Web Token（JWT）是一个开放式标准（&lt;a href=&quot;https://tools.ietf.org/html/rfc7519&quot;&gt;RFC 7519&lt;/a&gt;），它定义了一种紧凑且自包含的方式，用于在各方之间以JSON对象安全的传输信息。 这些信息可以通过数字签名进行验证和信任。 JWT可以使用一个秘钥（HMAC签名算法）或使用RSA的公钥/私钥对对JWT进行签名。&lt;/p&gt;
&lt;p&gt;虽然JWT可以加密以提供各方之间数据传递的保密性，但我们将重点关注已签名的令牌。 签名的令牌可以验证其中包含的信息的完整性，而加密令牌隐藏来自其他方的信息。 当令牌使用公钥/私钥对进行签名时，签名还证明只有持有私钥的方是签名方。&lt;/p&gt;
&lt;p&gt;下面深入了解下JWT中的概念&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;紧凑: 因为JWT的大小比较小，因为它可以通过URL, POST参数 或者HTTP请求头来进行传递。从另一方面来说说，因为它小，所以传递速度也比较快（占用带宽小）。&lt;/li&gt;
&lt;li&gt;自包含: JWT的负载包含了该用户所需的所有信息，从而避免了对DB的多次查询。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
  </entry>
  
  <entry>
    <title>ActiveMQ 消息重发策略</title>
    <link href="https://leokongwq.github.io/2018/05/19/activemq-redelivery-policy-config.html"/>
    <id>https://leokongwq.github.io/2018/05/19/activemq-redelivery-policy-config.html</id>
    <published>2018-05-19T01:24:28.000Z</published>
    <updated>2018-05-19T02:21:05.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>在使用ActiveMQ时，配置了消息重发策略。 但因为对配置项的理解不够深刻，导致虽然消息重新被投递了，单因为时间间隔太小，最终被放入DLQ中。</p>
<blockquote>
<p>注意： 我使用的ActiveMQ版本是5.8</p>
</blockquote>
<h3 id="错误配置"><a href="#错误配置" class="headerlink" title="错误配置"></a>错误配置</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Bean</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> RedeliveryPolicy <span class="title">redeliveryPolicy</span><span class="params">()</span> </span>&#123;</span>
<span class="line">   RedeliveryPolicy redeliveryPolicy = <span class="keyword">new</span> RedeliveryPolicy();</span>
<span class="line">   <span class="comment">//是否在每次尝试重新发送失败后,增长这个等待时间</span></span>
<span class="line">   redeliveryPolicy.setUseExponentialBackOff(<span class="keyword">true</span>);</span>
<span class="line">   <span class="comment">//重发次数,默认为6次   这里设置为10次</span></span>
<span class="line">   redeliveryPolicy.setMaximumRedeliveries(<span class="number">10</span>);</span>
<span class="line">   <span class="comment">//重发时间间隔,默认为1秒</span></span>
<span class="line">   redeliveryPolicy.setInitialRedeliveryDelay(<span class="number">1</span>);</span>
<span class="line">   <span class="comment">//第一次失败后重新发送之前等待1秒,第二次失败再等待1 * 2秒,这里的2就是value</span></span>
<span class="line">   redeliveryPolicy.setBackOffMultiplier(<span class="number">2</span>);</span>
<span class="line">   <span class="comment">//是否避免消息碰撞</span></span>
<span class="line">   redeliveryPolicy.setUseCollisionAvoidance(<span class="keyword">false</span>);</span>
<span class="line">   <span class="comment">//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效</span></span>
<span class="line">   redeliveryPolicy.setMaximumRedeliveryDelay(-<span class="number">1</span>);</span>
<span class="line">   <span class="keyword">return</span> redeliveryPolicy;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<a id="more"></a>
<p>上面配置有如下问题：</p>
<ol>
<li>第一次投递延时<code>(initialRedeliveryDelay)</code>为1毫秒, 而不是注释里面说的1秒。这是第一个致命错误</li>
<li>最大重投次数<code>(maximumRedeliveries)</code> 为10。 加上第一个配置，导致短时间内消息被重新投递多次，一般来说消费者肯定不能成功消费的。因此会导致消息被放入DLQ中，业务丢失了消息。<br>这是第二个错误，重投次数有点小。对于非常重要的消息，可以适当调大该配置值。</li>
<li>是否启用重投时延指数增长策略<code>(useExponentialBackOff) 默认是false</code>。如何理解呢？ActiveMQ 会在延迟<code>initialRedeliveryDelay</code> 指定的时间后发起<strong>第一次</strong>重新投递，之后根据是否设置了<code>useExponentialBackOff=true</code>来判断是否需要递增每次投递的时延。如果设置了<code>useExponentialBackOff=true</code>，那么每次重新投递的时间会延迟<code>redeliveryDelay * backOffMultiplier</code></li>
</ol>
<p>由此可以退出每次消息重新投递的延时为：</p>
<table>
<thead>
<tr>
<th>次数</th>
<th>延时</th>
</tr>
</thead>
<tbody>
<tr>
<td>1</td>
<td>1毫秒</td>
</tr>
<tr>
<td>2</td>
<td>2 毫秒</td>
</tr>
<tr>
<td>3</td>
<td>4 毫秒</td>
</tr>
<tr>
<td>4</td>
<td>8 毫秒</td>
</tr>
<tr>
<td>5</td>
<td>16 毫秒</td>
</tr>
<tr>
<td>6</td>
<td>32 毫秒</td>
</tr>
<tr>
<td>7</td>
<td>64 毫秒</td>
</tr>
<tr>
<td>8</td>
<td>128 毫秒</td>
</tr>
<tr>
<td>9</td>
<td>256 毫秒</td>
</tr>
<tr>
<td>10</td>
<td>512 毫秒</td>
</tr>
</tbody>
</table>
<p>从上表可以看出，完全没有达到需要的效果。痛定思痛，翻看官方文档和源代码，将ActiveMQ消息重复策略总结如下：</p>
<h3 id="消息重发时机"><a href="#消息重发时机" class="headerlink" title="消息重发时机"></a>消息重发时机</h3><p>1．在使用事务的Session中，调用rollback()方法；<br>2．在使用事务的Session中，调用commit()方法之前就关闭了Session;<br>3．在Session中使用CLIENT_ACKNOWLEDGE签收模式，并且调用了<code>recover()</code>方法。</p>
<p>可以通过设置<code>ActiveMQConnectionFactory</code>和<code>ActiveMQConnection</code>来定制想要的再次传送策略。</p>
<h3 id="消息重发配置项"><a href="#消息重发配置项" class="headerlink" title="消息重发配置项"></a>消息重发配置项</h3><h4 id="collisionAvoidanceFactor"><a href="#collisionAvoidanceFactor" class="headerlink" title="collisionAvoidanceFactor"></a>collisionAvoidanceFactor</h4><p>默认值 0.15     </p>
<p>设置防止冲突范围的正负百分比，只有启用useCollisionAvoidance参数时才生效。</p>
<h4 id="maximumRedeliveries"><a href="#maximumRedeliveries" class="headerlink" title="maximumRedeliveries"></a>maximumRedeliveries</h4><p>默认值：6</p>
<p>最大重传次数。 达到最大重连次数后抛出异常。为-1时不限制次数，为0时表示不进行重传。</p>
<h4 id="maximumRedeliveryDelay"><a href="#maximumRedeliveryDelay" class="headerlink" title="maximumRedeliveryDelay"></a>maximumRedeliveryDelay</h4><p>默认值 -1    </p>
<p>最大传送延迟，只在useExponentialBackOff为true时有效（V5.5），假设首次重连间隔为10ms，倍数为2，那么第二次重连时间间隔为 20ms，第三次重连时间间隔为40ms，当重连时间间隔大的最大重连时间间隔时，以后每次重连时间间隔都为最大重连时间间隔。</p>
<h4 id="initialRedeliveryDelay"><a href="#initialRedeliveryDelay" class="headerlink" title="initialRedeliveryDelay"></a>initialRedeliveryDelay</h4><p>默认值 1000L     </p>
<p>初始重发延迟时间</p>
<h4 id="redeliveryDelay"><a href="#redeliveryDelay" class="headerlink" title="redeliveryDelay"></a>redeliveryDelay</h4><p>默认值：1000L     </p>
<p>重发延迟时间，当initialRedeliveryDelay=0时生效（v5.4）</p>
<h4 id="useCollisionAvoidance"><a href="#useCollisionAvoidance" class="headerlink" title="useCollisionAvoidance"></a>useCollisionAvoidance</h4><p>默认值 false     </p>
<p>启用防止冲突功能，因为消息接收时是可以使用多线程并发处理的，应该是为了重发的安全性，避开所有并发线程都在同一个时间点进行消息接收处理。所有线程在同一个时间点处理时会发生什么问题呢？应该没有问题，只是为了平衡broker处理性能，不会有时很忙，有时很空闲。</p>
<h4 id="useExponentialBackOff"><a href="#useExponentialBackOff" class="headerlink" title="useExponentialBackOff"></a>useExponentialBackOff</h4><p>默认值 false          </p>
<p>启用指数倍数递增的方式增加延迟时间。</p>
<h4 id="backOffMultiplier"><a href="#backOffMultiplier" class="headerlink" title="backOffMultiplier"></a>backOffMultiplier</h4><p>默认值 5    </p>
<p>重连时间间隔递增倍数，只有值大于1和启用<code>useExponentialBackOff</code>参数时才生效。</p>
<h3 id="重发源码分析"><a href="#重发源码分析" class="headerlink" title="重发源码分析"></a>重发源码分析</h3><h4 id="重发时机"><a href="#重发时机" class="headerlink" title="重发时机"></a>重发时机</h4><figure class="highlight java"><figcaption><span>ActiveMQMessageConsumer.rollback</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">final</span> <span class="keyword">int</span> currentRedeliveryCount = lastMd.getMessage().getRedeliveryCounter();</span>
<span class="line"> <span class="keyword">if</span> (currentRedeliveryCount &gt; <span class="number">0</span>) &#123;</span>
<span class="line">     <span class="comment">// 获取下次被重新投递的延迟时间</span></span>
<span class="line">     redeliveryDelay = redeliveryPolicy.getNextRedeliveryDelay(redeliveryDelay);</span>
<span class="line"> &#125; <span class="keyword">else</span> &#123;</span>
<span class="line">     <span class="comment">//  第一被重新投递的延迟时间 </span></span>
<span class="line">     redeliveryDelay = redeliveryPolicy.getInitialRedeliveryDelay();</span>
<span class="line"> &#125;</span>
<span class="line"> <span class="comment">// 当前消息被重新投递的此时大于配置的值，此时消息会被发送到DLQ</span></span>
<span class="line"> <span class="keyword">if</span> (redeliveryPolicy.getMaximumRedeliveries() != RedeliveryPolicy.NO_MAXIMUM_REDELIVERIES</span>
<span class="line">                    &amp;&amp; lastMd.getMessage().getRedeliveryCounter() &gt; redeliveryPolicy.getMaximumRedeliveries()) &#123;</span>
<span class="line"><span class="comment">// We need to NACK the messages so that they get sent to the</span></span>
<span class="line"><span class="comment">// DLQ.</span></span>
<span class="line"><span class="comment">// Acknowledge the last message.</span></span>
<span class="line"></span>
<span class="line">MessageAck ack = <span class="keyword">new</span> MessageAck(lastMd, MessageAck.POSION_ACK_TYPE, deliveredMessages.size());</span>
<span class="line"> &#125; <span class="keyword">else</span> &#123;</span>
<span class="line">     <span class="comment">// only redelivery_ack after first delivery</span></span>
<span class="line">     <span class="keyword">if</span> (currentRedeliveryCount &gt; <span class="number">0</span>) &#123;</span>
<span class="line">         MessageAck ack = <span class="keyword">new</span> MessageAck(lastMd, MessageAck.REDELIVERED_ACK_TYPE, deliveredMessages.size());</span>
<span class="line">         ack.setFirstMessageId(firstMsgId);</span>
<span class="line">         session.sendAck(ack,<span class="keyword">true</span>);</span>
<span class="line">     &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="重新投递的延迟时间计算"><a href="#重新投递的延迟时间计算" class="headerlink" title="重新投递的延迟时间计算"></a>重新投递的延迟时间计算</h4><figure class="highlight java"><figcaption><span>RedeliveryPolicy.getNextRedeliveryDelay</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">long</span> <span class="title">getNextRedeliveryDelay</span><span class="params">(<span class="keyword">long</span> previousDelay)</span> </span>&#123;</span>
<span class="line">   <span class="keyword">long</span> nextDelay = redeliveryDelay;</span>
<span class="line">   <span class="comment">//启用了 指数级延迟时间递增策略</span></span>
<span class="line">   <span class="keyword">if</span> (previousDelay &gt; <span class="number">0</span> &amp;&amp; useExponentialBackOff &amp;&amp; backOffMultiplier &gt; <span class="number">1</span>) &#123;</span>
<span class="line">       nextDelay = (<span class="keyword">long</span>) (previousDelay * backOffMultiplier);</span>
<span class="line">       <span class="keyword">if</span>(maximumRedeliveryDelay != -<span class="number">1</span> &amp;&amp; nextDelay &gt; maximumRedeliveryDelay) &#123;</span>
<span class="line">           <span class="comment">// in case the user made max redelivery delay less than redelivery delay for some reason.</span></span>
<span class="line">           nextDelay = Math.max(maximumRedeliveryDelay, redeliveryDelay);</span>
<span class="line">       &#125;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="comment">//  启用防止冲突功能, 计算一个随机的延迟时间</span></span>
<span class="line">   <span class="keyword">if</span> (useCollisionAvoidance) &#123;</span>
<span class="line">       <span class="comment">/*</span>
<span class="line">        * First random determines +/-, second random determines how far to</span>
<span class="line">        * go in that direction. -cgs</span>
<span class="line">        */</span></span>
<span class="line">       Random random = getRandomNumberGenerator();</span>
<span class="line">       <span class="keyword">double</span> variance = (random.nextBoolean() ? collisionAvoidanceFactor : -collisionAvoidanceFactor) * random.nextDouble();</span>
<span class="line">       nextDelay += nextDelay * variance;</span>
<span class="line">   &#125;</span>
<span class="line">   <span class="comment">//每次重新投递的延迟时间是固定的 </span></span>
<span class="line">   <span class="keyword">return</span> nextDelay;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://activemq.apache.org/redelivery-policy.html" target="_blank" rel="external">http://activemq.apache.org/redelivery-policy.html</a></p>
<p><a href="http://activemq.apache.org/message-redelivery-and-dlq-handling.html" target="_blank" rel="external">http://activemq.apache.org/message-redelivery-and-dlq-handling.html</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;在使用ActiveMQ时，配置了消息重发策略。 但因为对配置项的理解不够深刻，导致虽然消息重新被投递了，单因为时间间隔太小，最终被放入DLQ中。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;注意： 我使用的ActiveMQ版本是5.8&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h3 id=&quot;错误配置&quot;&gt;&lt;a href=&quot;#错误配置&quot; class=&quot;headerlink&quot; title=&quot;错误配置&quot;&gt;&lt;/a&gt;错误配置&lt;/h3&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;meta&quot;&gt;@Bean&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; RedeliveryPolicy &lt;span class=&quot;title&quot;&gt;redeliveryPolicy&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   RedeliveryPolicy redeliveryPolicy = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; RedeliveryPolicy();&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//是否在每次尝试重新发送失败后,增长这个等待时间&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setUseExponentialBackOff(&lt;span class=&quot;keyword&quot;&gt;true&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//重发次数,默认为6次   这里设置为10次&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setMaximumRedeliveries(&lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//重发时间间隔,默认为1秒&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setInitialRedeliveryDelay(&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//第一次失败后重新发送之前等待1秒,第二次失败再等待1 * 2秒,这里的2就是value&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setBackOffMultiplier(&lt;span class=&quot;number&quot;&gt;2&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//是否避免消息碰撞&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setUseCollisionAvoidance(&lt;span class=&quot;keyword&quot;&gt;false&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;comment&quot;&gt;//设置重发最大拖延时间-1 表示没有拖延只有UseExponentialBackOff(true)为true时生效&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   redeliveryPolicy.setMaximumRedeliveryDelay(-&lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;   &lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; redeliveryPolicy;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="ActiveMQ" scheme="https://leokongwq.github.io/tags/ActiveMQ/"/>
    
  </entry>
  
  <entry>
    <title>REST API 版本化</title>
    <link href="https://leokongwq.github.io/2018/05/15/rest-version.html"/>
    <id>https://leokongwq.github.io/2018/05/15/rest-version.html</id>
    <published>2018-05-15T12:46:21.000Z</published>
    <updated>2018-05-15T13:07:34.000Z</updated>
    
    <content type="html"><![CDATA[<p>要管理应用接口业务逻辑的复杂性，需要你对API进行版本管理。版本控制可帮助你在需要变更服务逻辑时快速迭代。</p>
<blockquote>
<p>随着系统业务发展或逻辑复杂度的不断提高，API的变化是不可避免的。 当变更会破坏现有系统客户端的集成时，管理这种变化的影响可能是相当大的挑战。</p>
</blockquote>
<h2 id="何时对REST-API进行版本化"><a href="#何时对REST-API进行版本化" class="headerlink" title="何时对REST API进行版本化"></a>何时对REST API进行版本化</h2><p>只有在重大破坏性变更发生时才考虑对API进行版本升级。破坏性变更包括：</p>
<ul>
<li>一次或多次调用的响应数据格式发生了变化</li>
<li>响应数据类型发生变化（例如，将整数变为浮点数）</li>
<li>删除API返回数据的部分内</li>
</ul>
<p>发生破坏性变更时，应该总是修改API的主版本号。</p>
<p>非破坏性变更（如添加新的REST端点或新的响应参数）不需要更改主版本号。 </p>
<a id="more"></a>
<h2 id="REST-API-版本号如何定义"><a href="#REST-API-版本号如何定义" class="headerlink" title="REST API 版本号如何定义"></a>REST API 版本号如何定义</h2><p>REST 没有提供任何关于API版本管理的指导规范，但是常用的实现方式有如下三种：</p>
<h3 id="在URI上包含版本号"><a href="#在URI上包含版本号" class="headerlink" title="在URI上包含版本号"></a>在URI上包含版本号</h3><p>使用URI是最直接的方法（也是最常用的方法），尽管它违背了URI应该引用唯一资源的原则。 当版本更新时，您也可以保证客户端的集成。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line">http://api.example.com/v1</span>
<span class="line">http://apiv1.example.com</span>
</pre></td></tr></table></figure>
<p>版本号不必是数字，也不必使用<code>v[x]</code>这样语法指定。 替代方案包括日期，项目名称，季节或其他标识符，这些标识符对于产生API的团队来说足够有意义，并且随着版本的变化足够灵活地进行更改。</p>
<h3 id="自定义请求头"><a href="#自定义请求头" class="headerlink" title="自定义请求头"></a>自定义请求头</h3><p>自定义请求头（例如<code>Accept-version</code>）允许你在版本之间保留URI，尽管它实际上是现有<code>Accept</code>头实现的内容协商行为的重复。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line">Accept-version: v1</span>
<span class="line">Accept-version: v2</span>
</pre></td></tr></table></figure>
<h3 id="使用请求头-Accept"><a href="#使用请求头-Accept" class="headerlink" title="使用请求头 Accept"></a>使用请求头 <code>Accept</code></h3><p>内容协商可能让你保留一组干净的URL，但你仍然必须处理在某处放置不同版本内容的复杂性。 这种负担往往会被上移到您的API控制器，这些控制器负责确定要发送的资源版本。 最终结果往往是更复杂的API，因为客户端在请求资源之前必须知道指定哪些头。</p>
<p>例如：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line">Accept: application/vnd.example.v1+json</span>
<span class="line">Accept: application/vnd.example+json;version=1.0</span>
</pre></td></tr></table></figure>
<p>在现实世界中，API永远不会变的完全稳定。 因此，如何管理这一变化非常重要。 对于大多数API而言，详细记录API的变更信息和逐渐废弃API是可行的方法。</p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;要管理应用接口业务逻辑的复杂性，需要你对API进行版本管理。版本控制可帮助你在需要变更服务逻辑时快速迭代。&lt;/p&gt;
&lt;blockquote&gt;
&lt;p&gt;随着系统业务发展或逻辑复杂度的不断提高，API的变化是不可避免的。 当变更会破坏现有系统客户端的集成时，管理这种变化的影响可能是相当大的挑战。&lt;/p&gt;
&lt;/blockquote&gt;
&lt;h2 id=&quot;何时对REST-API进行版本化&quot;&gt;&lt;a href=&quot;#何时对REST-API进行版本化&quot; class=&quot;headerlink&quot; title=&quot;何时对REST API进行版本化&quot;&gt;&lt;/a&gt;何时对REST API进行版本化&lt;/h2&gt;&lt;p&gt;只有在重大破坏性变更发生时才考虑对API进行版本升级。破坏性变更包括：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;一次或多次调用的响应数据格式发生了变化&lt;/li&gt;
&lt;li&gt;响应数据类型发生变化（例如，将整数变为浮点数）&lt;/li&gt;
&lt;li&gt;删除API返回数据的部分内&lt;/li&gt;
&lt;/ul&gt;
&lt;p&gt;发生破坏性变更时，应该总是修改API的主版本号。&lt;/p&gt;
&lt;p&gt;非破坏性变更（如添加新的REST端点或新的响应参数）不需要更改主版本号。 &lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="REST" scheme="https://leokongwq.github.io/tags/REST/"/>
    
  </entry>
  
  <entry>
    <title>SpringBoot应用部署模式</title>
    <link href="https://leokongwq.github.io/2018/05/15/spring-boot-deploy.html"/>
    <id>https://leokongwq.github.io/2018/05/15/spring-boot-deploy.html</id>
    <published>2018-05-15T09:32:00.000Z</published>
    <updated>2018-05-15T10:48:59.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>越来越多的人开始使用SpringBoot来实现项目的快速开发。每个团队都会面临一个同样的问题：如何部署SpringBoot应用？大部分人会想：这还需要考虑？当然是同步<code>Fat Jar</code>的方式部署喽。现实是残酷的！可能的原因有：</p>
<ul>
<li>已有的发布系统不支持</li>
<li>团队成员习惯了war包的部署方式</li>
<li>外置的Servlet容器更容易配置</li>
<li>文件路径相关的代码调整</li>
<li>其它原因</li>
</ul>
<a id="more"></a>
<p>SpringBoot 应用默认的打包结果是一个jar包。如果需要按照war包的形式进行部署，我们需要做如下的配置就能够实现。</p>
<h3 id="第一步-扩展-SpringBootServletInitializer"><a href="#第一步-扩展-SpringBootServletInitializer" class="headerlink" title="第一步 扩展 SpringBootServletInitializer"></a>第一步 扩展 SpringBootServletInitializer</h3><p><code>SpringBootServletInitializer</code>是一个实现<code>WebApplicationInitializer</code>接口的抽象类，它是servlet 3.0+环境的主要抽象，以便以编程方式配置ServletContext。 它将Servlet，Filter和ServletContextInitializer bean从应用程序上下文绑定到servlet容器。</p>
<h4 id="Main"><a href="#Main" class="headerlink" title="Main"></a>Main</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.websystique.springboot;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> org.springframework.boot.SpringApplication;</span>
<span class="line"><span class="keyword">import</span> org.springframework.boot.autoconfigure.SpringBootApplication;</span>
<span class="line"><span class="keyword">import</span> org.springframework.boot.builder.SpringApplicationBuilder;</span>
<span class="line"><span class="keyword">import</span> org.springframework.boot.web.support.SpringBootServletInitializer;</span>
<span class="line"> </span>
<span class="line"><span class="meta">@SpringBootApplication</span>(scanBasePackages=&#123;<span class="string">"com.websystique.springboot"</span>&#125;)<span class="comment">// same as @Configuration @EnableAutoConfiguration @ComponentScan</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringBootStandAloneWarApp</span> <span class="keyword">extends</span> <span class="title">SpringBootServletInitializer</span></span>&#123;</span>
<span class="line"> </span>
<span class="line">     </span>
<span class="line">    <span class="meta">@Override</span></span>
<span class="line">    <span class="function"><span class="keyword">protected</span> SpringApplicationBuilder <span class="title">configure</span><span class="params">(SpringApplicationBuilder application)</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> application.sources(SpringBootStandAloneWarApp .class);</span>
<span class="line">    &#125;</span>
<span class="line">     </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span>
<span class="line">        SpringApplication.run(SpringBootStandAloneWarApp.class, args);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="第二步-修改-Maven打包类型为’war’"><a href="#第二步-修改-Maven打包类型为’war’" class="headerlink" title="第二步 修改 Maven打包类型为’war’"></a>第二步 修改 Maven打包类型为’war’</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"&lt;a class="</span><span class="attr">vglnk</span>" <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>" xmlns:xsi="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>www<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>w3<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>2001<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>XMLSchema<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>instance<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"</span>
<span class="line">    xsi:schemaLocation="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"&gt;</span>
<span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.websystique.springboot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringBootStandAloneWarExample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span>
<span class="line">......</span>
</pre></td></tr></table></figure>
<h3 id="第三步-排除内嵌的Servlet容器"><a href="#第三步-排除内嵌的Servlet容器" class="headerlink" title="第三步 排除内嵌的Servlet容器"></a>第三步 排除内嵌的Servlet容器</h3><p>eg.</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h3 id="完整的pom文件"><a href="#完整的pom文件" class="headerlink" title="完整的pom文件"></a>完整的pom文件</h3><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"&lt;a class="</span><span class="attr">vglnk</span>" <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>" xmlns:xsi="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>www<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>w3<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>2001<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>XMLSchema<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>instance<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"</span>
<span class="line">    xsi:schemaLocation="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"&gt;</span>
<span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.websystique.springboot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringBootStandAloneWarExample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">startClass</span>&gt;</span>SpringBootStandAloneWarApp<span class="tag">&lt;/<span class="name">startClass</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span>
<span class="line">        <span class="comment">&lt;!-- Add typical dependencies for a web application --&gt;</span></span>
<span class="line">        <span class="comment">&lt;!-- Adds Tomcat and Spring MVC, along others --&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span>
<span class="line">                        <span class="comment">&lt;!-- this will get rid of version info from war file name --&gt;</span></span>
<span class="line">                    <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h3 id="打包"><a href="#打包" class="headerlink" title="打包"></a>打包</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">mvn clean package</span>
</pre></td></tr></table></figure>
<p>然后将war包部署到已有的Servlet容器中。</p>
<h3 id="同时支持jar和war类型"><a href="#同时支持jar和war类型" class="headerlink" title="同时支持jar和war类型"></a>同时支持jar和war类型</h3><p>上面的pom.xml配置能很好的支持war包类型的部署，但是在开发阶段我们还是希望通过Main方法的方式进行运行。此时我们可以通过Maven的profile功能实现。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
<span class="line">78</span>
<span class="line">79</span>
<span class="line">80</span>
<span class="line">81</span>
<span class="line">82</span>
<span class="line">83</span>
<span class="line">84</span>
<span class="line">85</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">project</span> <span class="attr">xmlns</span>=<span class="string">"&lt;a class="</span><span class="attr">vglnk</span>" <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>" xmlns:xsi="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>www<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>w3<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>2001<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>XMLSchema<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>instance<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"</span>
<span class="line">    xsi:schemaLocation="<span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/POM/4.0.0"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>POM<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span> <span class="tag">&lt;<span class="name">a</span> <span class="attr">class</span>=<span class="string">"vglnk"</span> <span class="attr">href</span>=<span class="string">"http://maven.apache.org/xsd/maven-4.0.0.xsd"</span> <span class="attr">rel</span>=<span class="string">"nofollow"</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>http<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>://<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>apache<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>org<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>/<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>maven<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>-<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>4<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>0<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>.<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;<span class="name">span</span>&gt;</span>xsd<span class="tag">&lt;/<span class="name">span</span>&gt;</span><span class="tag">&lt;/<span class="name">a</span>&gt;</span>"&gt;</span>
<span class="line">    <span class="tag">&lt;<span class="name">modelVersion</span>&gt;</span>4.0.0<span class="tag">&lt;/<span class="name">modelVersion</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>com.websystique.springboot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>SpringBootStandAloneWarExample<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.0.0<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;<span class="name">packaging</span>&gt;</span>$&#123;artifact-packaging&#125;<span class="tag">&lt;/<span class="name">packaging</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">name</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">name</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">parent</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-parent<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">parent</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">java.version</span>&gt;</span>1.8<span class="tag">&lt;/<span class="name">java.version</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">startClass</span>&gt;</span>SpringBootStandAloneWarApp<span class="tag">&lt;/<span class="name">startClass</span>&gt;</span></span>
<span class="line">        <span class="comment">&lt;!-- Additionally, Please make sure that your JAVA_HOME is pointing to </span>
<span class="line">            1.8 when building on commandline --&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span>
<span class="line">        <span class="comment">&lt;!-- Add typical dependencies for a web application --&gt;</span></span>
<span class="line">        <span class="comment">&lt;!-- Adds Tomcat and Spring MVC, along others --&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-web<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-freemarker<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">build</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span>
<span class="line"> </span>
<span class="line">    <span class="tag">&lt;<span class="name">profiles</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>local<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">activation</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">activeByDefault</span>&gt;</span>true<span class="tag">&lt;/<span class="name">activeByDefault</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">activation</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">artifact-packaging</span>&gt;</span>jar<span class="tag">&lt;/<span class="name">artifact-packaging</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">profile</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">id</span>&gt;</span>remote<span class="tag">&lt;/<span class="name">id</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">properties</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">artifact-packaging</span>&gt;</span>war<span class="tag">&lt;/<span class="name">artifact-packaging</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">properties</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">dependencies</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">dependency</span>&gt;</span></span>
<span class="line">                    <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">                    <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-starter-tomcat<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">                    <span class="tag">&lt;<span class="name">scope</span>&gt;</span>provided<span class="tag">&lt;/<span class="name">scope</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;/<span class="name">dependency</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">dependencies</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;<span class="name">build</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;<span class="name">plugins</span>&gt;</span></span>
<span class="line">                    <span class="tag">&lt;<span class="name">plugin</span>&gt;</span></span>
<span class="line">                        <span class="tag">&lt;<span class="name">groupId</span>&gt;</span>org.springframework.boot<span class="tag">&lt;/<span class="name">groupId</span>&gt;</span></span>
<span class="line">                        <span class="tag">&lt;<span class="name">artifactId</span>&gt;</span>spring-boot-maven-plugin<span class="tag">&lt;/<span class="name">artifactId</span>&gt;</span></span>
<span class="line">                        <span class="tag">&lt;<span class="name">version</span>&gt;</span>1.4.3.RELEASE<span class="tag">&lt;/<span class="name">version</span>&gt;</span></span>
<span class="line">                        <span class="tag">&lt;<span class="name">configuration</span>&gt;</span></span>
<span class="line">                                   <span class="comment">&lt;!-- this will get rid of version info from war file name --&gt;</span></span>
<span class="line">                            <span class="tag">&lt;<span class="name">finalName</span>&gt;</span>$&#123;project.artifactId&#125;<span class="tag">&lt;/<span class="name">finalName</span>&gt;</span></span>
<span class="line">                        <span class="tag">&lt;/<span class="name">configuration</span>&gt;</span></span>
<span class="line">                    <span class="tag">&lt;/<span class="name">plugin</span>&gt;</span></span>
<span class="line">                <span class="tag">&lt;/<span class="name">plugins</span>&gt;</span></span>
<span class="line">            <span class="tag">&lt;/<span class="name">build</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">profile</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">profiles</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">project</span>&gt;</span></span>
</pre></td></tr></table></figure>
<p>现在我们就可以在本地以FAT jar的方式运行。当发布到生产环境时以war的方式进行部署了。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;越来越多的人开始使用SpringBoot来实现项目的快速开发。每个团队都会面临一个同样的问题：如何部署SpringBoot应用？大部分人会想：这还需要考虑？当然是同步&lt;code&gt;Fat Jar&lt;/code&gt;的方式部署喽。现实是残酷的！可能的原因有：&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;已有的发布系统不支持&lt;/li&gt;
&lt;li&gt;团队成员习惯了war包的部署方式&lt;/li&gt;
&lt;li&gt;外置的Servlet容器更容易配置&lt;/li&gt;
&lt;li&gt;文件路径相关的代码调整&lt;/li&gt;
&lt;li&gt;其它原因&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>基于Spring构建RESTFUL风格的controller</title>
    <link href="https://leokongwq.github.io/2018/05/12/spring-rest-controller.html"/>
    <id>https://leokongwq.github.io/2018/05/12/spring-rest-controller.html</id>
    <published>2018-05-12T15:23:46.000Z</published>
    <updated>2018-05-30T08:42:42.000Z</updated>
    
    <content type="html"><![CDATA[<h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>Spring为开发REST服务提供一流的支持。在本文中，我们将使用Spring 4 <code>@RestController</code>注解开发基于Spring 4 MVC的RESTful JSON服务和RESTful XML服务。</p>
<p>Spring在内部使用<code>HttpMessageConverters</code>将响应转换为所需的格式[JSON / XML / etc ..]，这些格式基于类路径中可用的某些库，并可以选择使用请求中的<code>Accept Headers</code>。</p>
<p>为了服务JSON，我们将使用Jackson库[jackson-databind.jar]。 对于XML，我们将使用Jackson XML扩展[jackson-dataformat-xml.jar]。 只有在类路径中存在这些库才会触发Spring以所需格式转换输出。 此外，我们将进一步通过使用JAXB批注注释域类来支持XML，以防Jackson的XML扩展库由于某种原因而不可用。</p>
<p><strong>注意</strong>：如果你通过在浏览器中输入网址发送请求，则可以添加后缀[.xml / .json]，以帮助确定要提供的内容的类型。</p>
<a id="more"></a>
<blockquote>
<p>文章使用的是SpringBoot 1.5.2版本，并使用MAVEN3管理项目。</p>
</blockquote>
<h3 id="第一步-添加实体类"><a href="#第一步-添加实体类" class="headerlink" title="第一步 添加实体类"></a>第一步 添加实体类</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    String name;</span>
<span class="line">    String text;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(String name, String text)</span> </span>&#123;</span>
<span class="line">        <span class="keyword">this</span>.name = name;</span>
<span class="line">        <span class="keyword">this</span>.text = text;</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> name;</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getText</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> text;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="第二步-添加-Controller"><a href="#第二步-添加-Controller" class="headerlink" title="第二步 添加 Controller"></a>第二步 添加 Controller</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> com.websystique.springmvc.domain.Message;</span>
<span class="line"> </span>
<span class="line"><span class="meta">@RestController</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldRestController</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">welcome</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> <span class="string">"Welcome to RestTemplate Example."</span>;</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="meta">@RequestMapping</span>(<span class="string">"/hello/&#123;player&#125;"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> Message <span class="title">message</span><span class="params">(@PathVariable String player)</span> </span>&#123;</span>
<span class="line">        Message msg = <span class="keyword">new</span> Message(player, <span class="string">"Hello "</span> + player);</span>
<span class="line">        <span class="keyword">return</span> msg;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>如果jackson-dataformat-xml.jar不可用，并且您仍希望获得XML响应，则只需在模型类（Message）上添加JAXB注释，即可启用XML输出支持。 以下是相同的演示</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlElement;</span>
<span class="line"><span class="keyword">import</span> javax.xml.bind.annotation.XmlRootElement;</span>
<span class="line"></span>
<span class="line"><span class="meta">@XmlRootElement</span>(name = <span class="string">"player"</span>)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Message</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    String name;</span>
<span class="line">    String text;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">()</span></span>&#123;</span>
<span class="line">         </span>
<span class="line">    &#125;</span>
<span class="line">     </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="title">Message</span><span class="params">(String name, String text)</span> </span>&#123;</span>
<span class="line">        <span class="keyword">this</span>.name = name;</span>
<span class="line">        <span class="keyword">this</span>.text = text;</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="meta">@XmlElement</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getName</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> name;</span>
<span class="line">    &#125;</span>
<span class="line">     </span>
<span class="line">    <span class="meta">@XmlElement</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> String <span class="title">getText</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> text;</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>有了以上的准备，你可以通过下面的请求url来获取指定格式的响应：</p>
<h4 id="json"><a href="#json" class="headerlink" title="json"></a>json</h4><p><a href="http://127.0.0.1:2223/hello/tom" target="_blank" rel="external">http://127.0.0.1:2223/hello/tom</a><br><a href="http://127.0.0.1:2223/hello/tom.json" target="_blank" rel="external">http://127.0.0.1:2223/hello/tom.json</a></p>
<h4 id="xml"><a href="#xml" class="headerlink" title="xml"></a>xml</h4><p><a href="http://127.0.0.1:2223/hello/tom" target="_blank" rel="external">http://127.0.0.1:2223/hello/tom</a> 添加请求头 Accept:application/xml</p>
<p>或 </p>
<p><a href="http://127.0.0.1:2223/hello/tom.xml" target="_blank" rel="external">http://127.0.0.1:2223/hello/tom.xml</a></p>
<h3 id="ContentNegotiationStrategy"><a href="#ContentNegotiationStrategy" class="headerlink" title="ContentNegotiationStrategy"></a>ContentNegotiationStrategy</h3><p><code>ContentNegotiationStrategy</code>是一个策略接口，作用是将给定的请求解析为媒体类型（<code>MediaType</code>）列表。</p>
<p>它有两个重要的实现类，如下所示</p>
<h4 id="ServletPathExtensionContentNegotiationStrategy"><a href="#ServletPathExtensionContentNegotiationStrategy" class="headerlink" title="ServletPathExtensionContentNegotiationStrategy"></a>ServletPathExtensionContentNegotiationStrategy</h4><p>根据请求路径的扩展名来解析</p>
<h4 id="HeaderContentNegotiationStrategy"><a href="#HeaderContentNegotiationStrategy" class="headerlink" title="HeaderContentNegotiationStrategy"></a>HeaderContentNegotiationStrategy</h4><p>根据请求头<code>Accept</code>来解析</p>
<blockquote>
<p>Spring 在内部会根据请求的MediaType信息和HttpMessageConverter支持的MediaType进行匹配，如果能找到支持该请求的MediaType的HttpMessageConverter，则利用该HttpMessageConverter输出响应。</p>
</blockquote>
<h3 id="REST快速理解"><a href="#REST快速理解" class="headerlink" title="REST快速理解"></a>REST快速理解</h3><p>REST代表<code>Representational State Transfer</code>。它是一种可用于设计Web服务的架构风格，可从各种客户端使用。 其核心思想是，不使用诸如CORBA，RPC或SOAP之类的复杂机制来连接机器，而是使用简单的HTTP来进行调用。</p>
<p>在基于REST的设计中，对资源的操作是通过一组通用的动词来实现：</p>
<ul>
<li>创建资源：应该使用 HTTP POST</li>
<li>检索资源：应使用 HTTP GET</li>
<li>更新资源：应该使用 HTTP PUT</li>
<li>删除资源：应该使用 HTTP DELETE</li>
</ul>
<p>这意味着，作为REST服务开发人员或调用方，你应该遵守上述标准。</p>
<p>通常基于Rest的Web服务返回JSON或XML作为响应，尽管它不仅限于这些类型。 客户端可以指定（使用HTTP Accept头）他们感兴趣的资源类型，服务器可以返回资源，指定它正在服务的资源的Content-Type。 想要详细了解REST，这个<a href="https://stackoverflow.com/questions/671118/what-exactly-is-restful-programming" target="_blank" rel="external">StackOverflow</a>是必须要阅读的。</p>
<h3 id="RestController"><a href="#RestController" class="headerlink" title="RestController"></a>RestController</h3><p>以下是一个基于Rest的<code>Contrller</code>，实现了REST API。 </p>
<p>该<code>Contrller</code>是提供了如下的API：</p>
<ul>
<li>GET request to /api/user/ returns a list of users</li>
<li>GET request to /api/user/1 returns the user with ID 1</li>
<li>POST request to /api/user/ with a user object as JSON creates a new user</li>
<li>PUT request to /api/user/3 with a user object as JSON updates the user with ID 3</li>
<li>DELETE request to /api/user/4 deletes the user with ID 4</li>
<li>DELETE request to /api/user/ deletes all the users</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
<span class="line">78</span>
<span class="line">79</span>
<span class="line">80</span>
<span class="line">81</span>
<span class="line">82</span>
<span class="line">83</span>
<span class="line">84</span>
<span class="line">85</span>
<span class="line">86</span>
<span class="line">87</span>
<span class="line">88</span>
<span class="line">89</span>
<span class="line">90</span>
<span class="line">91</span>
<span class="line">92</span>
<span class="line">93</span>
<span class="line">94</span>
<span class="line">95</span>
<span class="line">96</span>
<span class="line">97</span>
<span class="line">98</span>
<span class="line">99</span>
<span class="line">100</span>
<span class="line">101</span>
<span class="line">102</span>
<span class="line">103</span>
<span class="line">104</span>
<span class="line">105</span>
<span class="line">106</span>
<span class="line">107</span>
<span class="line">108</span>
<span class="line">109</span>
<span class="line">110</span>
<span class="line">111</span>
<span class="line">112</span>
<span class="line">113</span>
<span class="line">114</span>
<span class="line">115</span>
<span class="line">116</span>
<span class="line">117</span>
<span class="line">118</span>
<span class="line">119</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.util.List;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> org.springframework.beans.factory.annotation.Autowired;</span>
<span class="line"><span class="keyword">import</span> org.springframework.http.HttpHeaders;</span>
<span class="line"><span class="keyword">import</span> org.springframework.http.HttpStatus;</span>
<span class="line"><span class="keyword">import</span> org.springframework.http.MediaType;</span>
<span class="line"><span class="keyword">import</span> org.springframework.http.ResponseEntity;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.PathVariable;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestBody;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMapping;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RequestMethod;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.bind.annotation.RestController;</span>
<span class="line"><span class="keyword">import</span> org.springframework.web.util.UriComponentsBuilder;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> com.websystique.springmvc.model.User;</span>
<span class="line"><span class="keyword">import</span> com.websystique.springmvc.service.UserService;</span>
<span class="line"> </span>
<span class="line"><span class="meta">@RestController</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">HelloWorldRestController</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="meta">@Autowired</span></span>
<span class="line">    UserService userService;  <span class="comment">//Service which will do all data retrieval/manipulation work</span></span>
<span class="line"> </span>
<span class="line">     </span>
<span class="line">    <span class="comment">//-------------------Retrieve All Users--------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/"</span>, method = RequestMethod.GET)</span>
<span class="line">    <span class="keyword">public</span> ResponseEntity&lt;List&lt;User&gt;&gt; listAllUsers() &#123;</span>
<span class="line">        List&lt;User&gt; users = userService.findAllUsers();</span>
<span class="line">        <span class="keyword">if</span>(users.isEmpty())&#123;</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;List&lt;User&gt;&gt;(HttpStatus.NO_CONTENT);<span class="comment">//You many decide to return HttpStatus.NOT_FOUND</span></span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;List&lt;User&gt;&gt;(users, HttpStatus.OK);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line">    <span class="comment">//-------------------Retrieve Single User--------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id&#125;"</span>, method = RequestMethod.GET, produces = MediaType.APPLICATION_JSON_VALUE)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title">getUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">long</span> id) </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Fetching User with id "</span> + id);</span>
<span class="line">        User user = userService.findById(id);</span>
<span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span>
<span class="line">            System.out.println(<span class="string">"User with id "</span> + id + <span class="string">" not found"</span>);</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(HttpStatus.NOT_FOUND);</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(user, HttpStatus.OK);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">     </span>
<span class="line">     </span>
<span class="line">    <span class="comment">//-------------------Create a User--------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/"</span>, method = RequestMethod.POST)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;Void&gt; <span class="title">createUser</span><span class="params">(@RequestBody User user,    UriComponentsBuilder ucBuilder)</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Creating User "</span> + user.getName());</span>
<span class="line"> </span>
<span class="line">        <span class="keyword">if</span> (userService.isUserExist(user)) &#123;</span>
<span class="line">            System.out.println(<span class="string">"A User with name "</span> + user.getName() + <span class="string">" already exist"</span>);</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Void&gt;(HttpStatus.CONFLICT);</span>
<span class="line">        &#125;</span>
<span class="line"> </span>
<span class="line">        userService.saveUser(user);</span>
<span class="line"> </span>
<span class="line">        HttpHeaders headers = <span class="keyword">new</span> HttpHeaders();</span>
<span class="line">        headers.setLocation(ucBuilder.path(<span class="string">"/user/&#123;id&#125;"</span>).buildAndExpand(user.getId()).toUri());</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;Void&gt;(headers, HttpStatus.CREATED);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">     </span>
<span class="line">    <span class="comment">//------------------- Update a User --------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id&#125;"</span>, method = RequestMethod.PUT)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title">updateUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">long</span> id, @RequestBody User user) </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Updating User "</span> + id);</span>
<span class="line">         </span>
<span class="line">        User currentUser = userService.findById(id);</span>
<span class="line">         </span>
<span class="line">        <span class="keyword">if</span> (currentUser==<span class="keyword">null</span>) &#123;</span>
<span class="line">            System.out.println(<span class="string">"User with id "</span> + id + <span class="string">" not found"</span>);</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(HttpStatus.NOT_FOUND);</span>
<span class="line">        &#125;</span>
<span class="line"> </span>
<span class="line">        currentUser.setName(user.getName());</span>
<span class="line">        currentUser.setAge(user.getAge());</span>
<span class="line">        currentUser.setSalary(user.getSalary());</span>
<span class="line">         </span>
<span class="line">        userService.updateUser(currentUser);</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(currentUser, HttpStatus.OK);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="comment">//------------------- Delete a User --------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/&#123;id&#125;"</span>, method = RequestMethod.DELETE)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title">deleteUser</span><span class="params">(@PathVariable(<span class="string">"id"</span>)</span> <span class="keyword">long</span> id) </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Fetching &amp; Deleting User with id "</span> + id);</span>
<span class="line"> </span>
<span class="line">        User user = userService.findById(id);</span>
<span class="line">        <span class="keyword">if</span> (user == <span class="keyword">null</span>) &#123;</span>
<span class="line">            System.out.println(<span class="string">"Unable to delete. User with id "</span> + id + <span class="string">" not found"</span>);</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(HttpStatus.NOT_FOUND);</span>
<span class="line">        &#125;</span>
<span class="line"> </span>
<span class="line">        userService.deleteUserById(id);</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(HttpStatus.NO_CONTENT);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">     </span>
<span class="line">    <span class="comment">//------------------- Delete All Users --------------------------------------------------------</span></span>
<span class="line">     </span>
<span class="line">    <span class="meta">@RequestMapping</span>(value = <span class="string">"/user/"</span>, method = RequestMethod.DELETE)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> ResponseEntity&lt;User&gt; <span class="title">deleteAllUsers</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Deleting All Users"</span>);</span>
<span class="line"> </span>
<span class="line">        userService.deleteAllUsers();</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> ResponseEntity&lt;User&gt;(HttpStatus.NO_CONTENT);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="详解"><a href="#详解" class="headerlink" title="详解"></a>详解</h4><ul>
<li>@RestController：首先，我们使用Spring 4的新的<code>@RestController</code>注解。此注释避免我们在每个方法上添加<code>@ResponseBody``注解。在Spring-MVC内部下，</code>@RestController<code>本身是用</code>@ResponseBody<code>注解的，可以被认为是</code>@Controller<code>和</code>@ResponseBody`的组合。</li>
<li>@RequestBody：如果一个方法参数使用<code>@RequestBody</code>进行注解，那么Spring会将传入的HTTP请求主体（针对该方法的@RequestMapping中提到的URL）绑定到该参数。原理是Spring内部使用<code>HttpMessageConverter</code>将HTTP请求体转换为域对象[将请求主体反序列化为域对象]，这是基于请求中存在的<code>ACCEPT</code>或<code>Content-Type</code>头。</li>
<li>@ResponseBody：如果一个方法用@ResponseBody注解，Spring会将返回值绑定到传出的HTTP响应正文。在这样做的过程中，Spring将在内部使用<code>HttpMessageConverter</code>将返回值转换为HTTP响应主体[将对象序列化到响应主体]，并基于请求HTTP头中的Content-Type。如前所述，在Spring 4中，你可能会停止使用此注释。</li>
<li>ResponseEntity 它代表整个HTTP响应。好的一点是你可以控制任何进入它的东西。你可以指定状态码，标题和正文。它带有几个构造函数来携带您想要在HTTP响应中发送的信息。</li>
<li>@PathVariable：这个注解表示一个方法参数应该绑定到一个URI模板变量[‘}’]。基本上，<code>@RestController</code>，<code>@RequestBody</code>，<code>ResponseEntity</code>和<code>@PathVariable</code>是你在Spring 4中实现一个REST API所需要知道的。另外，spring提供了几个支持类来帮助你实现一些自定义的东西。</li>
<li>MediaType：使用<code>@RequestMapping</code>注释，你可以另外指定要通过特定控制器方法生成或使用的<code>MediaType</code>（使用生成或消费属性），以进一步缩小映射范围。</li>
</ul>
<h3 id="使用RestTemplate编写REST客户端"><a href="#使用RestTemplate编写REST客户端" class="headerlink" title="使用RestTemplate编写REST客户端"></a>使用RestTemplate编写REST客户端</h3><p>PostMan是一个很棒用来测试Rest API的客户端。 但是，如果你想要在应用程序中调用基于REST的Web服务，则需要为你的应用程序提供REST客户端。 最受欢迎的HTTP客户端之一是Apache HttpComponents HttpClient。 但是，该客户端提供的功能过于基础，需要自己编写大量符合REST风格的代码。</p>
<p>Spring提供的RestTemplate提供了更高级别的方法，这些方法对应于六种主要的HTTP方法中的每一种，这些方法使得调用许多RESTful服务只需一行代码，并成为实施REST的最佳实践。</p>
<p>下面显示了HTTP方法和相应的RestTemplate方法来处理这种类型的HTTP请求。</p>
<p>HTTP 方法和 RestTemplate 方法对应关系:</p>
<ul>
<li>HTTP GET : getForObject, getForEntity</li>
<li>HTTP PUT : put(String url, Object request, String…​urlVariables)</li>
<li>HTTP DELETE : delete</li>
<li>HTTP POST : postForLocation(String url, Object request, String…​ urlVariables), postForObject(String url, Object request, Class responseType, String…​ uriVariables)</li>
<li>HTTP HEAD : headForHeaders(String url, String…​ urlVariables)</li>
<li>HTTP OPTIONS : optionsForAllow(String url, String…​ urlVariables)</li>
<li>HTTP PATCH and others : exchange execute</li>
</ul>
<h4 id="自定义REST客户端，使用先前创建的REST服务"><a href="#自定义REST客户端，使用先前创建的REST服务" class="headerlink" title="自定义REST客户端，使用先前创建的REST服务"></a>自定义REST客户端，使用先前创建的REST服务</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
<span class="line">78</span>
<span class="line">79</span>
<span class="line">80</span>
<span class="line">81</span>
<span class="line">82</span>
<span class="line">83</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> java.net.URI;</span>
<span class="line"><span class="keyword">import</span> java.util.LinkedHashMap;</span>
<span class="line"><span class="keyword">import</span> java.util.List;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> org.springframework.web.client.RestTemplate;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">import</span> com.websystique.springmvc.model.User;</span>
<span class="line"> </span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">SpringRestTestClient</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String REST_SERVICE_URI = <span class="string">"&lt;a class="</span>vglnk<span class="string">" href="</span>http:<span class="comment">//localhost:8080/Spring4MVCCRUDRestService" rel="nofollow"&gt;&lt;span&gt;http&lt;/span&gt;&lt;span&gt;://&lt;/span&gt;&lt;span&gt;localhost&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;8080&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;Spring4MVCCRUDRestService&lt;/span&gt;&lt;/a&gt;";</span></span>
<span class="line">     </span>
<span class="line">    <span class="comment">/* GET */</span></span>
<span class="line">    <span class="meta">@SuppressWarnings</span>(<span class="string">"unchecked"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">listAllUsers</span><span class="params">()</span></span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing listAllUsers API-----------"</span>);</span>
<span class="line">         </span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        List&lt;LinkedHashMap&lt;String, Object&gt;&gt; usersMap = restTemplate.getForObject(REST_SERVICE_URI+<span class="string">"/user/"</span>, List.class);</span>
<span class="line">         </span>
<span class="line">        <span class="keyword">if</span>(usersMap!=<span class="keyword">null</span>)&#123;</span>
<span class="line">            <span class="keyword">for</span>(LinkedHashMap&lt;String, Object&gt; map : usersMap)&#123;</span>
<span class="line">                System.out.println(<span class="string">"User : id="</span>+map.get(<span class="string">"id"</span>)+<span class="string">", Name="</span>+map.get(<span class="string">"name"</span>)+<span class="string">", Age="</span>+map.get(<span class="string">"age"</span>)+<span class="string">", Salary="</span>+map.get(<span class="string">"salary"</span>));;</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;<span class="keyword">else</span>&#123;</span>
<span class="line">            System.out.println(<span class="string">"No user exist----------"</span>);</span>
<span class="line">        &#125;</span>
<span class="line">    &#125;</span>
<span class="line">     </span>
<span class="line">    <span class="comment">/* GET */</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">getUser</span><span class="params">()</span></span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing getUser API----------"</span>);</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        User user = restTemplate.getForObject(REST_SERVICE_URI+<span class="string">"/user/1"</span>, User.class);</span>
<span class="line">        System.out.println(user);</span>
<span class="line">    &#125;</span>
<span class="line">     </span>
<span class="line">    <span class="comment">/* POST */</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">createUser</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing create User API----------"</span>);</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        User user = <span class="keyword">new</span> User(<span class="number">0</span>,<span class="string">"Sarah"</span>,<span class="number">51</span>,<span class="number">134</span>);</span>
<span class="line">        URI uri = restTemplate.postForLocation(REST_SERVICE_URI+<span class="string">"/user/"</span>, user, User.class);</span>
<span class="line">        System.out.println(<span class="string">"Location : "</span>+uri.toASCIIString());</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="comment">/* PUT */</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">updateUser</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing update User API----------"</span>);</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        User user  = <span class="keyword">new</span> User(<span class="number">1</span>,<span class="string">"Tomy"</span>,<span class="number">33</span>, <span class="number">70000</span>);</span>
<span class="line">        restTemplate.put(REST_SERVICE_URI+<span class="string">"/user/1"</span>, user);</span>
<span class="line">        System.out.println(user);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="comment">/* DELETE */</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteUser</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing delete User API----------"</span>);</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        restTemplate.delete(REST_SERVICE_URI+<span class="string">"/user/3"</span>);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line"> </span>
<span class="line">    <span class="comment">/* DELETE */</span></span>
<span class="line">    <span class="function"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">deleteAllUsers</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Testing all delete Users API----------"</span>);</span>
<span class="line">        RestTemplate restTemplate = <span class="keyword">new</span> RestTemplate();</span>
<span class="line">        restTemplate.delete(REST_SERVICE_URI+<span class="string">"/user/"</span>);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String args[])</span></span>&#123;</span>
<span class="line">        listAllUsers();</span>
<span class="line">        getUser();</span>
<span class="line">        createUser();</span>
<span class="line">        listAllUsers();</span>
<span class="line">        updateUser();</span>
<span class="line">        listAllUsers();</span>
<span class="line">        deleteUser();</span>
<span class="line">        listAllUsers();</span>
<span class="line">        deleteAllUsers();</span>
<span class="line">        listAllUsers();</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>输出：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
</pre></td><td class="code"><pre><span class="line">Testing listAllUsers API-----------</span>
<span class="line">User : id=1, Name=Sam, Age=30, Salary=70000.0</span>
<span class="line">User : id=2, Name=Tom, Age=40, Salary=50000.0</span>
<span class="line">User : id=3, Name=Jerome, Age=45, Salary=30000.0</span>
<span class="line">User : id=4, Name=Silvia, Age=50, Salary=40000.0</span>
<span class="line">Testing getUser API----------</span>
<span class="line">User [id=1, name=Sam, age=30, salary=70000.0]</span>
<span class="line">Testing create User API----------</span>
<span class="line">Location : &lt;a class=&quot;vglnk&quot; href=&quot;http://localhost:8080/Spring4MVCCRUDRestService/user/5&quot; rel=&quot;nofollow&quot;&gt;&lt;span&gt;http&lt;/span&gt;&lt;span&gt;://&lt;/span&gt;&lt;span&gt;localhost&lt;/span&gt;&lt;span&gt;:&lt;/span&gt;&lt;span&gt;8080&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;Spring4MVCCRUDRestService&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;user&lt;/span&gt;&lt;span&gt;/&lt;/span&gt;&lt;span&gt;5&lt;/span&gt;&lt;/a&gt;</span>
<span class="line">Testing listAllUsers API-----------</span>
<span class="line">User : id=1, Name=Sam, Age=30, Salary=70000.0</span>
<span class="line">User : id=2, Name=Tom, Age=40, Salary=50000.0</span>
<span class="line">User : id=3, Name=Jerome, Age=45, Salary=30000.0</span>
<span class="line">User : id=4, Name=Silvia, Age=50, Salary=40000.0</span>
<span class="line">User : id=5, Name=Sarah, Age=51, Salary=134.0</span>
<span class="line">Testing update User API----------</span>
<span class="line">User [id=1, name=Tomy, age=33, salary=70000.0]</span>
<span class="line">Testing listAllUsers API-----------</span>
<span class="line">User : id=1, Name=Tomy, Age=33, Salary=70000.0</span>
<span class="line">User : id=2, Name=Tom, Age=40, Salary=50000.0</span>
<span class="line">User : id=3, Name=Jerome, Age=45, Salary=30000.0</span>
<span class="line">User : id=4, Name=Silvia, Age=50, Salary=40000.0</span>
<span class="line">User : id=5, Name=Sarah, Age=51, Salary=134.0</span>
<span class="line">Testing delete User API----------</span>
<span class="line">Testing listAllUsers API-----------</span>
<span class="line">User : id=1, Name=Tomy, Age=33, Salary=70000.0</span>
<span class="line">User : id=2, Name=Tom, Age=40, Salary=50000.0</span>
<span class="line">User : id=4, Name=Silvia, Age=50, Salary=40000.0</span>
<span class="line">User : id=5, Name=Sarah, Age=51, Salary=134.0</span>
<span class="line">Testing all delete Users API----------</span>
<span class="line">Testing listAllUsers API-----------</span>
<span class="line">No user exist----------</span>
</pre></td></tr></table></figure>
<h3 id="REST-API-添加-CORS-支持"><a href="#REST-API-添加-CORS-支持" class="headerlink" title="REST API 添加 CORS 支持"></a>REST API 添加 CORS 支持</h3><p>在访问REST API时，您可能会面临有关同源策略的问题。</p>
<p>可能的错误如下：</p>
<ul>
<li>“no” Access-Control-Allow-Origin“标题出现在请求的资源上。 原因’<a href="http://127.0.0.1:8080&#39;因此不被允许访问。“或" target="_blank" rel="external">http://127.0.0.1:8080&#39;因此不被允许访问。“或</a></li>
<li>“XMLHttpRequest无法加载<code>http://abc.com/bla</code>。 原始<code>http：// localhost：12345</code>不被Access-Control-Allow-Origin允许。“在这种情况下很常见。</li>
</ul>
<p>解决方案是Cross-Origin Resource Sharing(跨源资源共享)。 基本上，在服务器端，我们可以返回额外的CORS访问控制头和响应，这最终将允许进一步的域间通信。</p>
<p>在Spring中，我们可以编写一个简单的过滤器，在每个响应中添加这些CORS特定的响应头信息。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> javax.servlet.Filter;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.FilterChain;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.FilterConfig;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.ServletException;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.ServletRequest;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.ServletResponse;</span>
<span class="line"><span class="keyword">import</span> javax.servlet.http.HttpServletResponse;</span>
<span class="line"> </span>
<span class="line"></span>
<span class="line"><span class="meta">@WebFilter</span> </span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CORSFilter</span> <span class="keyword">implements</span> <span class="title">Filter</span> </span>&#123;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">doFilter</span><span class="params">(ServletRequest req, ServletResponse res, FilterChain chain)</span> <span class="keyword">throws</span> IOException, ServletException </span>&#123;</span>
<span class="line">        System.out.println(<span class="string">"Filtering on..........................................................."</span>);</span>
<span class="line">        HttpServletResponse response = (HttpServletResponse) res;</span>
<span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Origin"</span>, <span class="string">"*"</span>);</span>
<span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Methods"</span>, <span class="string">"POST, GET, PUT, OPTIONS, DELETE"</span>);</span>
<span class="line">        response.setHeader(<span class="string">"Access-Control-Max-Age"</span>, <span class="string">"3600"</span>);</span>
<span class="line">        response.setHeader(<span class="string">"Access-Control-Allow-Headers"</span>, <span class="string">"x-requested-with"</span>);</span>
<span class="line">        chain.doFilter(req, res);</span>
<span class="line">    &#125;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">init</span><span class="params">(FilterConfig filterConfig)</span> </span>&#123;&#125;</span>
<span class="line"> </span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">destroy</span><span class="params">()</span> </span>&#123;&#125;</span>
<span class="line"> </span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="http://websystique.com/springmvc/spring-mvc-4-restful-web-services-crud-example-resttemplate/" target="_blank" rel="external">spring-mvc-4-restful-web-services-crud-example-resttemplate</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h3 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h3&gt;&lt;p&gt;Spring为开发REST服务提供一流的支持。在本文中，我们将使用Spring 4 &lt;code&gt;@RestController&lt;/code&gt;注解开发基于Spring 4 MVC的RESTful JSON服务和RESTful XML服务。&lt;/p&gt;
&lt;p&gt;Spring在内部使用&lt;code&gt;HttpMessageConverters&lt;/code&gt;将响应转换为所需的格式[JSON / XML / etc ..]，这些格式基于类路径中可用的某些库，并可以选择使用请求中的&lt;code&gt;Accept Headers&lt;/code&gt;。&lt;/p&gt;
&lt;p&gt;为了服务JSON，我们将使用Jackson库[jackson-databind.jar]。 对于XML，我们将使用Jackson XML扩展[jackson-dataformat-xml.jar]。 只有在类路径中存在这些库才会触发Spring以所需格式转换输出。 此外，我们将进一步通过使用JAXB批注注释域类来支持XML，以防Jackson的XML扩展库由于某种原因而不可用。&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;注意&lt;/strong&gt;：如果你通过在浏览器中输入网址发送请求，则可以添加后缀[.xml / .json]，以帮助确定要提供的内容的类型。&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>spring对缓存的支持及相关注解说明</title>
    <link href="https://leokongwq.github.io/2018/05/12/spring-cache.html"/>
    <id>https://leokongwq.github.io/2018/05/12/spring-cache.html</id>
    <published>2018-05-12T13:54:44.000Z</published>
    <updated>2018-05-12T15:21:37.000Z</updated>
    
    <content type="html"><![CDATA[<p>Spring 3.1 引入了基于注释（annotation）的缓存（cache）技术，但是它本质上不是一个具体的缓存实现方案（例如 EHCache 或者 OSCache），而是一个对缓存使用的抽象，通过在既有代码中添加少量它定义的各种annotation，即能够达到缓存方法的返回对象的效果。</p>
<p>Spring 的缓存技术还具备相当的灵活性，不仅能够使用 <code>SpEL（Spring Expression Language）</code>来定义缓存的 <code>key</code>和各种<code>condition</code>，还提供开箱即用的缓存临时存储方案，也支持和主流的专业缓存例如<code>EHCache</code>集成。</p>
<a id="more"></a>
<h3 id="一个例子"><a href="#一个例子" class="headerlink" title="一个例子"></a>一个例子</h3><p>先从一个例子来直观感受一下spring Cache 如何使用。</p>
<h4 id="相关类"><a href="#相关类" class="headerlink" title="相关类"></a>相关类</h4><figure class="highlight java"><figcaption><span>Product</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Data</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Product</span> </span>&#123;</span>
<span class="line">    <span class="keyword">private</span> Long id;</span>
<span class="line">    <span class="keyword">private</span> String name;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ProductDao</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ProductDao</span> <span class="keyword">extends</span> <span class="title">MongoRepository</span>&lt;<span class="title">Product</span>, <span class="title">Long</span>&gt; </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="function">User <span class="title">findById</span><span class="params">(Long id)</span></span>;</span>
<span class="line"></span>
<span class="line">    <span class="function">List&lt;User&gt; <span class="title">findByName</span><span class="params">(String name)</span></span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<figure class="highlight java"><figcaption><span>ProductService</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Service</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ProductService</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Resource</span></span>
<span class="line">    <span class="keyword">private</span> ProductDao productDao;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Cacheable</span>(cacheNames = &#123;<span class="string">"products"</span>&#125;, key = <span class="string">"#id"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> Product <span class="title">getProductById</span><span class="params">(Long id)</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> productDao.findById(id);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="说明"><a href="#说明" class="headerlink" title="说明"></a>说明</h4><p>方法<code>getProductById</code>上加了注解<code>@Cacheable</code>，表示该方法的返回值是可以被缓存的。</p>
<p>属性<code>cacheNames</code>或<code>value</code>作用相同，都是用来指定返回结果保存到哪个缓存中的，属性<code>key</code>用来指定缓存结果对应的<code>key</code>(缓存通常都是key-value结构）。在改例中，key是由参数<code>id</code>进行计算的。</p>
<h3 id="Cacheable-详解"><a href="#Cacheable-详解" class="headerlink" title="Cacheable 详解"></a>Cacheable 详解</h3><p><code>@Cacheable</code>注解是Spring Cache中最重要的注解，它的配置属性如下：</p>
<h4 id="value"><a href="#value" class="headerlink" title="value"></a>value</h4><p>指定方法返回结果保存到的缓存名称。作用和<code>cacheNames</code>相同。支持<code>数组</code>配置</p>
<h4 id="cacheNames"><a href="#cacheNames" class="headerlink" title="cacheNames"></a>cacheNames</h4><p>参考<code>value</code>属性解释</p>
<h4 id="key"><a href="#key" class="headerlink" title="key"></a>key</h4><p>属性<code>key</code>的类型是字符串，格式为<code>SpEL</code>表达式，用来动态计算缓存结果的<code>键</code>值。默认值为空，意味着所有的方法参数都会参与计算。</p>
<h4 id="keyGenerator"><a href="#keyGenerator" class="headerlink" title="keyGenerator"></a>keyGenerator</h4><p>该属性指定自定义<code>KeyGenerator</code>的Bean的名称。默认值为空，意味着使用<code>SimpleKeyGenerator</code></p>
<h4 id="cacheManager"><a href="#cacheManager" class="headerlink" title="cacheManager"></a>cacheManager</h4><p>类型为：<code>org.springframework.cache.CacheManager</code> 的bean的名称。该bean需要我们在spring配置文件中配置。在SpringBoot中，如果检测到有对应的缓存框架，则会自动配置一个名称为<code>cacheManager</code>的bean。</p>
<h4 id="cacheResolver"><a href="#cacheResolver" class="headerlink" title="cacheResolver"></a>cacheResolver</h4><p>类型为：<code>org.springframework.cache.interceptor.CacheResolver</code> 的bean的名称。</p>
<h4 id="condition"><a href="#condition" class="headerlink" title="condition"></a>condition</h4><p>类型为字符串，结果是SpEL表达式，指定缓存的条件。默认值为空字符串，意味着方法的返回值总是被缓存。</p>
<h4 id="unless"><a href="#unless" class="headerlink" title="unless"></a>unless</h4><p>类型为字符串，结果是SpEL表达式，和<code>condition</code>不同的是，该表示式是在方法调用会进行计算的，用来否决方法的缓存。默认是空字符串，意味着从来不否决缓存结果。</p>
<h4 id="sync"><a href="#sync" class="headerlink" title="sync"></a>sync</h4><p>类型是boolean，4.3版本开始支持。表示在多个线程同时<code>加载</code>同一个缓存key对应的资源时，是否进行同步。默认值为false。</p>
<p>如果设置为true, 则能避免重复加载。该属性的功能能否起作用取决于如下条件：</p>
<ol>
<li>不支持unless </li>
<li>只能指定一个缓存（cacheName取值唯一）</li>
<li>不能和其它缓存相关的操作进行组合</li>
</ol>
<h3 id="缓存key的计算规则"><a href="#缓存key的计算规则" class="headerlink" title="缓存key的计算规则"></a>缓存key的计算规则</h3><p>上面提到缓存<code>key</code>的格式为SpEL表达式。默认的计算规则如下：</p>
<ul>
<li>如果方法没有参数，则返回0</li>
<li>如果方法只有一个参数，则返回该参数。</li>
<li>如果方法有多余一个参数，则key的值由所有参数的hashcode计算而来。具体可以参考<code>SimpleKeyGenerator</code></li>
</ul>
<h3 id="KeyGenerator"><a href="#KeyGenerator" class="headerlink" title="KeyGenerator"></a>KeyGenerator</h3><p><code>KeyGenerator</code> 接口用来计算方法返回值对应的缓存键的值。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">KeyGenerator</span> </span>&#123;</span>
<span class="line">    <span class="function">Object <span class="title">generate</span><span class="params">(Object target, Method method, Object... params)</span></span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>spring默认提供了两个实现类：<code>DefaultKeyGenerator</code>（4.0版本开始不推荐使用） 和 <code>SimpleKeyGenerator</code>（默认使用）。</p>
<p>我们可以通过实现该接口自定义实现。</p>
<h3 id="key-SpEL-举例"><a href="#key-SpEL-举例" class="headerlink" title="key SpEL 举例"></a>key SpEL 举例</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value=<span class="string">"books"</span>, key=<span class="string">"#isbn"</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">@<span class="title">Cacheable</span><span class="params">(value=<span class="string">"books"</span>, key=<span class="string">"#isbn.rawNumber"</span>)</span></span>
<span class="line"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span>
<span class="line"></span>
<span class="line"></span>
<span class="line">@<span class="title">Cacheable</span><span class="params">(value=<span class="string">"books"</span>, key=<span class="string">"T(someType).hash(#isbn)"</span>)</span></span>
<span class="line"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn, <span class="keyword">boolean</span> checkWarehouse, <span class="keyword">boolean</span> includeUsed)</span></span></span>
</pre></td></tr></table></figure>
<p>SpEL语法可以参考：<a href="https://docs.spring.io/spring/docs/3.1.x/spring-framework-reference/html/expressions.html" target="_blank" rel="external">Chapter 7, Spring Expression Language (SpEL)</a></p>
<h3 id="条件缓存"><a href="#条件缓存" class="headerlink" title="条件缓存"></a>条件缓存</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Cacheable</span>(value=<span class="string">"book"</span>, condition=<span class="string">"#name.length &lt; 32"</span>)</span>
<span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(String name)</span></span></span>
</pre></td></tr></table></figure>
<h3 id="SpEL计算上下文"><a href="#SpEL计算上下文" class="headerlink" title="SpEL计算上下文"></a>SpEL计算上下文</h3><img src="/2018/05/12/spring-cache/SpEL-contect.jpg" alt="SpEL-contect.jpg" title="">
<h3 id="CachePut"><a href="#CachePut" class="headerlink" title="@CachePut"></a>@CachePut</h3><p>如果缓存需要更新，且不干扰方法的执行,可以使用注解<code>@CachePut</code>。<code>@CachePut</code>标注的方法在执行前不会去检查缓存中是否存在之前执行过的结果，而是每次都会执行该方法，并将执行结果以键值对的形式存入指定的缓存中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@CachePut</span>(cacheNames=<span class="string">"book"</span>, key=<span class="string">"#isbn"</span>)</span>
<span class="line"><span class="function"><span class="keyword">public</span> Book <span class="title">updateBook</span><span class="params">(ISBN isbn, BookDescriptor descriptor)</span></span></span>
</pre></td></tr></table></figure>
<p><strong>注意</strong>：应该避免@CachePut 和 @Cacheable同时使用的情况。</p>
<h3 id="CacheEvict"><a href="#CacheEvict" class="headerlink" title="@CacheEvict"></a>@CacheEvict</h3><p>spring cache不仅支持将数据缓存，还支持将缓存数据删除。此过程经常用于从缓存中清除过期或未使用的数据。<br><code>@CacheEvict</code>要求指定一个或多个缓存，使之都受影响。此外，还提供了一个额外的参数<code>allEntries</code> 。表示是否需要清除缓存中的所有元素。默认为<code>false</code>，表示不需要。当指定了<code>allEntries</code>为<code>true</code>时，Spring Cache将忽略指定的key。有的时候我们需要Cache一下清除所有的元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(cacheNames=<span class="string">"books"</span>, allEntries=<span class="keyword">true</span>)</span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBooks</span><span class="params">(InputStream batch)</span></span></span>
</pre></td></tr></table></figure>
<p>清除操作默认是在对应<strong>方法成功执行之后</strong>触发的，即方法如果因为抛出异常而未能成功返回时也不会触发清除操作。使用<code>beforeInvocation</code>可以改变触发清除操作的时间，当我们指定该属性值为true时，Spring会在调用该方法之前清除缓存中的指定元素。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheEvict</span>(cacheNames=<span class="string">"books"</span>, beforeInvocation=<span class="keyword">true</span>)</span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">loadBooks</span><span class="params">(InputStream batch)</span></span></span>
</pre></td></tr></table></figure>
<h3 id="CacheConfig"><a href="#CacheConfig" class="headerlink" title="@CacheConfig"></a>@CacheConfig</h3><p>有时候一个类中可能会有多个缓存操作，而这些缓存操作可能是重复的。这个时候可以使用@CacheConfig</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@CacheConfig</span>(<span class="string">"books"</span>)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookRepositoryImpl</span> <span class="keyword">implements</span> <span class="title">BookRepository</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Cacheable</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> Book <span class="title">findBook</span><span class="params">(ISBN isbn)</span> </span>&#123;...&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>@CacheConfig</code>是一个类级别的注解，允许共享缓存的名称、KeyGenerator、CacheManager 和CacheResolver。<br>该操作会被覆盖。</p>
<h3 id="开启缓存注解"><a href="#开启缓存注解" class="headerlink" title="开启缓存注解"></a>开启缓存注解</h3><p>java类配置：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="meta">@EnableCaching</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>XML 配置</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">beans</span> <span class="attr">xmlns</span>=<span class="string">"http://www.springframework.org/schema/beans"</span></span>
<span class="line">    <span class="attr">xmlns:xsi</span>=<span class="string">"http://www.w3.org/2001/XMLSchema-instance"</span></span>
<span class="line">    <span class="attr">xmlns:cache</span>=<span class="string">"http://www.springframework.org/schema/cache"</span></span>
<span class="line">    <span class="attr">xsi:schemaLocation</span>=<span class="string">"</span>
<span class="line">        http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd</span>
<span class="line">        http://www.springframework.org/schema/cache http://www.springframework.org/schema/cache/spring-cache.xsd"</span>&gt;</span></span>
<span class="line"></span>
<span class="line">        <span class="tag">&lt;<span class="name">cache:annotation-driven</span> /&gt;</span></span>
<span class="line"></span>
<span class="line"><span class="tag">&lt;/<span class="name">beans</span>&gt;</span></span>
</pre></td></tr></table></figure>
<h3 id="配置CacheManager"><a href="#配置CacheManager" class="headerlink" title="配置CacheManager"></a>配置CacheManager</h3><p>CacheManager是Spring定义的一个用来管理Cache的接口。Spring自身已经为我们提供了两种CacheManager的实现，一种是基于Java API的ConcurrentMap，另一种是基于第三方Cache实现——Ehcache，如果我们需要使用其它类型的缓存时，我们可以自己来实现Spring的CacheManager接口或AbstractCacheManager抽象类。下面分别来看看Spring已经为我们实现好了的两种CacheManager的配置示例。</p>
<h4 id="基于ConcurrentMap的配置"><a href="#基于ConcurrentMap的配置" class="headerlink" title="基于ConcurrentMap的配置"></a>基于ConcurrentMap的配置</h4><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
</pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.support.SimpleCacheManager"</span>&gt;</span></span>
<span class="line">     <span class="tag">&lt;<span class="name">property</span> <span class="attr">name</span>=<span class="string">"caches"</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">set</span>&gt;</span></span>
<span class="line">        <span class="tag">&lt;<span class="name">bean</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.concurrent.ConcurrentMapCacheFactoryBean"</span>    <span class="attr">p:name</span>=<span class="string">"xxx"</span>/&gt;</span></span>
<span class="line">        <span class="tag">&lt;/<span class="name">set</span>&gt;</span></span>
<span class="line">    <span class="tag">&lt;/<span class="name">property</span>&gt;</span></span>
<span class="line"><span class="tag">&lt;/<span class="name">bean</span>&gt;</span></span>
<span class="line">```  </span>
<span class="line"></span>
<span class="line">上面的配置使用的是一个SimpleCacheManager，其中包含一个名为“xxx”的ConcurrentMapCache。</span>
<span class="line"></span>
<span class="line">#### 基于Ehcache的配置</span>
<span class="line"> </span>
<span class="line"> ```xml</span>
<span class="line"> <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"cacheManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheCacheManager"</span> <span class="attr">p:cache-manager-ref</span>=<span class="string">"ehcacheManager"</span>/&gt;</span></span>
<span class="line"></span>
<span class="line">   <span class="tag">&lt;<span class="name">bean</span> <span class="attr">id</span>=<span class="string">"ehcacheManager"</span> <span class="attr">class</span>=<span class="string">"org.springframework.cache.ehcache.EhCacheManagerFactoryBean"</span> <span class="attr">p:config-location</span>=<span class="string">"ehcache-spring.xml"</span>/&gt;</span></span>
</pre></td></tr></table></figure>
<p>上面的配置使用了一个Spring提供的EhCacheCacheManager来生成一个Spring的CacheManager，其接收一个Ehcache的CacheManager，因为真正用来存入缓存数据的还是Ehcache。Ehcache的CacheManager是通过Spring提供的EhCacheManagerFactoryBean来生成的，其可以通过指定ehcache的配置文件位置来生成一个Ehcache的CacheManager。若未指定则将按照Ehcache的默认规则取classpath根路径下的ehcache.xml文件，若该文件也不存在，则获取Ehcache对应jar包中的ehcache-failsafe.xml文件作为配置文件。更多关于Ehcache的内容这里就不多说了，它不属于本文讨论的内容，欲了解更多关于Ehcache的内容可以参考我之前发布的Ehcache系列文章，也可以参考官方文档等。</p>
<h3 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h3><ul>
<li>通过少量的配置 annotation 注释即可使得既有代码支持缓存</li>
<li>支持开箱即用 Out-Of-The-Box，即不用安装和部署额外第三方组件即可使用缓存</li>
<li>支持 Spring Express Language，能使用对象的任何属性或者方法来定义缓存的 key 和 condition</li>
<li>支持 AspectJ，并通过其实现任何方法的缓存支持</li>
<li>支持自定义 key 和自定义缓存管理者，具有相当的灵活性和扩展性</li>
</ul>
<h3 id="资料"><a href="#资料" class="headerlink" title="资料"></a>资料</h3><p><a href="https://www.ibm.com/developerworks/cn/opensource/os-cn-spring-cache/" target="_blank" rel="external">https://www.ibm.com/developerworks/cn/opensource/os-cn-spring-cache/</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;Spring 3.1 引入了基于注释（annotation）的缓存（cache）技术，但是它本质上不是一个具体的缓存实现方案（例如 EHCache 或者 OSCache），而是一个对缓存使用的抽象，通过在既有代码中添加少量它定义的各种annotation，即能够达到缓存方法的返回对象的效果。&lt;/p&gt;
&lt;p&gt;Spring 的缓存技术还具备相当的灵活性，不仅能够使用 &lt;code&gt;SpEL（Spring Expression Language）&lt;/code&gt;来定义缓存的 &lt;code&gt;key&lt;/code&gt;和各种&lt;code&gt;condition&lt;/code&gt;，还提供开箱即用的缓存临时存储方案，也支持和主流的专业缓存例如&lt;code&gt;EHCache&lt;/code&gt;集成。&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>linux系统如何启动</title>
    <link href="https://leokongwq.github.io/2018/03/23/computer-booting-linux.html"/>
    <id>https://leokongwq.github.io/2018/03/23/computer-booting-linux.html</id>
    <published>2018-03-23T09:14:27.000Z</published>
    <updated>2018-05-13T15:36:32.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="背景知识"><a href="#背景知识" class="headerlink" title="背景知识"></a>背景知识</h2><h3 id="intel-CPU发展历史简介"><a href="#intel-CPU发展历史简介" class="headerlink" title="intel CPU发展历史简介"></a>intel CPU发展历史简介</h3><ul>
<li>1971年，Intel 发布了第一款的微处理器4004。它是一个<code>4位</code>的微处理器。</li>
<li>1972年，Intel 发布了第一款八位处理器8008。它是一个<code>8位</code>的微处理器，地址总线(address bus)是<code>14位</code>的，就是说可以访问到<code>16K</code>的内存空间。</li>
<li>1974年4月，Intel 发布了第二款八位处理器<code>8080</code>。它是8008是增强版，增加了几个累加器，使它可以访问<code>16位</code>(8+8)的内存地址，即<code>64K</code>范围内的地址空间。而且它也是公认的“第一款真正可用的微处理器”。8080的架构对8086产生了很大的影响，并且为 x86系列奠定了基础。</li>
<li>1976年开始设计，1978年中旬Intel 发布了8086。标志了x86王朝的开始。它是一款<code>16位</code>的微处理器，却被设计成可以访问<code>1MB</code>的内存（即<code>20位</code>的地址空间）</li>
<li>1982年，Intel 的80286面世了。它是第一款采用保护模式的x86微处理器。地址总线增加到<code>24</code>位使它可以访问到16M 的内存空间。</li>
<li>1985年，Intel 发布了80386。一个拥有32位的微处理器。并且地址总数(address bus)也是32位的，寻址能力大幅提高到4G。</li>
</ul>
<a id="more"></a>
<h3 id="内存寻址和管理"><a href="#内存寻址和管理" class="headerlink" title="内存寻址和管理"></a>内存寻址和管理</h3><p>所谓寻址就是CPU查找数据或待执行指令位置的过程。</p>
<p>在8080及以前的CPU中，内存寻址访问是绝对地址。就是<code>指令的地址即物理地址</code>，中间没有任何的转换。</p>
<p>8086中，地址总线为20位，也就是说寻址空间为1M。 但是CPU中“算术逻辑运算单元（ALU）”的宽度，即数据总线却只有16位，也就是可直接加以运算的指针长度是16位的。如何填补这个空隙呢？可能的解决方案有多种，例如，可以像一些8位CPU中那样，增设一些20位的指令专用于地址运算和操作，但是那样又会造成CPU内存结构的不均匀。又例如，当时的PDP－11小型机也是16位的，但是其内存管理单元（MMU）可以将16位的地址映射到24位的地址空间。受此启发，Intel设计了一种在当时看来不失为巧妙的方法，即分段的方法。</p>
<p>为了支持分段，Intel在8086 CPU中设置了四个段寄存器：CS、DS、SS和ES，分别用于可执行代码段、数据段、堆栈段及其它段。每个段寄存器都是<code>16</code>位的，对应于地址总线中的<code>高16位</code>。每条<code>访内</code>指令中的内部地址也都是<code>16位</code>的，但是在送上地址总线之前，CPU内部自动地把它与<code>某个段寄存器</code>中的内容相加。因为段寄存器中的内容对应于20位地址总线中的高16位(也就是把段寄存器左移4位)，所以相加时实际上是内存总线中的高12位与段寄存器中的16位相加，而低4位保留不变，这样就形成一个20位的实际地址，也就实现了从16位内存地址到20位实际地址的转换，或者叫“映射”。</p>
<p>这种寻址方式也就是所谓的<code>实模式</code>。</p>
<p>但在这种机制下，由段寄存器确定一个<code>基地址</code>，一个进程总是可以访问由此开始连续的64K字节地址空间，且<code>无法加以限制</code>。进一步，通过改变<code>段寄存器CS</code>的内容，这个进程可以随心所欲的访问内存中的任何一个单元，因此根本谈不上对系统和其它进程的保护。这就是<code>实模式</code>的最大缺点。也是后面引入<code>保护模式</code>的根本原因。</p>
<p>80286的地址总线增加到24位使它可以访问到16M的内存空间。即使是可访的地址空间增加了，但它的分段大小依然是64K（因为段偏移量的大小为16位）。</p>
<p>386是32位的CPU，数据、地址总线都是32位，因此寻址空间为4G。80386中对内存的管理有两种，一个是段式内存管理，一个是页式内存管理。</p>
<p>由于Intel是在16位CPU基础上涉及32位CPU的，因此在32位处理器中，它继承了段寄存器。由于寻址空间的增大，16位的段寄存器已不能够提供基地址了()。这样就引入了一个数据结构来描述关于段的一些信息（即<code>段描述符</code>）。当一个访存指令发出一个内存地址时，CPU按照下面过程实现从指令中的32位逻辑地址到32位物理地址的转换：</p>
<ol>
<li>首先根据指令的性质来确定该使用哪一个段寄存器。</li>
<li>根据段寄存器的内容，找到相应的<code>段描述结构</code>。</li>
<li>从<code>段描述结构</code>中得到<code>基地址</code>。</li>
<li>将指令中的地址作为位移，与段描述结构中规定的段长度相比，看是否越界；(基地址 + 偏移 是否大于规定的段长度)</li>
<li>根据指令的性质和段描述符中的访问权限来确定是否越权；</li>
<li>最后才将指令中的地址作为位移，与段基地址相加，得到物理地址。</li>
</ol>
<p>同时，在上面过程中，由于有对访问权限的检查，就实现了保护。</p>
<p>面提到的“段描述结构”实际就是段描述符。80386中有<code>两个寄存器</code>，分别是全局的段描述表寄存器(<code>GDTR</code>)和局部的段描述表寄存器(<code>LDTR</code>)，用来指向存储在内存中的某个段描述表。原段寄存器(指的是CS,DS,SS等寄存器)中的<code>高13位</code>指明某个段描述符在段描述表中的偏移，这个偏移加上GDTR（或LDTR）中段描述表的基地址，就得到段描述符的地址。最后从段描述子中得到段的32位基地址和长度以及其它的一些信息（这些信息包括关于越界和权限检查）。</p>
<p>段式内存管理只是386保护模式的一个部分，由于其效率的问题以及段是可变长度的，又发展出了页式内存管理。386处理器中有一个寄存器<code>CR0</code>，如果它的<code>PG</code>位为1，就打开了页式内存管理。</p>
<p>页式内存管理是在由段式内存管理形成的地址上再加上一层地址映射。此时由段式管理形成的地址就不再是物理地址了，而是“线性地址”。段式内存管理先把“逻辑地址”映射为“线性地址”，再由页式内存管理把“线性地址”映射为“物理地址”；当不使用页式内存管理时，“线性地址”就直接用作“物理地址”。</p>
<p>80386把内存分为4K的页面，每一个页面被映射到物理内存中任一块4K字节大小的空间（边界必须与4K字节对齐）。需要注意的是，在段式管理中，连续的逻辑地址经映射后在线性空间还是连续的，但连续的线性地址经映射后在物理空间却不一定连续。</p>
<p>页式内存管理中，32位的线性地址划分为三个部分：10位的页目录表下标、10位的页面表下标、12位的页内地址偏移(2的12次方字节刚好是4KB)。CPU增加了一个<code>CR3</code>寄存器存放指向当前页目录表的指针。寻址方式就改为：</p>
<ol>
<li>从<code>CR3</code>取得页目录表的基地址；</li>
<li>根据10位页目录表下标和1中得到的基地址，取得相应页面表的基地址；</li>
<li>根据10位页面表下标和2中得到的基地址，从页面表中取得相应的页面描述项；</li>
<li>将页面描述项中的页面基地址和线性地址中的12位页内偏移地址偏移相加，得到物理地址。</li>
</ol>
<p>同时，在地址转换的过程中也有越界和权限的检查，就不赘述了。</p>
<p>还有一个特例，就是所谓的<code>Flat（平坦）地址模式</code>，Linux内核就是采用这种模式的。它是在段式内存管理的基础上，如果每个段寄存器都指向同一个段描述子，而此段描述子中把段的基地址设为0，长度设为最大（4G），这样就形成了一个覆盖整个地址空间的巨大段。此时逻辑地址就和物理地址相同。形象的看，这样的地址就没有层次结构（段:偏移）了，所以叫做平坦模式，它是段式管理的特例。</p>
<h3 id="BIOS"><a href="#BIOS" class="headerlink" title="BIOS"></a>BIOS</h3><ol>
<li>80x86 系列CPU可以运行在16位<code>实模式</code>和32<code>保护模式下</code></li>
<li>80x86 系列CPU在加电时自动进入<code>实模式</code>，并且将代码段寄存器<code>CS</code>的值设为<code>0xFFFF</code>， 指令指针寄存器<code>IP</code>的值设置为<code>0x0000</code>。</li>
<li><code>实模式</code>下<code>IP</code>是16位的，并且地址是绝对地址。保护模式下，<code>EIP</code>的值是32位，并且地址是线下地址。</li>
<li>实模式下地址的计算是通过：<code>段地址 * 16 + 段偏移量</code>。 （都是从0开始计算）</li>
<li>实模式下的寻址空间为1M，也就是从 0x00000 - 0xFFFFF </li>
</ol>
<h3 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h3><ol>
<li>开解接通电源后，北桥芯片会向CPU发出一个<code>Reset</code>信号，让CPU复位初始化。<code>CS</code>寄存器和<code>IP</code>寄存器的值被分别设置为<code>0xFFFF</code>和<code>0x0000</code>。电源开始稳定供电后，芯片组便撤去<code>Reset</code>信号。CPU马上开始从绝对地址：<code>0xFFFF0</code>处开始执行。该地址其实是1M地址空间的最后16个字节处，并且就是BIOS程序所在的地址空间，放在这里的一般是一个跳转指令，跳到系统BIOS的真正开始代码处。</li>
</ol>
<h3 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h3><p><a href="https://my.oschina.net/wuying/blog/53419" target="_blank" rel="external">理解“统一编址与独立编址、I/O端口与I/O内存”</a><br><a href="http://www.eefocus.com/mcu-dsp/400488/r0" target="_blank" rel="external">处理器系列之寻址空间详解</a><br><a href="http://memorymyann.iteye.com/blog/188764" target="_blank" rel="external">intel80X86的实地址模式和保护模式</a><br><a href="http://www.cnblogs.com/driftsand/archive/2013/02/16/2913743.html" target="_blank" rel="external">计算机的内存分配</a><br><a href="https://blog.csdn.net/acmilanvanbasten/article/details/38852153" target="_blank" rel="external">BIOS 工作流程解析</a><br><a href="https://blog.csdn.net/liuyez123/article/details/51096914" target="_blank" rel="external">X86/X64处理器体系结构及寻址模式</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;背景知识&quot;&gt;&lt;a href=&quot;#背景知识&quot; class=&quot;headerlink&quot; title=&quot;背景知识&quot;&gt;&lt;/a&gt;背景知识&lt;/h2&gt;&lt;h3 id=&quot;intel-CPU发展历史简介&quot;&gt;&lt;a href=&quot;#intel-CPU发展历史简介&quot; class=&quot;headerlink&quot; title=&quot;intel CPU发展历史简介&quot;&gt;&lt;/a&gt;intel CPU发展历史简介&lt;/h3&gt;&lt;ul&gt;
&lt;li&gt;1971年，Intel 发布了第一款的微处理器4004。它是一个&lt;code&gt;4位&lt;/code&gt;的微处理器。&lt;/li&gt;
&lt;li&gt;1972年，Intel 发布了第一款八位处理器8008。它是一个&lt;code&gt;8位&lt;/code&gt;的微处理器，地址总线(address bus)是&lt;code&gt;14位&lt;/code&gt;的，就是说可以访问到&lt;code&gt;16K&lt;/code&gt;的内存空间。&lt;/li&gt;
&lt;li&gt;1974年4月，Intel 发布了第二款八位处理器&lt;code&gt;8080&lt;/code&gt;。它是8008是增强版，增加了几个累加器，使它可以访问&lt;code&gt;16位&lt;/code&gt;(8+8)的内存地址，即&lt;code&gt;64K&lt;/code&gt;范围内的地址空间。而且它也是公认的“第一款真正可用的微处理器”。8080的架构对8086产生了很大的影响，并且为 x86系列奠定了基础。&lt;/li&gt;
&lt;li&gt;1976年开始设计，1978年中旬Intel 发布了8086。标志了x86王朝的开始。它是一款&lt;code&gt;16位&lt;/code&gt;的微处理器，却被设计成可以访问&lt;code&gt;1MB&lt;/code&gt;的内存（即&lt;code&gt;20位&lt;/code&gt;的地址空间）&lt;/li&gt;
&lt;li&gt;1982年，Intel 的80286面世了。它是第一款采用保护模式的x86微处理器。地址总线增加到&lt;code&gt;24&lt;/code&gt;位使它可以访问到16M 的内存空间。&lt;/li&gt;
&lt;li&gt;1985年，Intel 发布了80386。一个拥有32位的微处理器。并且地址总数(address bus)也是32位的，寻址能力大幅提高到4G。&lt;/li&gt;
&lt;/ul&gt;
    
    </summary>
    
    
      <category term="linux" scheme="https://leokongwq.github.io/tags/linux/"/>
    
      <category term="computer" scheme="https://leokongwq.github.io/tags/computer/"/>
    
  </entry>
  
  <entry>
    <title>计算机是如何启动的</title>
    <link href="https://leokongwq.github.io/2018/03/21/computer-booting.html"/>
    <id>https://leokongwq.github.io/2018/03/21/computer-booting.html</id>
    <published>2018-03-21T06:28:17.000Z</published>
    <updated>2018-03-21T07:30:13.000Z</updated>
    
    <content type="html"><![CDATA[<p>本文转载自<a href="http://www.ruanyifeng.com/blog/2013/02/booting.html" target="_blank" rel="external">计算机是如何启动的？</a></p>
<h3 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h3><p>最近在学习<code>Linux内核完全剖析0.12</code>。前两章提到了计算机操作系统是如何加载的。因此想要复习下计算机的整个启动过程。在找相关资料的过程中发现了<a href="http://www.ruanyifeng.com/" target="_blank" rel="external">阮一峰前辈</a>写的文章。转载一下。</p>
<a id="more"></a>
<p>从打开电源到开始操作，计算机的启动是一个非常复杂的过程。</p>
<p>我一直搞不清楚，这个过程到底是怎么回事，只看见屏幕快速滚动各种提示…… 这几天，我查了一些资料，试图搞懂它。下面就是我整理的笔记。</p>
<h2 id="boot的含义"><a href="#boot的含义" class="headerlink" title="boot的含义"></a>boot的含义</h2><p>先问一个问题，”启动”用英语怎么说？</p>
<p>回答是<code>boot</code>。可是，<code>boot</code>原来的意思是靴子，”启动”与靴子有什么关系呢？ 原来，这里的boot是bootstrap（鞋带）的缩写，它来自一句谚语：</p>
<blockquote>
<p>“pull oneself up by one’s bootstraps”</p>
</blockquote>
<p>字面意思是”拽着鞋带把自己拉起来”，这当然是不可能的事情。最早的时候，工程师们用它来比喻，计算机启动是一个很矛盾的过程：必须先运行程序，然后计算机才能启动，但是计算机不启动就无法运行程序！</p>
<p>早期真的是这样，必须想尽各种办法，把一小段程序装进内存，然后计算机才能正常运行。所以，工程师们把这个过程叫做”拉鞋带”，久而久之就简称为boot了。</p>
<p>计算机的整个启动过程分成四个阶段。</p>
<h3 id="第一阶段：BIOS"><a href="#第一阶段：BIOS" class="headerlink" title="第一阶段：BIOS"></a>第一阶段：BIOS</h3><p>上个世纪70年代初，”只读内存”（read-only memory，缩写为ROM）发明，开机程序被刷入ROM芯片，计算机通电后，第一件事就是读取它。</p>
<img src="/2018/03/21/computer-booting/bg2013021502.jpg" alt="bg2013021502.jpg" title="">
<p>这块芯片里的程序叫做”基本輸出輸入系統”（Basic Input/Output System），简称为<a href="http://en.wikipedia.org/wiki/BIOS" target="_blank" rel="external">BIOS</a>。</p>
<h4 id="硬件自检"><a href="#硬件自检" class="headerlink" title="硬件自检"></a>硬件自检</h4><p>BIOS程序首先检查，计算机硬件能否满足运行的基本条件，这叫做<code>硬件自检</code>（Power-On Self-Test），缩写为POST。</p>
<p>如果硬件出现问题，主板会发出不同含义的蜂鸣，启动中止。如果没有问题，屏幕就会显示出CPU、内存、硬盘等信息。</p>
<img src="/2018/03/21/computer-booting/bg2013021503.png" alt="bg2013021503.png" title="">
<h4 id="启动顺序"><a href="#启动顺序" class="headerlink" title="启动顺序"></a>启动顺序</h4><p>硬件自检完成后，BIOS把控制权转交给下一阶段的启动程序。</p>
<p>这时，BIOS需要知道，”下一阶段的启动程序”具体存放在哪一个设备。也就是说，BIOS需要有一个外部储存设备的排序，排在前面的设备就是优先转交控制权的设备。这种排序叫做<code>启动顺序</code>（Boot Sequence）。</p>
<p>打开BIOS的操作界面，里面有一项就是”设定启动顺序”。</p>
<img src="/2018/03/21/computer-booting/bg2013021504.jpg" alt="bg2013021504.jpg" title="">
<h3 id="第二阶段：主引导记录"><a href="#第二阶段：主引导记录" class="headerlink" title="第二阶段：主引导记录"></a>第二阶段：主引导记录</h3><p>BIOS按照”启动顺序”，把控制权转交给排在第一位的储存设备。</p>
<p>这时，计算机读取该设备的<code>第一个扇区</code>，也就是读取最前面的<code>512</code>个字节。如果这512个字节的最后两个字节是<code>0x55</code>和<code>0xAA</code>，表明这个设备可以用于启动；如果不是，表明设备不能用于启动，控制权于是被转交给”启动顺序”中的下一个设备。</p>
<p>这最前面的512个字节，就叫做<code>主引导记录</code>（Master boot record，缩写为MBR）。</p>
<h4 id="主引导记录的结构"><a href="#主引导记录的结构" class="headerlink" title="主引导记录的结构"></a>主引导记录的结构</h4><p>“主引导记录”只有512个字节，放不了太多东西。它的主要作用是，告诉计算机到硬盘的哪一个位置去找操作系统。</p>
<p>主引导记录由三个部分组成：</p>
<ul>
<li>第1-446字节：调用操作系统的机器码。</li>
<li>第447-510字节：分区表（Partition table）。</li>
<li>第511-512字节：主引导记录签名（0x55和0xAA）。</li>
</ul>
<p>其中，第二部分”分区表”的作用，是将硬盘分成若干个区。</p>
<h4 id="分区表"><a href="#分区表" class="headerlink" title="分区表"></a>分区表</h4><p>硬盘分区有很多好处。考虑到每个区可以安装不同的操作系统，”主引导记录” 因此必须知道将控制权转交给哪个区。</p>
<p>分区表的长度只有<code>64</code>个字节，里面又分成<code>四项</code>，每项<code>16</code>个字节。所以，一个硬盘最多只能分四个一级分区，又叫做<code>主分区</code>。</p>
<p>每个主分区的16个字节，由6个部分组成：</p>
<ul>
<li>第1个字节：如果为0x80，就表示该主分区是激活分区，控制权要转交给这个分区。四个主分区里面<code>只能有一个</code>是激活的。</li>
<li>第2-4个字节：主分区第一个扇区的物理位置（柱面、磁头、扇区号等等）。</li>
<li>第5个字节：主分区类型。</li>
<li>第6-8个字节：主分区最后一个扇区的物理位置。</li>
<li>第9-12字节：该主分区第一个扇区的逻辑地址。</li>
<li>第13-16字节：主分区的扇区总数。</li>
</ul>
<p>最后的四个字节（”主分区的扇区总数”），决定了这个主分区的长度。也就是说，一个主分区的扇区总数最多不超过2的32次方。</p>
<p>如果每个扇区为512个字节，就意味着单个分区最大不超过2TB。再考虑到扇区的逻辑地址也是32位，所以单个硬盘可利用的空间最大也不超过2TB。如果想使用更大的硬盘，只有2个方法：一是提高每个扇区的字节数，二是增加扇区总数。</p>
<h3 id="第三阶段：硬盘启动"><a href="#第三阶段：硬盘启动" class="headerlink" title="第三阶段：硬盘启动"></a>第三阶段：硬盘启动</h3><p>这时，计算机的控制权就要转交给硬盘的某个分区了，这里又分成三种情况。</p>
<h4 id="情况A：卷引导记录"><a href="#情况A：卷引导记录" class="headerlink" title="情况A：卷引导记录"></a>情况A：卷引导记录</h4><p>上一节提到，四个主分区里面，只有一个是激活的。计算机会读取激活分区的第一个扇区，叫做<a href="http://en.wikipedia.org/wiki/Volume_Boot_Record" target="_blank" rel="external"><code>卷引导记录</code></a>（Volume boot record，缩写为<code>VBR</code>）。</p>
<p>“卷引导记录”的主要作用是，告诉计算机，操作系统在这个分区里的位置。然后，计算机就会加载操作系统了。</p>
<h4 id="情况B：扩展分区和逻辑分区"><a href="#情况B：扩展分区和逻辑分区" class="headerlink" title="情况B：扩展分区和逻辑分区"></a>情况B：扩展分区和逻辑分区</h4><p>随着硬盘越来越大，四个主分区已经不够了，需要更多的分区。但是，分区表只有四项，因此规定有且仅有一个区可以被定义成<code>扩展分区</code>（Extended partition）。</p>
<p>所谓<code>扩展分区</code>，就是指这个区里面又分成多个区。这种分区里面的分区，就叫做<code>逻辑分区</code>（logical partition）。</p>
<p>计算机先读取扩展分区的第一个扇区，叫做<a href="http://en.wikipedia.org/wiki/Extended_partition" target="_blank" rel="external">扩展引导记录</a>（Extended boot record，缩写为EBR）。它里面也包含一张64字节的分区表，但是最多只有两项（也就是两个逻辑分区）。</p>
<p>计算机接着读取第二个逻辑分区的第一个扇区，再从里面的分区表中找到第三个逻辑分区的位置，以此类推，直到某个逻辑分区的分区表只包含它自身为止（即只有一个分区项）。因此，扩展分区可以包含无数个逻辑分区。</p>
<p>但是，似乎很少通过这种方式启动操作系统。如果操作系统确实安装在扩展分区，一般采用下一种方式启动。</p>
<h4 id="情况C：启动管理器"><a href="#情况C：启动管理器" class="headerlink" title="情况C：启动管理器"></a>情况C：启动管理器</h4><p>在这种情况下，计算机读取”主引导记录”前面446字节的机器码之后，不再把控制权转交给某一个分区，而是运行事先安装的<a href="http://en.wikipedia.org/wiki/Boot_loader#Modern_boot_loaders" target="_blank" rel="external">启动管理器</a>（boot loader），由用户选择启动哪一个操作系统。</p>
<p>Linux环境中，目前最流行的启动管理器是<a href="http://en.wikipedia.org/wiki/GNU_GRUB" target="_blank" rel="external"><code>Grub</code></a>。</p>
<img src="/2018/03/21/computer-booting/bg2013021505.png" alt="bg2013021505.png" title="">
<h3 id="第四阶段：操作系统"><a href="#第四阶段：操作系统" class="headerlink" title="第四阶段：操作系统"></a>第四阶段：操作系统</h3><p>控制权转交给操作系统后，操作系统的内核首先被载入内存。</p>
<p>以Linux系统为例，先载入/boot目录下面的kernel。内核加载成功后，第一个运行的程序是/sbin/init。它根据配置文件（Debian系统是/etc/initab）产生init进程。这是Linux启动后的第一个进程，pid进程编号为1，其他进程都是它的后代。</p>
<p>然后，init线程加载系统的各个模块，比如窗口程序和网络程序，直至执行/bin/login程序，跳出登录界面，等待用户输入用户名和密码。</p>
<p>至此，全部启动过程完成。</p>
<h3 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h3><p><a href="http://en.wikipedia.org/wiki/Booting#Modern_boot_loaders" target="_blank" rel="external">维基百科:引导程序</a></p>
<p><a href="http://www.ibm.com/developerworks/cn/linux/l-bootload.html" target="_blank" rel="external">引导加载程序之争：了解 LILO 和 GRUB</a></p>
<p><a href="https://wiki.deepin.org/index.php?title=%E7%B3%BB%E7%BB%9F%E5%BC%95%E5%AF%BC%E5%99%A8&amp;action=edit" target="_blank" rel="external">系统引导器</a></p>
<p><a href="https://zh.wikipedia.org/wiki/GNU_GRUB" target="_blank" rel="external">GNU GRUB</a></p>
]]></content>
    
    <summary type="html">
    
      &lt;p&gt;本文转载自&lt;a href=&quot;http://www.ruanyifeng.com/blog/2013/02/booting.html&quot;&gt;计算机是如何启动的？&lt;/a&gt;&lt;/p&gt;
&lt;h3 id=&quot;背景&quot;&gt;&lt;a href=&quot;#背景&quot; class=&quot;headerlink&quot; title=&quot;背景&quot;&gt;&lt;/a&gt;背景&lt;/h3&gt;&lt;p&gt;最近在学习&lt;code&gt;Linux内核完全剖析0.12&lt;/code&gt;。前两章提到了计算机操作系统是如何加载的。因此想要复习下计算机的整个启动过程。在找相关资料的过程中发现了&lt;a href=&quot;http://www.ruanyifeng.com/&quot;&gt;阮一峰前辈&lt;/a&gt;写的文章。转载一下。&lt;/p&gt;
    
    </summary>
    
    
      <category term="OS" scheme="https://leokongwq.github.io/tags/OS/"/>
    
  </entry>
  
  <entry>
    <title>spring扩展点及springboot自动配置总结</title>
    <link href="https://leokongwq.github.io/2018/03/06/spring-extension-point-autoconfig-summary.html"/>
    <id>https://leokongwq.github.io/2018/03/06/spring-extension-point-autoconfig-summary.html</id>
    <published>2018-03-06T14:57:35.000Z</published>
    <updated>2018-05-15T10:49:37.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="spring扩展点和自动配置"><a href="#spring扩展点和自动配置" class="headerlink" title="spring扩展点和自动配置"></a>spring扩展点和自动配置</h2><h3 id="BeanFactoryPostProcessor"><a href="#BeanFactoryPostProcessor" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;  </span>
<span class="line">  </span>
<span class="line">    <span class="comment">/** </span>
<span class="line">     * Modify the application context's internal bean factory after its standard </span>
<span class="line">     * initialization. All bean definitions will have been loaded, but no beans </span>
<span class="line">     * will have been instantiated yet. This allows for overriding or adding </span>
<span class="line">     * properties even to eager-initializing beans. </span>
<span class="line">     * <span class="doctag">@param</span> beanFactory the bean factory used by the application context </span>
<span class="line">     * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors </span>
<span class="line">     */</span>  </span>
<span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException</span>;  </span>
<span class="line">  </span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>通过该扩展点，我们修改，新增<code>BeanDefinition</code>。因为此时所有的<code>BeanDefinition</code>已经加载，但是没有Bean被创建。一般用在需要覆盖或替换Bean的属性时。</p>
<a id="more"></a>
<p>spring中，有内置的一些BeanFactoryPostProcessor实现类，常用的有：</p>
<ul>
<li>org.springframework.beans.factory.config.PropertyPlaceholderConfigurer</li>
<li>org.springframework.beans.factory.config.PropertyOverrideConfigurer</li>
<li>org.springframework.beans.factory.config.CustomEditorConfigurer：用来注册自定义的属性编辑器</li>
</ul>
<h3 id="BeanFactoryPostProcessor-1"><a href="#BeanFactoryPostProcessor-1" class="headerlink" title="BeanFactoryPostProcessor"></a>BeanFactoryPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanPostProcessor</span> </span>&#123;</span>
<span class="line"></span>
<span class="line"><span class="comment">/**</span>
<span class="line"> * Apply this BeanPostProcessor to the given new bean instance &lt;i&gt;before&lt;/i&gt; any bean</span>
<span class="line"> * initialization callbacks (like InitializingBean's &#123;<span class="doctag">@code</span> afterPropertiesSet&#125;</span>
<span class="line"> * or a custom init-method). The bean will already be populated with property values.</span>
<span class="line"> * The returned bean instance may be a wrapper around the original.</span>
<span class="line"> * <span class="doctag">@param</span> bean the new bean instance</span>
<span class="line"> * <span class="doctag">@param</span> beanName the name of the bean</span>
<span class="line"> * <span class="doctag">@return</span> the bean instance to use, either the original or a wrapped one;</span>
<span class="line"> * if &#123;<span class="doctag">@code</span> null&#125;, no subsequent BeanPostProcessors will be invoked</span>
<span class="line"> * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span>
<span class="line"> * <span class="doctag">@see</span> org.springframework.beans.factory.InitializingBean#afterPropertiesSet</span>
<span class="line"> */</span></span>
<span class="line"><span class="function">Object <span class="title">postProcessBeforeInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException</span>;</span>
<span class="line"></span>
<span class="line"><span class="comment">/**</span>
<span class="line"> * Apply this BeanPostProcessor to the given new bean instance &lt;i&gt;after&lt;/i&gt; any bean</span>
<span class="line"> * initialization callbacks (like InitializingBean's &#123;<span class="doctag">@code</span> afterPropertiesSet&#125;</span>
<span class="line"> * or a custom init-method). The bean will already be populated with property values.</span>
<span class="line"> * The returned bean instance may be a wrapper around the original.</span>
<span class="line"> * &lt;p&gt;In case of a FactoryBean, this callback will be invoked for both the FactoryBean</span>
<span class="line"> * instance and the objects created by the FactoryBean (as of Spring 2.0). The</span>
<span class="line"> * post-processor can decide whether to apply to either the FactoryBean or created</span>
<span class="line"> * objects or both through corresponding &#123;<span class="doctag">@code</span> bean instanceof FactoryBean&#125; checks.</span>
<span class="line"> * &lt;p&gt;This callback will also be invoked after a short-circuiting triggered by a</span>
<span class="line"> * &#123;<span class="doctag">@link</span> InstantiationAwareBeanPostProcessor#postProcessBeforeInstantiation&#125; method,</span>
<span class="line"> * in contrast to all other BeanPostProcessor callbacks.</span>
<span class="line"> * <span class="doctag">@param</span> bean the new bean instance</span>
<span class="line"> * <span class="doctag">@param</span> beanName the name of the bean</span>
<span class="line"> * <span class="doctag">@return</span> the bean instance to use, either the original or a wrapped one;</span>
<span class="line"> * if &#123;<span class="doctag">@code</span> null&#125;, no subsequent BeanPostProcessors will be invoked</span>
<span class="line"> * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span>
<span class="line"> * <span class="doctag">@see</span> org.springframework.beans.factory.InitializingBean#afterPropertiesSet</span>
<span class="line"> * <span class="doctag">@see</span> org.springframework.beans.factory.FactoryBean</span>
<span class="line"> */</span></span>
<span class="line"><span class="function">Object <span class="title">postProcessAfterInitialization</span><span class="params">(Object bean, String beanName)</span> <span class="keyword">throws</span> BeansException</span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>该扩展点提供了两个方法：</p>
<ol>
<li>是在Bean新创建后，未初始化前调用的。例如在<code>InitializingBean</code>的<code>afterPropertiesSet</code>前，或则自定义的<code>init-method</code>前。</li>
<li>在Bean初始化后，调用方法<code>postProcessAfterInitialization</code>。</li>
</ol>
<p>spring中，有内置的一些BeanPostProcessor实现类，例如：</p>
<ul>
<li>org.springframework.context.annotation.CommonAnnotationBeanPostProcessor：支持@Resource注解的注入</li>
<li>org.springframework.beans.factory.annotation.RequiredAnnotationBeanPostProcessor：支持@Required注解的注入</li>
<li>org.springframework.beans.factory.annotation.AutowiredAnnotationBeanPostProcessor：支持@Autowired注解的注入</li>
<li>org.springframework.orm.jpa.support.PersistenceAnnotationBeanPostProcessor：支持@PersistenceUnit和@PersistenceContext注解的注入</li>
<li>org.springframework.context.support.ApplicationContextAwareProcessor：用来为bean注入ApplicationContext等容器对象</li>
</ul>
<p>spring提供的这些Bean都可以通过<code>&lt;context:annotation-config/&gt;</code> 来自动进行配置。</p>
<p>不过我们一般都会配置包扫描：<code>&lt;context:component-scan base-package=”xx.yy.zz”/&gt;</code>，该配置已经包含了:<code>&lt;context:annotation-config/&gt;</code>。</p>
<h3 id="Configuration"><a href="#Configuration" class="headerlink" title="@Configuration"></a>@Configuration</h3><blockquote>
<p>Indicates that a class declares one or more {@link Bean @Bean} methods and<br>  may be processed by the Spring container to generate bean definitions and<br>  service requests for those beans at runtime, for example:</p>
</blockquote>
<p><code>@Configuration</code>是spring3.0引入的新注解。该注解主要用来为spring容器提供<code>BeanDefinition</code>和在运行时提供其它Bean所需要的Bean。</p>
<p>举个例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AppConfig</span> </span>&#123;</span>
<span class="line">    </span>
<span class="line">    <span class="meta">@Inject</span></span>
<span class="line">    <span class="keyword">private</span> DataSource dataSource;</span>
<span class="line">    </span>
<span class="line">    <span class="meta">@Bean</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> MyBean <span class="title">myBean</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        <span class="keyword">return</span> <span class="keyword">new</span> MyBean(dataSource);</span>
<span class="line">    &#125;</span>
<span class="line">    </span>
<span class="line">    <span class="meta">@Configuration</span></span>
<span class="line">    <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span>
<span class="line">        <span class="meta">@Bean</span></span>
<span class="line">        <span class="function">DataSource <span class="title">dataSource</span><span class="params">()</span> </span>&#123;</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> EmbeddedDatabaseBuilder().build();</span>
<span class="line">        &#125;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="springboot自动配置"><a href="#springboot自动配置" class="headerlink" title="springboot自动配置"></a>springboot自动配置</h2><h3 id="EnableAutoConfiguration"><a href="#EnableAutoConfiguration" class="headerlink" title="@EnableAutoConfiguration"></a>@EnableAutoConfiguration</h3><p>要想使用springboot提供的自动配置功能，必须在你工程的启动主类上添加注解<code>@EnableAutoConfiguration</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="meta">@Inherited</span></span>
<span class="line"><span class="meta">@AutoConfigurationPackage</span></span>
<span class="line"><span class="meta">@Import</span>(EnableAutoConfigurationImportSelector.class)</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableAutoConfiguration &#123;</span>
<span class="line"></span>
<span class="line">	String ENABLED_OVERRIDE_PROPERTY = <span class="string">"spring.boot.enableautoconfiguration"</span>;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Exclude specific auto-configuration classes such that they will never be applied.</span>
<span class="line">	 * <span class="doctag">@return</span> the classes to exclude</span>
<span class="line">	 */</span></span>
<span class="line">	Class&lt;?&gt;[] exclude() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Exclude specific auto-configuration class names such that they will never be</span>
<span class="line">	 * applied.</span>
<span class="line">	 * <span class="doctag">@return</span> the class names to exclude</span>
<span class="line">	 * <span class="doctag">@since</span> 1.3.0</span>
<span class="line">	 */</span></span>
<span class="line">	String[] excludeName() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line"></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>这个注解的功能概况如下：</p>
<ol>
<li>自动配置基于应用的<code>classpath</code>以及你定义了什么Beans</li>
<li>可以通过设置注解的<code>excludeName</code>属性或者通过<code>spring.autoconfigure.exclude</code>配置项来指定不需要自动配置的项目。</li>
<li>自动配置的发生时机在用户定义的Beans被注册之后</li>
<li>最好将<code>@EnableAutoConfiguration</code>注解放在<code>root package</code>的类上，这样就能够搜索到所有子<code>packages</code>中的类了</li>
<li>自动配置类就是普通的Spring <code>@Configuration</code>类，通过<code>SpringFactoriesLoader</code>机制完成加载，实现上通常使用@Conditional(比如<code>@ConditionalOnClass</code>或者<code>@ConditionalOnMissingBean</code>)</li>
</ol>
<p>不过在较新的springboot版本，可以直接使用注解<code>@SpringBootApplication</code>，原因如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="meta">@Inherited</span></span>
<span class="line"><span class="meta">@SpringBootConfiguration</span></span>
<span class="line"><span class="meta">@EnableAutoConfiguration</span></span>
<span class="line"><span class="meta">@ComponentScan</span>(excludeFilters = <span class="meta">@Filter</span>(type = FilterType.CUSTOM, classes = TypeExcludeFilter.class))</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> SpringBootApplication &#123;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>@SpringBootApplication</code>已经包含了<code>@EnableAutoConfiguration</code>。</p>
<h3 id="Import"><a href="#Import" class="headerlink" title="@Import"></a>@Import</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * <span class="doctag">@author</span> Chris Beams</span>
<span class="line"> * <span class="doctag">@author</span> Juergen Hoeller</span>
<span class="line"> * <span class="doctag">@since</span> 3.0</span>
<span class="line"> * <span class="doctag">@see</span> Configuration</span>
<span class="line"> * <span class="doctag">@see</span> ImportSelector</span>
<span class="line"> * <span class="doctag">@see</span> ImportResource</span>
<span class="line"> */</span></span>
<span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> Import &#123;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * &#123;<span class="doctag">@link</span> Configuration&#125;, &#123;<span class="doctag">@link</span> ImportSelector&#125;, &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125;</span>
<span class="line">	 * or regular component classes to import.</span>
<span class="line">	 */</span></span>
<span class="line">	Class&lt;?&gt;[] value();</span>
<span class="line"></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>@Import</code>注解的功能如下：</p>
<ol>
<li>该注解的功能和spring xml配置文件中的<code>&lt;import/&gt;</code>标签相同。</li>
<li>可以用来导入的类有<code>@Configuration</code>,<code>@ImportSelector</code>,<code>@ImportBeanDefinitionRegistrar</code></li>
<li>要访问通过<code>@Import</code>导入的，定义在<code>@Configuration</code>中的类，应该通过<code>@Autowired</code>进行注入。</li>
</ol>
<h3 id="ImportResource"><a href="#ImportResource" class="headerlink" title="@ImportResource"></a>@ImportResource</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * <span class="doctag">@author</span> Chris Beams</span>
<span class="line"> * <span class="doctag">@author</span> Juergen Hoeller</span>
<span class="line"> * <span class="doctag">@author</span> Sam Brannen</span>
<span class="line"> * <span class="doctag">@since</span> 3.0</span>
<span class="line"> * <span class="doctag">@see</span> Configuration</span>
<span class="line"> * <span class="doctag">@see</span> Import</span>
<span class="line"> */</span></span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ImportResource &#123;</span>
<span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"locations"</span>)</span>
<span class="line">    String[] value() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line">    </span>
<span class="line">    <span class="comment">/**</span>
<span class="line">	 * Resource locations from which to import.</span>
<span class="line">	 * &lt;p&gt;Supports resource-loading prefixes such as &#123;<span class="doctag">@code</span> classpath:&#125;,</span>
<span class="line">	 * &#123;<span class="doctag">@code</span> file:&#125;, etc.</span>
<span class="line">	 * &lt;p&gt;Consult the Javadoc for &#123;<span class="doctag">@link</span> #reader&#125; for details on how resources</span>
<span class="line">	 * will be processed.</span>
<span class="line">	 * <span class="doctag">@since</span> 4.2</span>
<span class="line">	 * <span class="doctag">@see</span> #value</span>
<span class="line">	 * <span class="doctag">@see</span> #reader</span>
<span class="line">	 */</span></span>
<span class="line">    <span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span>
<span class="line"> 	 String[] locations() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line"> 	 </span>
<span class="line"> 	 Class&lt;? extends BeanDefinitionReader&gt; reader() <span class="keyword">default</span> BeanDefinitionReader.class;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>用来导入资源一个或多个包含<code>bean definitions</code>的资源文件。如果资源文件以<code>.groovy</code>结尾，那么就使用<code>GroovyBeanDefinitionReader</code>，否则使用<code>XmlBeanDefinitionReader</code>进行解析。</p>
<h3 id="AutoConfigurationPackage"><a href="#AutoConfigurationPackage" class="headerlink" title="@AutoConfigurationPackage"></a>@AutoConfigurationPackage</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="meta">@Inherited</span></span>
<span class="line"><span class="meta">@Import</span>(AutoConfigurationPackages.Registrar.class)</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> AutoConfigurationPackage &#123;</span>
<span class="line">    <span class="comment">/**</span>
<span class="line">	 * &#123;<span class="doctag">@link</span> Configuration&#125;, &#123;<span class="doctag">@link</span> ImportSelector&#125;, &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125;</span>
<span class="line">	 * or regular component classes to import.</span>
<span class="line">	 */</span></span>
<span class="line">	Class&lt;?&gt;[] value();</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>该注解类的作用就是告诉spring:打了该注解类所在的包下面的被注解类，需要被<code>AutoConfigurationPackages</code>类进行注册。具体的实现原理可以参考第四小节提到的Bean动态注册，关于<code>ImportBeanDefinitionRegistrar</code>的解释。</p>
<h4 id="Import-EnableAutoConfigurationImportSelector-class"><a href="#Import-EnableAutoConfigurationImportSelector-class" class="headerlink" title="@Import(EnableAutoConfigurationImportSelector.class)"></a>@Import(EnableAutoConfigurationImportSelector.class)</h4><p><code>@EnableAutoConfiguration</code>注解的另外一个作用就是引入了<code>EnableAutoConfigurationImportSelector</code></p>
<p>它的类图如下所示：</p>
<img src="/2018/03/06/spring-extension-point-autoconfig-summary/EnableAutoConfigurationImportSelector.png" alt="EnableAutoConfigurationImportSelector.png" title="">
<p>可以发现它除了实现几个Aware类接口外，最关键的就是实现了<code>DeferredImportSelector</code>(继承自<code>ImportSelector</code>)接口。</p>
<p>所以我们先来看看<code>ImportSelector</code>以及<code>DeferredImportSelector</code>接口的定义：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportSelector</span> </span>&#123;</span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * 基于被引入的Configuration类的AnnotationMetadata信息选择并返回需要引入的类名列表</span>
<span class="line">     */</span></span>
<span class="line">    String[] selectImports(AnnotationMetadata importingClassMetadata);</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>这个接口的Javadoc比较长，还是捡重点说明一下：</p>
<ol>
<li>功能通过<code>selectImports</code>方法实现，用于筛选可以<code>@Import</code>进的<code>@Configuration</code>配置类。</li>
<li>实现了<code>ImportSelector</code>接口的类也可以实现一系列<code>Aware</code>接口，这些<code>Aware</code>接口中的相应方法会在<code>selectImports</code>方法之前被调用(这一点通过上面的类图也可以佐证，<code>EnableAutoConfigurationImportSelector</code>确实实现了四个Aware类型的接口)</li>
<li><code>ImportSelector</code>的实现和通常的<code>@Import</code>在处理方式上是一致的，然而还是可以在所有<code>@Configuration</code>类都被处理后再进行引入筛选(具体看下面即将介绍的<code>@DeferredImportSelector</code>)</li>
</ol>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line">* A variation of &#123;<span class="doctag">@link</span> ImportSelector&#125; that runs after all &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; beans</span>
<span class="line">* have been processed. This type of selector can be particularly useful when the selected</span>
<span class="line">* imports are &#123;<span class="doctag">@code</span> <span class="doctag">@Conditional</span>&#125;.</span>
<span class="line">/</span>
<span class="line">public interface DeferredImportSelector extends ImportSelector &#123;</span>
<span class="line">&#125;</span></span>
</pre></td></tr></table></figure>
<p>这个接口是一个标记接口，它本身没有定义任何方法。那么这个接口的含义是什么呢：</p>
<p>它是<code>ImportSelector</code>接口的一个变体，在所有的<code>@Configuration</code>被处理之后才会执行。在需要筛选的引入类型具备<code>@Conditional</code>注解的时候非常有用实现类同样也可以实现<code>Ordered</code>接口，来定义多个<code>DeferredImportSelector</code>的优先级别(当然了，也可以使用注解<code>@Order</code>)</p>
<p>下面来看看是如何实现的：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="keyword">public</span> String[] selectImports(AnnotationMetadata annotationMetadata) &#123;</span>
<span class="line">    <span class="comment">//可以通过配置`spring.boot.enableautoconfiguration`来关闭该功能，默认是true</span></span>
<span class="line">    <span class="keyword">if</span> (!isEnabled(annotationMetadata)) &#123;</span>
<span class="line">        <span class="keyword">return</span> NO_IMPORTS;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">try</span> &#123;</span>
<span class="line">      <span class="comment">// Step1: 得到注解信息</span></span>
<span class="line">        AutoConfigurationMetadata autoConfigurationMetadata =   AutoConfigurationMetadataLoader.loadMetadata(<span class="keyword">this</span>.beanClassLoader);</span>
<span class="line">        <span class="comment">// Step2: 得到注解中的所有属性信息</span></span>
<span class="line">        AnnotationAttributes attributes = getAttributes(annotationMetadata);</span>
<span class="line">        <span class="comment">// Step3: 得到候选配置列表</span></span>
<span class="line">        List&lt;String&gt; configurations = getCandidateConfigurations(annotationMetadata,</span>
<span class="line">                attributes);</span>
<span class="line">        <span class="comment">// Step4: 去重</span></span>
<span class="line">        configurations = removeDuplicates(configurations);</span>
<span class="line">        <span class="comment">// Step5: 排序</span></span>
<span class="line">        configurations = sort(configurations, autoConfigurationMetadata);</span>
<span class="line">        <span class="comment">// Step6: 根据注解中的exclude信息去除不需要的</span></span>
<span class="line">        Set&lt;String&gt; exclusions = getExclusions(annotationMetadata, attributes);</span>
<span class="line">        checkExcludedClasses(configurations, exclusions);</span>
<span class="line">        configurations.removeAll(exclusions);</span>
<span class="line">        configurations = filter(configurations, autoConfigurationMetadata);</span>
<span class="line">        <span class="comment">// Step7: 派发事件</span></span>
<span class="line">        fireAutoConfigurationImportEvents(configurations, exclusions);</span>
<span class="line">        <span class="keyword">return</span> configurations.toArray(<span class="keyword">new</span> String[configurations.size()]);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span>
<span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(ex);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>注解<code>@EnableAutoConfiguration</code>一般加在应用的启动主类上，并且提供了两个配置属性:<code>exclude</code>和<code>excludeName</code>来指定排除那些配置类。</p>
<p>所以上面代码中的<code>attributes</code>变量的值其实就是注解<code>@EnableAutoConfiguration</code>的配置属性</p>
<p>核心就在于上面的步骤3：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">protected</span> List&lt;String&gt; <span class="title">getCandidateConfigurations</span><span class="params">(AnnotationMetadata metadata,</span>
<span class="line">        AnnotationAttributes attributes)</span> </span>&#123;</span>
<span class="line">    List&lt;String&gt; configurations = SpringFactoriesLoader.loadFactoryNames(</span>
<span class="line">            getSpringFactoriesLoaderFactoryClass(), getBeanClassLoader());</span>
<span class="line">    Assert.notEmpty(configurations,</span>
<span class="line">            <span class="string">"No auto configuration classes found in META-INF/spring.factories. If you "</span></span>
<span class="line">                    + <span class="string">"are using a custom packaging, make sure that file is correct."</span>);</span>
<span class="line">    <span class="keyword">return</span> configurations;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>它将实现委托给了<code>SpringFactoriesLoader</code>的<code>loadFactoryNames</code>方法:</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// 传入的factoryClass：org.springframework.boot.autoconfigure.EnableAutoConfiguration</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span>
<span class="line">    String factoryClassName = factoryClass.getName();</span>
<span class="line">    <span class="keyword">try</span> &#123;</span>
<span class="line">        Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span>
<span class="line">                ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span>
<span class="line">        List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span>
<span class="line">        <span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span>
<span class="line">            URL url = urls.nextElement();</span>
<span class="line">            Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span>
<span class="line">            String factoryClassNames = properties.getProperty(factoryClassName);</span>
<span class="line">            result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span>
<span class="line">        &#125;</span>
<span class="line">        <span class="keyword">return</span> result;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">catch</span> (IOException ex) &#123;</span>
<span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() +</span>
<span class="line">                <span class="string">"] factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="comment">// 相关常量</span></span>
<span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> String FACTORIES_RESOURCE_LOCATION = <span class="string">"META-INF/spring.factories"</span>;</span>
</pre></td></tr></table></figure>
<p>这段代码的意图很明确，它会从类路径中拿到所有名为<code>META-INF/spring.factories</code>的配置文件，然后按照<code>factoryClass</code>的名称取到对应的值。那么我们就来找一个<code>META-INF/spring.factories</code>配置文件看看.</p>
<h4 id="META-INF-spring-factories"><a href="#META-INF-spring-factories" class="headerlink" title="META-INF/spring.factories"></a>META-INF/spring.factories</h4><p>比如spring-boot-autoconfigure包：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"># Auto Configure</span>
<span class="line">org.springframework.boot.autoconfigure.EnableAutoConfiguration=\</span>
<span class="line">org.springframework.boot.autoconfigure.admin.SpringApplicationAdminJmxAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.aop.AopAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.amqp.RabbitAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.batch.BatchAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.cache.CacheAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.cassandra.CassandraAutoConfiguration,\</span>
<span class="line">org.springframework.boot.autoconfigure.cloud.CloudAutoConfiguration,\</span>
<span class="line"># 省略了很多</span>
</pre></td></tr></table></figure>
<blockquote>
<p>如果需要禁用某些自动配置功能， 可以通过配置<code>@EnableAutoConfiguration</code>的<code>exclude</code>属性。</p>
</blockquote>
<p>上面的文件列举了非常多的自动配置候选项，挑一个AOP相关的<code>AopAutoConfiguration</code>看看究竟：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// 如果设置了spring.aop.auto=false，那么AOP不会被配置</span></span>
<span class="line"><span class="comment">// 需要检测到@EnableAspectJAutoProxy注解存在才会生效</span></span>
<span class="line"><span class="comment">// 默认使用JdkDynamicAutoProxyConfiguration，如果设置了spring.aop.proxy-target-class=true，那么使用CglibAutoProxyConfiguration</span></span>
<span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="meta">@ConditionalOnClass</span>(&#123; EnableAspectJAutoProxy.class, Aspect.class, Advice.class &#125;)</span>
<span class="line"><span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.aop"</span>, name = <span class="string">"auto"</span>, havingValue = <span class="string">"true"</span>, matchIfMissing = <span class="keyword">true</span>)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">AopAutoConfiguration</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Configuration</span></span>
<span class="line">    <span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">false</span>)</span>
<span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.aop"</span>, name = <span class="string">"proxy-target-class"</span>, havingValue = <span class="string">"false"</span>, matchIfMissing = <span class="keyword">true</span>)</span>
<span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">JdkDynamicAutoProxyConfiguration</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">    <span class="meta">@Configuration</span></span>
<span class="line">    <span class="meta">@EnableAspectJAutoProxy</span>(proxyTargetClass = <span class="keyword">true</span>)</span>
<span class="line">    <span class="meta">@ConditionalOnProperty</span>(prefix = <span class="string">"spring.aop"</span>, name = <span class="string">"proxy-target-class"</span>, havingValue = <span class="string">"true"</span>, matchIfMissing = <span class="keyword">false</span>)</span>
<span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="class"><span class="keyword">class</span> <span class="title">CglibAutoProxyConfiguration</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>这个自动配置类的作用是判断是否存在配置项：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line">spring.aop.proxy-target-class=true</span>
</pre></td></tr></table></figure>
<p>如果存在并且值为<code>true</code>的话使用基于<code>CGLIB</code>字节码操作的动态代理方案，否则使用JDK自带的动态代理机制。</p>
<p>在这个配置类中，使用到了两个全新的注解：</p>
<ul>
<li>@ConditionalOnClass</li>
<li>@ConditionalOnProperty</li>
</ul>
<p>从这两个注解的名称，就大概能够猜出它们的功能了：</p>
<h3 id="ConditionalOnClass"><a href="#ConditionalOnClass" class="headerlink" title="@ConditionalOnClass"></a>@ConditionalOnClass</h3><p>当类路径上存在指定的类时，满足条件。</p>
<h3 id="ConditionalOnProperty"><a href="#ConditionalOnProperty" class="headerlink" title="@ConditionalOnProperty"></a>@ConditionalOnProperty</h3><p>当配置中存在指定的属性时，满足条件。</p>
<p>其实除了这两个注解之外，还有几个类似的，它们都在<code>org.springframework.boot.autoconfigure.condition</code>这个包下，在具体介绍实现之前，下面先来看看Spring Boot对于<code>@Conditional</code>的扩展。</p>
<h3 id="Spring-Boot对于-Conditional的扩展"><a href="#Spring-Boot对于-Conditional的扩展" class="headerlink" title="Spring Boot对于@Conditional的扩展"></a>Spring Boot对于@Conditional的扩展</h3><p>Spring Boot提供了一个实现了<code>Condition</code>接口的抽象类<code>SpringBootCondition</code>。</p>
<p>这个类的主要作用是打印一些用于诊断的日志，告诉用户哪些类型被自动配置了。</p>
<p>它实现<code>Condition</code>接口的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context,</span>
<span class="line">        AnnotatedTypeMetadata metadata)</span> </span>&#123;</span>
<span class="line">    String classOrMethodName = getClassOrMethodName(metadata);</span>
<span class="line">    <span class="keyword">try</span> &#123;</span>
<span class="line">        ConditionOutcome outcome = getMatchOutcome(context, metadata);</span>
<span class="line">        logOutcome(classOrMethodName, outcome);</span>
<span class="line">        recordEvaluation(context, classOrMethodName, outcome);</span>
<span class="line">        <span class="keyword">return</span> outcome.isMatch();</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">catch</span> (NoClassDefFoundError ex) &#123;</span>
<span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span>
<span class="line">                <span class="string">"Could not evaluate condition on "</span> + classOrMethodName + <span class="string">" due to "</span></span>
<span class="line">                        + ex.getMessage() + <span class="string">" not "</span></span>
<span class="line">                        + <span class="string">"found. Make sure your own configuration does not rely on "</span></span>
<span class="line">                        + <span class="string">"that class. This can also happen if you are "</span></span>
<span class="line">                        + <span class="string">"@ComponentScanning a springframework package (e.g. if you "</span></span>
<span class="line">                        + <span class="string">"put a @ComponentScan in the default package by mistake)"</span>,</span>
<span class="line">                ex);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">catch</span> (RuntimeException ex) &#123;</span>
<span class="line">        <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span>
<span class="line">                <span class="string">"Error processing condition on "</span> + getName(metadata), ex);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
<span class="line"><span class="comment">/**</span>
<span class="line"> * Determine the outcome of the match along with suitable log output.</span>
<span class="line"> * <span class="doctag">@param</span> context the condition context</span>
<span class="line"> * <span class="doctag">@param</span> metadata the annotation metadata</span>
<span class="line"> * <span class="doctag">@return</span> the condition outcome</span>
<span class="line"> */</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">abstract</span> ConditionOutcome <span class="title">getMatchOutcome</span><span class="params">(ConditionContext context,</span>
<span class="line">        AnnotatedTypeMetadata metadata)</span></span>;</span>
</pre></td></tr></table></figure>
<p>SpringBootCondition已经提供了基本的实现，将内部的匹配细节定义成抽象方法getMatchOutcome，交给其子类去完成。</p>
<p>另外，还提供了两个可能会被子类使用到的方法：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * 如果指定的conditions中有任意一个匹配，那么就返回true</span>
<span class="line"> * <span class="doctag">@param</span> context the context</span>
<span class="line"> * <span class="doctag">@param</span> metadata the annotation meta-data</span>
<span class="line"> * <span class="doctag">@param</span> conditions conditions to test</span>
<span class="line"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if any condition matches.</span>
<span class="line"> */</span></span>
<span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">anyMatches</span><span class="params">(ConditionContext context,</span>
<span class="line">        AnnotatedTypeMetadata metadata, Condition... conditions)</span> </span>&#123;</span>
<span class="line">    <span class="keyword">for</span> (Condition condition : conditions) &#123;</span>
<span class="line">        <span class="keyword">if</span> (matches(context, metadata, condition)) &#123;</span>
<span class="line">            <span class="keyword">return</span> <span class="keyword">true</span>;</span>
<span class="line">        &#125;</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">return</span> <span class="keyword">false</span>;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="comment">/**</span>
<span class="line"> * 检查指定的condition是否匹配</span>
<span class="line"> * <span class="doctag">@param</span> context the context</span>
<span class="line"> * <span class="doctag">@param</span> metadata the annotation meta-data</span>
<span class="line"> * <span class="doctag">@param</span> condition condition to test</span>
<span class="line"> * <span class="doctag">@return</span> &#123;<span class="doctag">@code</span> true&#125; if the condition matches.</span>
<span class="line"> */</span></span>
<span class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">boolean</span> <span class="title">matches</span><span class="params">(ConditionContext context,</span>
<span class="line">        AnnotatedTypeMetadata metadata, Condition condition)</span> </span>&#123;</span>
<span class="line">    <span class="keyword">if</span> (condition <span class="keyword">instanceof</span> SpringBootCondition) &#123;</span>
<span class="line">        <span class="keyword">return</span> ((SpringBootCondition) condition).getMatchOutcome(context, metadata)</span>
<span class="line">                .isMatch();</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">return</span> condition.matches(context, metadata);</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="org-springframework-boot-autoconfigure-condition包"><a href="#org-springframework-boot-autoconfigure-condition包" class="headerlink" title="org.springframework.boot.autoconfigure.condition包"></a>org.springframework.boot.autoconfigure.condition包</h3><p>除了上面已经遇到的<code>@ConditionalOnClass</code>和<code>@ConditionalOnProperty</code>，这个包中还定义了很多条件实现类，下面简单列举几个：</p>
<h3 id="ConditionalOnExpression-基于SpEL的条件判断"><a href="#ConditionalOnExpression-基于SpEL的条件判断" class="headerlink" title="@ConditionalOnExpression - 基于SpEL的条件判断"></a>@ConditionalOnExpression - 基于SpEL的条件判断</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * Configuration annotation for a conditional element that depends on the value of a SpEL</span>
<span class="line"> * expression.</span>
<span class="line"> *</span>
<span class="line"> * <span class="doctag">@author</span> Dave Syer</span>
<span class="line"> */</span></span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Target</span>(&#123; ElementType.TYPE, ElementType.METHOD &#125;)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="meta">@Conditional</span>(OnExpressionCondition.class)</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ConditionalOnExpression &#123;</span>
<span class="line"></span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * The SpEL expression to evaluate. Expression should return &#123;<span class="doctag">@code</span> true&#125; if the</span>
<span class="line">     * condition passes or &#123;<span class="doctag">@code</span> false&#125; if it fails.</span>
<span class="line">     * <span class="doctag">@return</span> the SpEL expression</span>
<span class="line">     */</span></span>
<span class="line">    <span class="function">String <span class="title">value</span><span class="params">()</span> <span class="keyword">default</span> "<span class="keyword">true</span>"</span>;</span>
</pre></td></tr></table></figure>
<p>然后相应的实现类是<code>OnExpressionCondition</code>，它继承自<code>SpringBootCondition</code>。</p>
<h3 id="ConditionalOnMissingClass-基于类不存在与classpath的条件判断"><a href="#ConditionalOnMissingClass-基于类不存在与classpath的条件判断" class="headerlink" title="@ConditionalOnMissingClass - 基于类不存在与classpath的条件判断"></a>@ConditionalOnMissingClass - 基于类不存在与classpath的条件判断</h3><p>这一个条件实现正好和<code>@ConditionalOnClass</code>条件相反</p>
<p>下面列举所有由Spring Boot提供的条件注解：</p>
<ul>
<li>@ConditionalOnBean</li>
<li>@ConditionalOnClass</li>
<li>@ConditionalOnCloudPlatform</li>
<li>@ConditionalOnExpression</li>
<li>@ConditionalOnJava</li>
<li>@ConditionalOnJndi</li>
<li>@ConditionalOnMissingBean</li>
<li>@ConditionalOnMissingClass</li>
<li>@ConditionalOnNotWebApplication</li>
<li>@ConditionalOnProperty</li>
<li>@ConditionalOnResource</li>
<li>@ConditionalOnSingleCandidate</li>
<li>@ConditionalOnWebApplication</li>
</ul>
<p>一般的模式，就是一个条件注解对应一个继承自SpringBootCondition的具体实现类。</p>
<h2 id="动态注册Bean"><a href="#动态注册Bean" class="headerlink" title="动态注册Bean"></a>动态注册Bean</h2><p>在某些特殊的场景下，我们需要动态的向spring的容器注册Bean。spring框架本身提供了一些机制来帮助我们来实现这些特殊的需求。</p>
<h3 id="BeanDefinitionRegistry"><a href="#BeanDefinitionRegistry" class="headerlink" title="BeanDefinitionRegistry"></a>BeanDefinitionRegistry</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistry</span> <span class="keyword">extends</span> <span class="title">AliasRegistry</span> </span>&#123;</span>
<span class="line">    </span>
<span class="line">    <span class="comment">/**</span>
<span class="line">	 * Register a new bean definition with this registry.</span>
<span class="line">	 * Must support RootBeanDefinition and ChildBeanDefinition.</span>
<span class="line">	 * <span class="doctag">@param</span> beanName the name of the bean instance to register</span>
<span class="line">	 * <span class="doctag">@param</span> beanDefinition definition of the bean instance to register</span>
<span class="line">	 * <span class="doctag">@throws</span> BeanDefinitionStoreException if the BeanDefinition is invalid</span>
<span class="line">	 * or if there is already a BeanDefinition for the specified bean name</span>
<span class="line">	 * (and we are not allowed to override it)</span>
<span class="line">	 * <span class="doctag">@see</span> RootBeanDefinition</span>
<span class="line">	 * <span class="doctag">@see</span> ChildBeanDefinition</span>
<span class="line">	 */</span></span>
<span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerBeanDefinition</span><span class="params">(String beanName, BeanDefinition beanDefinition)</span></span>
<span class="line">			<span class="keyword">throws</span> BeanDefinitionStoreException</span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>BeanDefinitionRegistry 扩展点允许我们来动态的想spring容器注册<code>BeanDefinition</code>。</p>
<h3 id="SingletonBeanRegistry"><a href="#SingletonBeanRegistry" class="headerlink" title="SingletonBeanRegistry"></a>SingletonBeanRegistry</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">SingletonBeanRegistry</span> </span>&#123;</span>
<span class="line">    <span class="comment">/**</span>
<span class="line">	 * Register the given existing object as singleton in the bean registry,</span>
<span class="line">	 * under the given bean name.</span>
<span class="line">	 * &lt;p&gt;The given instance is supposed to be fully initialized; the registry</span>
<span class="line">	 * will not perform any initialization callbacks (in particular, it won't</span>
<span class="line">	 * call InitializingBean's &#123;<span class="doctag">@code</span> afterPropertiesSet&#125; method).</span>
<span class="line">	 * The given instance will not receive any destruction callbacks</span>
<span class="line">	 * (like DisposableBean's &#123;<span class="doctag">@code</span> destroy&#125; method) either.</span>
<span class="line">	 * &lt;p&gt;When running within a full BeanFactory: &lt;b&gt;Register a bean definition</span>
<span class="line">	 * instead of an existing instance if your bean is supposed to receive</span>
<span class="line">	 * initialization and/or destruction callbacks.&lt;/b&gt;</span>
<span class="line">	 * &lt;p&gt;Typically invoked during registry configuration, but can also be used</span>
<span class="line">	 * for runtime registration of singletons. As a consequence, a registry</span>
<span class="line">	 * implementation should synchronize singleton access; it will have to do</span>
<span class="line">	 * this anyway if it supports a BeanFactory's lazy initialization of singletons.</span>
<span class="line">	 * <span class="doctag">@param</span> beanName the name of the bean</span>
<span class="line">	 * <span class="doctag">@param</span> singletonObject the existing singleton object</span>
<span class="line">	 * <span class="doctag">@see</span> org.springframework.beans.factory.InitializingBean#afterPropertiesSet</span>
<span class="line">	 * <span class="doctag">@see</span> org.springframework.beans.factory.DisposableBean#destroy</span>
<span class="line">	 * <span class="doctag">@see</span> org.springframework.beans.factory.support.BeanDefinitionRegistry#registerBeanDefinition</span>
<span class="line">	 */</span></span>
<span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">registerSingleton</span><span class="params">(String beanName, Object singletonObject)</span></span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>SingletonBeanRegistry</code>允许我们来直接向Spring容器注册Singleton的Bean实例。</p>
<p>两者区别在于使用前者时，Spring容器会根据BeanDefinition实例化bean实例，而使用后者时，bean实例就是传递给registerSingleton方法的对象。</p>
<p>DefaultListableBeanFactory接口同时实现了这两个接口，在实践中通常会使用这个接口。</p>
<h4 id="在普通bean中进行动态注册"><a href="#在普通bean中进行动态注册" class="headerlink" title="在普通bean中进行动态注册"></a>在普通bean中进行动态注册</h4><p>可以在任何获得了<code>BeanDefinitionRegistry</code>或者<code>SingletonBeanRegistry</code>实例的地方进行动态注册。</p>
<p>但是如果bean不是在<code>BeanFactoryPostProcessor</code>中被注册，那么该bean则无法被<strong>BeanPostProcessor</strong>处理，即无法对其应用aop、Bean Validation等功能。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
</pre></td><td class="code"><pre><span class="line">RestController</span>
<span class="line"><span class="meta">@Slf</span>4j</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonManagerRegisterController</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * The Application context.</span>
<span class="line">     */</span></span>
<span class="line">    <span class="meta">@Autowired</span></span>
<span class="line">    GenericApplicationContext applicationContext;</span>
<span class="line"></span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * The Bean factory.</span>
<span class="line">     */</span></span>
<span class="line">    <span class="meta">@Autowired</span></span>
<span class="line">    ConfigurableBeanFactory beanFactory;</span>
<span class="line"></span>
<span class="line">    <span class="comment">/**</span>
<span class="line">     * 动态注册bean，此处注册的bean没有AOP的支持</span>
<span class="line">     * curl http://localhost:8080/registerPersonManager</span>
<span class="line">     */</span></span>
<span class="line">    <span class="meta">@GetMapping</span>(<span class="string">"/registerPersonManager"</span>)</span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerPersonManager</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        PersonDao personDao = applicationContext.getBean(PersonDao.class);</span>
<span class="line">        PersonManager personManager = <span class="keyword">new</span> PersonManager();</span>
<span class="line">        personManager.setPersonDao(personDao);</span>
<span class="line">        beanFactory.registerSingleton(<span class="string">"personManager3"</span>, personManager);</span>
<span class="line"></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h4 id="在BeanFactoryPostProcessor中进行动态注册"><a href="#在BeanFactoryPostProcessor中进行动态注册" class="headerlink" title="在BeanFactoryPostProcessor中进行动态注册"></a>在<code>BeanFactoryPostProcessor</code>中进行动态注册</h4><p>在Spring容器的启动过程中，<code>BeanFactory</code>载入bean的定义后会立刻执行<code>BeanFactoryPostProcessor</code>，此时动态注册bean，则可以保证动态注册的bean被<code>BeanPostProcessor</code>处理，并且可以保证其的实例化和初始化总是先于依赖它的bean。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span>
<span class="line"><span class="meta">@Slf</span>4j</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">PersonBeanFactoryPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span>
<span class="line">    </span>
<span class="line">    <span class="meta">@Override</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanFactory</span><span class="params">(ConfigurableListableBeanFactory beanFactory)</span> <span class="keyword">throws</span> BeansException </span>&#123;</span>
<span class="line">        DefaultListableBeanFactory defaultListableBeanFactory</span>
<span class="line">                = (DefaultListableBeanFactory) beanFactory;</span>
<span class="line"></span>
<span class="line">        <span class="comment">//注册Bean定义，容器根据定义返回bean</span></span>
<span class="line">        log.info(<span class="string">"register personManager1&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</span>
<span class="line">        BeanDefinitionBuilder beanDefinitionBuilder =</span>
<span class="line">                BeanDefinitionBuilder.genericBeanDefinition(PersonManager.class);</span>
<span class="line">        beanDefinitionBuilder.addPropertyReference(<span class="string">"personDao"</span>, <span class="string">"personDao"</span>);</span>
<span class="line">        BeanDefinition personManagerBeanDefinition = beanDefinitionBuilder.getRawBeanDefinition();</span>
<span class="line">        defaultListableBeanFactory.registerBeanDefinition(<span class="string">"personManager1"</span>, personManagerBeanDefinition);</span>
<span class="line"></span>
<span class="line">        <span class="comment">//注册bean实例</span></span>
<span class="line">        log.info(<span class="string">"register personManager2&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;&gt;"</span>);</span>
<span class="line">        PersonDao personDao = beanFactory.getBean(PersonDao.class);</span>
<span class="line">        PersonManager personManager = <span class="keyword">new</span> PersonManager();</span>
<span class="line">        personManager.setPersonDao(personDao);</span>
<span class="line">        beanFactory.registerSingleton(<span class="string">"personManager2"</span>, personManager);</span>
<span class="line"></span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="BeanDefinitionRegistryPostProcessor"><a href="#BeanDefinitionRegistryPostProcessor" class="headerlink" title="BeanDefinitionRegistryPostProcessor"></a>BeanDefinitionRegistryPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">BeanDefinitionRegistryPostProcessor</span> <span class="keyword">extends</span> <span class="title">BeanFactoryPostProcessor</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Modify the application context's internal bean definition registry after its</span>
<span class="line">	 * standard initialization. All regular bean definitions will have been loaded,</span>
<span class="line">	 * but no beans will have been instantiated yet. This allows for adding further</span>
<span class="line">	 * bean definitions before the next post-processing phase kicks in.</span>
<span class="line">	 * <span class="doctag">@param</span> registry the bean definition registry used by the application context</span>
<span class="line">	 * <span class="doctag">@throws</span> org.springframework.beans.BeansException in case of errors</span>
<span class="line">	 */</span></span>
<span class="line">	<span class="function"><span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> <span class="keyword">throws</span> BeansException</span>;</span>
<span class="line"></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>BeanDefinitionRegistryPostProcessor</code> 这个类也可以提供<code>BeanDefinition</code>注册的扩展点。</p>
<h3 id="ConfigurationClassPostProcessor"><a href="#ConfigurationClassPostProcessor" class="headerlink" title="ConfigurationClassPostProcessor"></a>ConfigurationClassPostProcessor</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * &#123;<span class="doctag">@link</span> BeanFactoryPostProcessor&#125; used for bootstrapping processing of</span>
<span class="line"> * &#123;<span class="doctag">@link</span> Configuration <span class="doctag">@Configuration</span>&#125; classes.</span>
<span class="line"> *</span>
<span class="line"> * &lt;p&gt;Registered by default when using &#123;<span class="doctag">@code</span> &lt;context:annotation-config/&gt;&#125; or</span>
<span class="line"> * &#123;<span class="doctag">@code</span> &lt;context:component-scan/&gt;&#125;. Otherwise, may be declared manually as</span>
<span class="line"> * with any other BeanFactoryPostProcessor.</span>
<span class="line"> *</span>
<span class="line"> * &lt;p&gt;This post processor is &#123;<span class="doctag">@link</span> Ordered#HIGHEST_PRECEDENCE&#125; as it is important</span>
<span class="line"> * that any &#123;<span class="doctag">@link</span> Bean&#125; methods declared in Configuration classes have their</span>
<span class="line"> * respective bean definitions registered before any other BeanFactoryPostProcessor</span>
<span class="line"> * executes.</span>
<span class="line"> *</span>
<span class="line"> * <span class="doctag">@author</span> Chris Beams</span>
<span class="line"> * <span class="doctag">@author</span> Juergen Hoeller</span>
<span class="line"> * <span class="doctag">@author</span> Phillip Webb</span>
<span class="line"> * <span class="doctag">@since</span> 3.0</span>
<span class="line"> */</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ConfigurationClassPostProcessor</span> <span class="keyword">implements</span> <span class="title">BeanDefinitionRegistryPostProcessor</span>,</span>
<span class="line">		<span class="title">PriorityOrdered</span>, <span class="title">ResourceLoaderAware</span>, <span class="title">BeanClassLoaderAware</span>, <span class="title">EnvironmentAware</span> </span>&#123;</span>
</pre></td></tr></table></figure>
<p>这个类的主要功能就是用来处理打了<code>@Configuration</code>注解的Java配置类。解析配置类，并注册<code>BeanDefinition</code>到<code>BeanDefinitionRegistry</code></p>
<p>最重要的方法如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line">* Derive further bean definitions from the configuration classes in the registry.</span>
<span class="line">*/</span></span>
<span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">postProcessBeanDefinitionRegistry</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span>
<span class="line">    <span class="keyword">int</span> registryId = System.identityHashCode(registry);</span>
<span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.registriesPostProcessed.contains(registryId)) &#123;</span>
<span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span>
<span class="line">    			<span class="string">"postProcessBeanDefinitionRegistry already called on this post-processor against "</span> + registry);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.factoriesPostProcessed.contains(registryId)) &#123;</span>
<span class="line">    	<span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(</span>
<span class="line">    			<span class="string">"postProcessBeanFactory already called on this post-processor against "</span> + registry);</span>
<span class="line">    &#125;</span>
<span class="line">    <span class="keyword">this</span>.registriesPostProcessed.add(registryId);</span>
<span class="line">    </span>
<span class="line">    processConfigBeanDefinitions(registry);</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="comment">/**</span>
<span class="line"> * Build and validate a configuration model based on the registry of</span>
<span class="line"> * &#123;<span class="doctag">@link</span> Configuration&#125; classes.</span>
<span class="line"> */</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">processConfigBeanDefinitions</span><span class="params">(BeanDefinitionRegistry registry)</span> </span>&#123;</span>
<span class="line">    <span class="comment">//代码太多了。</span></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="ImportBeanDefinitionRegistrar"><a href="#ImportBeanDefinitionRegistrar" class="headerlink" title="ImportBeanDefinitionRegistrar"></a>ImportBeanDefinitionRegistrar</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line">* Interface to be implemented by types that register additional bean definitions when</span>
<span class="line">* processing @&#123;<span class="doctag">@link</span> Configuration&#125; classes. Useful when operating at the bean definition</span>
<span class="line">* level (as opposed to &#123;<span class="doctag">@code</span> <span class="doctag">@Bean</span>&#125; method/instance level) is desired or necessary.</span>
<span class="line">*/</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">interface</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Register bean definitions as necessary based on the given annotation metadata of</span>
<span class="line">	 * the importing &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125; class.</span>
<span class="line">	 * &lt;p&gt;Note that &#123;<span class="doctag">@link</span> BeanDefinitionRegistryPostProcessor&#125; types may &lt;em&gt;not&lt;/em&gt; be</span>
<span class="line">	 * registered here, due to lifecycle constraints related to &#123;<span class="doctag">@code</span> <span class="doctag">@Configuration</span>&#125;</span>
<span class="line">	 * class processing.</span>
<span class="line">	 * <span class="doctag">@param</span> importingClassMetadata annotation metadata of the importing class</span>
<span class="line">	 * <span class="doctag">@param</span> registry current bean definition registry</span>
<span class="line">	 */</span></span>
<span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,     BeanDefinitionRegistry registry)</span></span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>Spring官方在动态注册bean时，大部分套路其实是使用ImportBeanDefinitionRegistrar接口。</p>
<p>所有实现了该接口的类的都会被<code>ConfigurationClassPostProcessor</code>处理，<code>ConfigurationClassPostProcessor</code>实现了<code>BeanFactoryPostProcessor</code>接口，所以<code>ImportBeanDefinitionRegistrar</code>中动态注册的bean是优先与依赖其的bean初始化的，也能被aop、validator等机制处理。</p>
<p>使用方法</p>
<p><code>ImportBeanDefinitionRegistrar</code>需要配合<code>@Configuration</code>和<code>@Import</code>注解，<code>@Configuration</code>定义Java格式的Spring配置文件，<code>@Import</code>注解导入实现了<code>ImportBeanDefinitionRegistrar</code>接口的类。</p>
<p>例子：</p>
<p>首先编写一个实现了接口<code>ImportBeanDefinitionRegistrar</code>的类，来实现我们自定义的Bean注册功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Component</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">UranusConfigRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">  <span class="meta">@Override</span></span>
<span class="line">  <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata, BeanDefinitionRegistry registry)</span> </span>&#123;</span>
<span class="line">      System.out.println(registry.getClass());</span>
<span class="line">      System.out.println(importingClassMetadata.getClassName());</span>
<span class="line">  &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>随后我们定义两个配置类：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="meta">@Import</span>(UranusConfigRegistrar.class)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">DatabaseConfig</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="meta">@Configuration</span></span>
<span class="line"><span class="meta">@Import</span>(UranusConfigRegistrar.class)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">WebConfig</span> </span>&#123;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>启动springboot应用，我们能再控制台看到如下的输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
</pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">beans</span>.<span class="title">factory</span>.<span class="title">support</span>.<span class="title">DefaultListableBeanFactory</span></span>
<span class="line"><span class="title">com</span>.<span class="title">leokongwq</span>.<span class="title">springcloud</span>.<span class="title">bookservice</span>.<span class="title">config</span>.<span class="title">DatabaseConfig</span></span>
<span class="line"></span>
<span class="line"><span class="title">class</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">beans</span>.<span class="title">factory</span>.<span class="title">support</span>.<span class="title">DefaultListableBeanFactory</span></span>
<span class="line"><span class="title">com</span>.<span class="title">leokongwq</span>.<span class="title">springcloud</span>.<span class="title">bookservice</span>.<span class="title">config</span>.<span class="title">WebConfig</span></span></span>
</pre></td></tr></table></figure>
<p>从输出我们可以知道，方法<code>registerBeanDefinitions</code>的参数<code>AnnotationMetadata</code>里面包含<code>@Configuration</code>配置类的注解原信息。<code>registry</code>参数其实就是spring容器。</p>
<p>通过<code>AnnotationMetadata</code>我们能获取到<code>@Configuration</code>配置类上的所有注解信息，包括配置类里面加了注解的方法配置信息。</p>
<p>通过该机制，我们可以在<code>@Configuration</code>配置类上添加配置原元数据注解，以此来实现动态注册Bean的功能。</p>
<p>例如:</p>
<p>配置注解类：<code>EnableRedisCache</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Import</span>(UranusConfigRegistrar.class)</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> EnableRedisCache &#123;</span>
<span class="line"></span>
<span class="line">    <span class="function">String <span class="title">host</span><span class="params">()</span> <span class="keyword">default</span> "127.0.0.1"</span>;</span>
<span class="line"></span>
<span class="line">    <span class="function"><span class="keyword">int</span> <span class="title">port</span><span class="params">()</span> <span class="keyword">default</span> 9527</span>;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>启用注解<code>EnableRedisCache</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span>
<span class="line"><span class="meta">@EnableRedisCache</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">ApplicationBootstrap</span> </span>&#123;</span>
<span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span>
<span class="line">        SpringApplication.run(ApplicationBootstrap.class, args); </span>
<span class="line">	&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>启动应用，可以在控制台看到如下的输出：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
</pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">org</span>.<span class="title">springframework</span>.<span class="title">beans</span>.<span class="title">factory</span>.<span class="title">support</span>.<span class="title">DefaultListableBeanFactory</span></span>
<span class="line"><span class="title">com</span>.<span class="title">leokongwq</span>.<span class="title">springcloud</span>.<span class="title">bookservice</span>.<span class="title">config</span>.<span class="title">WebConfig</span></span>
<span class="line"><span class="title">host</span></span>=<span class="number">127.0</span>.0.1</span>
<span class="line">port=<span class="number">9527</span></span>
</pre></td></tr></table></figure>
<p>有了配置的元数据，我们就可以自由发挥，动态的生成一些Bean。</p>
<p>举一个springboot中的例子：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * &#123;<span class="doctag">@link</span> ImportBeanDefinitionRegistrar&#125; used by &#123;<span class="doctag">@link</span> ServletComponentScan&#125;.</span>
<span class="line"> *</span>
<span class="line"> * <span class="doctag">@author</span> Andy Wilkinson</span>
<span class="line"> * <span class="doctag">@author</span> Stephane Nicoll</span>
<span class="line"> */</span></span>
<span class="line"><span class="class"><span class="keyword">class</span> <span class="title">ServletComponentScanRegistrar</span> <span class="keyword">implements</span> <span class="title">ImportBeanDefinitionRegistrar</span> </span>&#123;</span>
<span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> String BEAN_NAME = <span class="string">"servletComponentRegisteringPostProcessor"</span>;</span>
<span class="line"></span>
<span class="line">	<span class="meta">@Override</span></span>
<span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">registerBeanDefinitions</span><span class="params">(AnnotationMetadata importingClassMetadata,</span>
<span class="line">			BeanDefinitionRegistry registry)</span> </span>&#123;</span>
<span class="line">		Set&lt;String&gt; packagesToScan = getPackagesToScan(importingClassMetadata);</span>
<span class="line">		<span class="keyword">if</span> (registry.containsBeanDefinition(BEAN_NAME)) &#123;</span>
<span class="line">			updatePostProcessor(registry, packagesToScan);</span>
<span class="line">		&#125;</span>
<span class="line">		<span class="keyword">else</span> &#123;</span>
<span class="line">			addPostProcessor(registry, packagesToScan);</span>
<span class="line">		&#125;</span>
<span class="line">	&#125;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="meta">@Target</span>(ElementType.TYPE)</span>
<span class="line"><span class="meta">@Retention</span>(RetentionPolicy.RUNTIME)</span>
<span class="line"><span class="meta">@Documented</span></span>
<span class="line"><span class="meta">@Import</span>(ServletComponentScanRegistrar.class)</span>
<span class="line"><span class="keyword">public</span> <span class="meta">@interface</span> ServletComponentScan &#123;</span>
<span class="line">    <span class="comment">/**</span>
<span class="line">	 * Alias for the &#123;<span class="doctag">@link</span> #basePackages()&#125; attribute. Allows for more concise annotation</span>
<span class="line">	 * declarations e.g.: &#123;<span class="doctag">@code</span> <span class="doctag">@ServletComponentScan</span>("org.my.pkg")&#125; instead of</span>
<span class="line">	 * &#123;<span class="doctag">@code</span> <span class="doctag">@ServletComponentScan</span>(basePackages="org.my.pkg")&#125;.</span>
<span class="line">	 * <span class="doctag">@return</span> the base packages to scan</span>
<span class="line">	 */</span></span>
<span class="line">	<span class="meta">@AliasFor</span>(<span class="string">"basePackages"</span>)</span>
<span class="line">	String[] value() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Base packages to scan for annotated servlet components. &#123;<span class="doctag">@link</span> #value()&#125; is an</span>
<span class="line">	 * alias for (and mutually exclusive with) this attribute.</span>
<span class="line">	 * &lt;p&gt;</span>
<span class="line">	 * Use &#123;<span class="doctag">@link</span> #basePackageClasses()&#125; for a type-safe alternative to String-based</span>
<span class="line">	 * package names.</span>
<span class="line">	 * <span class="doctag">@return</span> the base packages to scan</span>
<span class="line">	 */</span></span>
<span class="line">	<span class="meta">@AliasFor</span>(<span class="string">"value"</span>)</span>
<span class="line">	String[] basePackages() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line"></span>
<span class="line">	<span class="comment">/**</span>
<span class="line">	 * Type-safe alternative to &#123;<span class="doctag">@link</span> #basePackages()&#125; for specifying the packages to</span>
<span class="line">	 * scan for annotated servlet components. The package of each class specified will be</span>
<span class="line">	 * scanned.</span>
<span class="line">	 * <span class="doctag">@return</span> classes from the base packages to scan</span>
<span class="line">	 */</span></span>
<span class="line">	Class&lt;?&gt;[] basePackageClasses() <span class="keyword">default</span> &#123;&#125;;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p><code>ServletComponentScanRegistrar</code>实现了接口：<code>ImportBeanDefinitionRegistrar</code>。 同时注解<code>@ServletComponentScan</code>上也打了注解<code>@Import(ServletComponentScanRegistrar.class)</code>。</p>
<p>这样我们就可以在使用注解<code>ServletComponentScan</code>时，指定<code>basePackages</code>和<code>basePackageClasses</code>属性来配置Servlet规范里面的组件。Filter，Listener， Servlet等。</p>
<p>例如：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@SpringBootApplication</span></span>
<span class="line"><span class="meta">@ServletComponentScan</span>(basePackages = <span class="string">"com.leokongwq.springcloud.bookservice.web"</span>)</span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">BookServiceApplication</span> </span>&#123;</span>
<span class="line"></span>
<span class="line">	<span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> </span>&#123;</span>
<span class="line">		SpringApplication.run(BookServiceApplication.class, args);</span>
<span class="line">	&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="SpringFactoriesLoader-机制"><a href="#SpringFactoriesLoader-机制" class="headerlink" title="SpringFactoriesLoader 机制"></a>SpringFactoriesLoader 机制</h2><p>SpringFactoriesLoader 的主要目的是在Spring框架内部完成工厂的加载机制。</p>
<p>主要的方法有2个：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
</pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> &lt;T&gt; <span class="function">List&lt;T&gt; <span class="title">loadFactories</span><span class="params">(Class&lt;T&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span>
<span class="line">		Assert.notNull(factoryClass, <span class="string">"'factoryClass' must not be null"</span>);</span>
<span class="line">		ClassLoader classLoaderToUse = classLoader;</span>
<span class="line">		<span class="keyword">if</span> (classLoaderToUse == <span class="keyword">null</span>) &#123;</span>
<span class="line">			classLoaderToUse = SpringFactoriesLoader.class.getClassLoader();</span>
<span class="line">		&#125;</span>
<span class="line">		List&lt;String&gt; factoryNames = loadFactoryNames(factoryClass, classLoaderToUse);</span>
<span class="line">		<span class="keyword">if</span> (logger.isTraceEnabled()) &#123;</span>
<span class="line">			logger.trace(<span class="string">"Loaded ["</span> + factoryClass.getName() + <span class="string">"] names: "</span> + factoryNames);</span>
<span class="line">		&#125;</span>
<span class="line">		List&lt;T&gt; result = <span class="keyword">new</span> ArrayList&lt;T&gt;(factoryNames.size());</span>
<span class="line">		<span class="keyword">for</span> (String factoryName : factoryNames) &#123;</span>
<span class="line">			result.add(instantiateFactory(factoryName, factoryClass, classLoaderToUse));</span>
<span class="line">		&#125;</span>
<span class="line">		AnnotationAwareOrderComparator.sort(result);</span>
<span class="line">		<span class="keyword">return</span> result;</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> List&lt;String&gt; <span class="title">loadFactoryNames</span><span class="params">(Class&lt;?&gt; factoryClass, ClassLoader classLoader)</span> </span>&#123;</span>
<span class="line">		String factoryClassName = factoryClass.getName();</span>
<span class="line">		<span class="keyword">try</span> &#123;</span>
<span class="line">			Enumeration&lt;URL&gt; urls = (classLoader != <span class="keyword">null</span> ? classLoader.getResources(FACTORIES_RESOURCE_LOCATION) :</span>
<span class="line">					ClassLoader.getSystemResources(FACTORIES_RESOURCE_LOCATION));</span>
<span class="line">			List&lt;String&gt; result = <span class="keyword">new</span> ArrayList&lt;String&gt;();</span>
<span class="line">			<span class="keyword">while</span> (urls.hasMoreElements()) &#123;</span>
<span class="line">				URL url = urls.nextElement();</span>
<span class="line">				Properties properties = PropertiesLoaderUtils.loadProperties(<span class="keyword">new</span> UrlResource(url));</span>
<span class="line">				String factoryClassNames = properties.getProperty(factoryClassName);</span>
<span class="line">				result.addAll(Arrays.asList(StringUtils.commaDelimitedListToStringArray(factoryClassNames)));</span>
<span class="line">			&#125;</span>
<span class="line">			<span class="keyword">return</span> result;</span>
<span class="line">		&#125;</span>
<span class="line">		<span class="keyword">catch</span> (IOException ex) &#123;</span>
<span class="line">			<span class="keyword">throw</span> <span class="keyword">new</span> IllegalArgumentException(<span class="string">"Unable to load ["</span> + factoryClass.getName() +</span>
<span class="line">					<span class="string">"] factories from location ["</span> + FACTORIES_RESOURCE_LOCATION + <span class="string">"]"</span>, ex);</span>
<span class="line">		&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>这两个方法都是从classpath的指定文件中获取需要加载的类。这个文件就是classpath下面的：<code>META-INF/spring.factories</code>。在签名的小节已经看到过这个文件。</p>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;spring扩展点和自动配置&quot;&gt;&lt;a href=&quot;#spring扩展点和自动配置&quot; class=&quot;headerlink&quot; title=&quot;spring扩展点和自动配置&quot;&gt;&lt;/a&gt;spring扩展点和自动配置&lt;/h2&gt;&lt;h3 id=&quot;BeanFactoryPostProcessor&quot;&gt;&lt;a href=&quot;#BeanFactoryPostProcessor&quot; class=&quot;headerlink&quot; title=&quot;BeanFactoryPostProcessor&quot;&gt;&lt;/a&gt;BeanFactoryPostProcessor&lt;/h3&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;class&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;interface&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;BeanFactoryPostProcessor&lt;/span&gt; &lt;/span&gt;&amp;#123;  &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;comment&quot;&gt;/** &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * Modify the application context&#39;s internal bean factory after its standard &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * initialization. All bean definitions will have been loaded, but no beans &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * will have been instantiated yet. This allows for overriding or adding &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * properties even to eager-initializing beans. &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@param&lt;/span&gt; beanFactory the bean factory used by the application context &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     * &lt;span class=&quot;doctag&quot;&gt;@throws&lt;/span&gt; org.springframework.beans.BeansException in case of errors &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;     */&lt;/span&gt;  &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;    &lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;postProcessBeanFactory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ConfigurableListableBeanFactory beanFactory)&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; BeansException&lt;/span&gt;;  &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;  &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;通过该扩展点，我们修改，新增&lt;code&gt;BeanDefinition&lt;/code&gt;。因为此时所有的&lt;code&gt;BeanDefinition&lt;/code&gt;已经加载，但是没有Bean被创建。一般用在需要覆盖或替换Bean的属性时。&lt;/p&gt;
    
    </summary>
    
      <category term="web" scheme="https://leokongwq.github.io/categories/web/"/>
    
    
      <category term="spring" scheme="https://leokongwq.github.io/tags/spring/"/>
    
  </entry>
  
  <entry>
    <title>kafka发送消息过程分析</title>
    <link href="https://leokongwq.github.io/2018/03/01/kafka-send-msg-profile.html"/>
    <id>https://leokongwq.github.io/2018/03/01/kafka-send-msg-profile.html</id>
    <published>2018-03-01T14:08:31.000Z</published>
    <updated>2018-07-15T13:20:06.000Z</updated>
    
    <content type="html"><![CDATA[<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>前面的一篇文章分析了消息发送时topic分区选择的问题，本文就分析一下后续的发送逻辑。</p>
<h2 id="消息发送涉及的类"><a href="#消息发送涉及的类" class="headerlink" title="消息发送涉及的类"></a>消息发送涉及的类</h2><h3 id="Producer"><a href="#Producer" class="headerlink" title="Producer"></a>Producer</h3><p><code>Producer</code>类是Kafka消息的发送的入口</p>
<h3 id="ProducerFactory"><a href="#ProducerFactory" class="headerlink" title="ProducerFactory"></a>ProducerFactory</h3><p><code>ProducerFactory</code> 是一个策略接口，用来创佳<code>Producer</code>, 默认的实现是：<code>DefaultKafkaProducerFactory</code>,其创建<br>的<code>Producer</code>是<code>CloseSafeProducer</code>, <code>CloseSafeProducer</code>是<code>KafkaProducer</code>的一个代理类。</p>
<p><code>DefaultKafkaProducerFactory</code> 的构造方法接收一个Map对象，用来指的创建<code>Producer</code>的配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultKafkaProducerFactory</span><span class="params">(Map&lt;String, Object&gt; configs)</span> </span>&#123;</span>
<span class="line">	<span class="keyword">this</span>(configs, <span class="keyword">null</span>, <span class="keyword">null</span>);</span>
<span class="line">&#125;</span>
<span class="line"></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="title">DefaultKafkaProducerFactory</span><span class="params">(Map&lt;String, Object&gt; configs, Serializer&lt;K&gt; keySerializer,</span>
<span class="line">		Serializer&lt;V&gt; valueSerializer)</span> </span>&#123;</span>
<span class="line">	<span class="keyword">this</span>.configs = <span class="keyword">new</span> HashMap&lt;&gt;(configs);</span>
<span class="line">	<span class="keyword">this</span>.keySerializer = keySerializer;</span>
<span class="line">	<span class="keyword">this</span>.valueSerializer = valueSerializer;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h3 id="KafkaTemplate"><a href="#KafkaTemplate" class="headerlink" title="KafkaTemplate"></a>KafkaTemplate</h3><p><code>KafkaTemplate</code>是一个模板类，提供了操作Kafka的高级Api。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">private</span> KafkaTemplate&lt;Integer, String&gt; <span class="title">createTemplate</span><span class="params">()</span> </span>&#123;</span>
<span class="line">	Map&lt;String, Object&gt; senderProps = senderProps();</span>
<span class="line">	ProducerFactory&lt;Integer, String&gt; pf =</span>
<span class="line">			<span class="keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(senderProps);</span>
<span class="line">	KafkaTemplate&lt;Integer, String&gt; template = <span class="keyword">new</span> KafkaTemplate&lt;&gt;(pf);</span>
<span class="line">	<span class="keyword">return</span> template;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="发送消息实例"><a href="#发送消息实例" class="headerlink" title="发送消息实例"></a>发送消息实例</h2><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// 生产者配置项</span></span>
<span class="line"><span class="function"><span class="keyword">private</span> Map&lt;String, Object&gt; <span class="title">senderProps</span><span class="params">()</span> </span>&#123;</span>
<span class="line">	Map&lt;String, Object&gt; props = <span class="keyword">new</span> HashMap&lt;&gt;();</span>
<span class="line">	props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, <span class="string">"localhost:9092"</span>);</span>
<span class="line">	props.put(ProducerConfig.RETRIES_CONFIG, <span class="number">0</span>);</span>
<span class="line">	props.put(ProducerConfig.BATCH_SIZE_CONFIG, <span class="number">16384</span>);</span>
<span class="line">	props.put(ProducerConfig.LINGER_MS_CONFIG, <span class="number">1</span>);</span>
<span class="line">	props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, <span class="number">33554432</span>);</span>
<span class="line">	props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class);</span>
<span class="line">	props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);</span>
<span class="line">	<span class="keyword">return</span> props;</span>
<span class="line">&#125; </span>
<span class="line"><span class="comment">// 创建生产者工厂实例</span></span>
<span class="line">ProducerFactory&lt;Integer, String&gt; pf = <span class="keyword">new</span> DefaultKafkaProducerFactory&lt;&gt;(senderProps);</span>
<span class="line"></span>
<span class="line"> <span class="meta">@Test</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">testSendMsgSysn</span><span class="params">()</span> <span class="keyword">throws</span> Exception </span>&#123;</span>
<span class="line">	KafkaTemplate&lt;Integer, String&gt; kafkaTemplate = createTemplate();</span>
<span class="line">	<span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; <span class="number">10</span>; i++) &#123;</span>
<span class="line">		<span class="comment">// 同步发送</span></span>
<span class="line">		<span class="comment">//kafkaTemplate.send(topic1, "hello ===&gt; " + i).get();</span></span>
<span class="line">		<span class="comment">// 异步发送</span></span>
<span class="line">		kafkaTemplate.send(topic1, <span class="string">"hello ===&gt; "</span> + i);</span>
<span class="line">	&#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<h2 id="消息发送过程分析"><a href="#消息发送过程分析" class="headerlink" title="消息发送过程分析"></a>消息发送过程分析</h2><p><code>Producer</code> 的一个重要方法就是<code>send</code>, 方法签名如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
</pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">public</span> Future&lt;RecordMetadata&gt; <span class="title">send</span><span class="params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span></span>;</span>
</pre></td></tr></table></figure>
<p>从方法的签名我们能够推断出，Kafka的消息发送是异步的。 这个从后面的分析可以得证。</p>
<a id="more"></a>
<p><code>Producer</code>的实现类是：<code>KafkaProducer</code>, 它对<code>send</code>方法的实现如下：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="meta">@Override</span></span>
<span class="line"><span class="function"><span class="keyword">public</span> Future&lt;RecordMetadata&gt; <span class="title">send</span><span class="params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> </span>&#123;</span>
<span class="line">	<span class="comment">// intercept the record, which can be potentially modified; this method does not throw exceptions</span></span>
<span class="line">	ProducerRecord&lt;K, V&gt; interceptedRecord = <span class="keyword">this</span>.interceptors == <span class="keyword">null</span> ? record : <span class="keyword">this</span>.interceptors.onSend(record);</span>
<span class="line">	<span class="keyword">return</span> doSend(interceptedRecord, callback);</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>该方法会对将要发送的消息进行个性化修改。是Kafka提供的插件机制。可以通过<code>interceptor.classes</code>配置型来配置。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line">* 异步发送一条记录到topic, 等价于　send(record, null)</span>
<span class="line">* See &#123;<span class="doctag">@link</span> #send(ProducerRecord, Callback)&#125; for details.</span>
<span class="line">*/</span></span>
<span class="line"><span class="function"><span class="keyword">private</span> Future&lt;RecordMetadata&gt; <span class="title">doSend</span><span class="params">(ProducerRecord&lt;K, V&gt; record, Callback callback)</span> </span>&#123;</span>
<span class="line">	TopicPartition tp = <span class="keyword">null</span>;</span>
<span class="line">	<span class="keyword">try</span> &#123;</span>
<span class="line">		<span class="comment">// 省略大部分代码</span></span>
<span class="line">		RecordAccumulator.RecordAppendResult result = accumulator.append(tp, timestamp, serializedKey, serializedValue, interceptCallback, remainingWaitMs);</span>
<span class="line">		<span class="comment">//当记录累加器满了　或　创建了心的发送批次，此时会唤醒发送线程来真正通过网络发送消息</span></span>
<span class="line">		<span class="keyword">if</span> (result.batchIsFull || result.newBatchCreated) &#123;</span>
<span class="line">			log.trace(<span class="string">"Waking up the sender since topic &#123;&#125; partition &#123;&#125; is either full or getting a new batch"</span>, record.topic(), partition);</span>
<span class="line">			<span class="comment">// 唤醒发现线程</span></span>
<span class="line">			<span class="keyword">this</span>.sender.wakeup();</span>
<span class="line">		&#125;</span>
<span class="line">		<span class="keyword">return</span> result.future;</span>
<span class="line">	&#125;　</span>
<span class="line">	<span class="comment">// 省略异常处理代码</span></span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>消息记录累加器： RecordAccumulator</p>
<figure class="highlight java"><figcaption><span>RecordAccumulator</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * 该类扮演一个队列的角色，用来将消息累积到`MemoryRecords`中</span>
<span class="line"> * 该类使用一个有上限的内存缓存区来保存消息，默认情况下，调用添加消息的方法append时，如果缓存区满了会阻塞调用线程　(除非手动关闭这一行为)</span>
<span class="line"> */</span></span>
<span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RecordAccumulator</span> </span>&#123;</span>
<span class="line">	<span class="comment">/**</span>
<span class="line">     * 将一条记录添加到该累加器中，并返回添加的结果</span>
<span class="line">     * 返回的结果包含了FutureRecordMetadata 和一个表示批次是否已经满了的标志位，一个批次是否是新创建的标志位</span>
<span class="line">     * <span class="doctag">@param</span> tp　该记录将要发送到的Topic的Partition信息</span>
<span class="line">     * <span class="doctag">@param</span> timestamp The timestamp of the record</span>
<span class="line">     * <span class="doctag">@param</span> key The key for the record</span>
<span class="line">     * <span class="doctag">@param</span> value The value for the record</span>
<span class="line">     * <span class="doctag">@param</span> callback 用户提供的回调函数</span>
<span class="line">     * <span class="doctag">@param</span> maxTimeToBlock 等待内存缓存区有可用空间的最大时间，单位是毫秒</span>
<span class="line">     */</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> RecordAppendResult <span class="title">append</span><span class="params">(TopicPartition tp,</span>
<span class="line">                                     <span class="keyword">long</span> timestamp,</span>
<span class="line">                                     <span class="keyword">byte</span>[] key,</span>
<span class="line">                                     <span class="keyword">byte</span>[] value,</span>
<span class="line">                                     Callback callback,</span>
<span class="line">                                     <span class="keyword">long</span> maxTimeToBlock)</span> <span class="keyword">throws</span> InterruptedException </span>&#123;</span>
<span class="line">        <span class="comment">// We keep track of the number of appending thread to make sure we do not miss batches in</span></span>
<span class="line">        <span class="comment">// abortIncompleteBatches().</span></span>
<span class="line">        appendsInProgress.incrementAndGet();</span>
<span class="line">        <span class="keyword">try</span> &#123;</span>
<span class="line">            <span class="comment">// 获取或创建一个指定partion对于的Deque</span></span>
<span class="line">            Deque&lt;RecordBatch&gt; dq = getOrCreateDeque(tp);</span>
<span class="line">            <span class="keyword">synchronized</span> (dq) &#123;</span>
<span class="line">                <span class="keyword">if</span> (closed)</span>
<span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot send after the producer is closed."</span>);</span>
<span class="line">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, callback, dq);</span>
<span class="line">                <span class="keyword">if</span> (appendResult != <span class="keyword">null</span>)</span>
<span class="line">                    <span class="keyword">return</span> appendResult;</span>
<span class="line">            &#125;</span>
<span class="line"></span>
<span class="line">            <span class="comment">//batchSize 的默认值是：16384</span></span>
<span class="line">            <span class="keyword">int</span> size = Math.max(<span class="keyword">this</span>.batchSize, Records.LOG_OVERHEAD + Record.recordSize(key, value));</span>
<span class="line">            log.trace(<span class="string">"Allocating a new &#123;&#125; byte message buffer for topic &#123;&#125; partition &#123;&#125;"</span>, size, tp.topic(), tp.partition());</span>
<span class="line">            <span class="comment">// 分配一块缓存区，来保存消息</span></span>
<span class="line">			ByteBuffer buffer = free.allocate(size, maxTimeToBlock);</span>
<span class="line">            <span class="keyword">synchronized</span> (dq) &#123;</span>
<span class="line">                <span class="comment">// Need to check if producer is closed again after grabbing the dequeue lock.</span></span>
<span class="line">                <span class="keyword">if</span> (closed)</span>
<span class="line">                    <span class="keyword">throw</span> <span class="keyword">new</span> IllegalStateException(<span class="string">"Cannot send after the producer is closed."</span>);</span>
<span class="line"></span>
<span class="line">                RecordAppendResult appendResult = tryAppend(timestamp, key, value, callback, dq);</span>
<span class="line">                <span class="keyword">if</span> (appendResult != <span class="keyword">null</span>) &#123;</span>
<span class="line">                    <span class="comment">// Somebody else found us a batch, return the one we waited for! Hopefully this doesn't happen often...</span></span>
<span class="line">                    free.deallocate(buffer);</span>
<span class="line">                    <span class="keyword">return</span> appendResult;</span>
<span class="line">                &#125;</span>
<span class="line">				<span class="comment">// 创建一个内存缓存区来缓存记录 </span></span>
<span class="line">                MemoryRecords records = MemoryRecords.emptyRecords(buffer, compression, <span class="keyword">this</span>.batchSize);</span>
<span class="line">                RecordBatch batch = <span class="keyword">new</span> RecordBatch(tp, records, time.milliseconds());</span>
<span class="line">				<span class="comment">// 将记录添加到内存缓存区</span></span>
<span class="line">                FutureRecordMetadata future = Utils.notNull(batch.tryAppend(timestamp, key, value, callback, time.milliseconds()));</span>
<span class="line">				<span class="comment">// 将批次放入队列中</span></span>
<span class="line">                dq.addLast(batch);</span>
<span class="line">				<span class="comment">// 将批次放入待确认队列</span></span>
<span class="line">                incomplete.add(batch);</span>
<span class="line">				<span class="comment">// 第一条消息肯定是 新创建的， 会立刻发送。</span></span>
<span class="line">                <span class="keyword">return</span> <span class="keyword">new</span> RecordAppendResult(future, dq.size() &gt; <span class="number">1</span> || batch.records.isFull(), <span class="keyword">true</span>);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125; <span class="keyword">finally</span> &#123;</span>
<span class="line">            appendsInProgress.decrementAndGet();</span>
<span class="line">        &#125;</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>消息批次： RecordBatch</p>
<figure class="highlight java"><figcaption><span>RecordBatch</span></figcaption><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * 该类表示一个将要被发送的消息批次</span>
<span class="line"> * 该类不是线程安全的，因此在修改该类的实例对象状态时需要外部同步</span>
<span class="line"> */</span></span>
<span class="line"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">RecordBatch</span> </span>&#123;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>消息发送线程：Sender</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
<span class="line">21</span>
<span class="line">22</span>
<span class="line">23</span>
<span class="line">24</span>
<span class="line">25</span>
<span class="line">26</span>
<span class="line">27</span>
<span class="line">28</span>
<span class="line">29</span>
<span class="line">30</span>
<span class="line">31</span>
<span class="line">32</span>
<span class="line">33</span>
<span class="line">34</span>
<span class="line">35</span>
<span class="line">36</span>
<span class="line">37</span>
<span class="line">38</span>
<span class="line">39</span>
<span class="line">40</span>
<span class="line">41</span>
<span class="line">42</span>
<span class="line">43</span>
<span class="line">44</span>
<span class="line">45</span>
<span class="line">46</span>
<span class="line">47</span>
<span class="line">48</span>
<span class="line">49</span>
<span class="line">50</span>
<span class="line">51</span>
<span class="line">52</span>
<span class="line">53</span>
<span class="line">54</span>
<span class="line">55</span>
<span class="line">56</span>
<span class="line">57</span>
<span class="line">58</span>
<span class="line">59</span>
<span class="line">60</span>
<span class="line">61</span>
<span class="line">62</span>
<span class="line">63</span>
<span class="line">64</span>
<span class="line">65</span>
<span class="line">66</span>
<span class="line">67</span>
<span class="line">68</span>
<span class="line">69</span>
<span class="line">70</span>
<span class="line">71</span>
<span class="line">72</span>
<span class="line">73</span>
<span class="line">74</span>
<span class="line">75</span>
<span class="line">76</span>
<span class="line">77</span>
<span class="line">78</span>
<span class="line">79</span>
<span class="line">80</span>
<span class="line">81</span>
<span class="line">82</span>
<span class="line">83</span>
<span class="line">84</span>
<span class="line">85</span>
<span class="line">86</span>
<span class="line">87</span>
<span class="line">88</span>
<span class="line">89</span>
<span class="line">90</span>
<span class="line">91</span>
<span class="line">92</span>
<span class="line">93</span>
<span class="line">94</span>
<span class="line">95</span>
<span class="line">96</span>
<span class="line">97</span>
<span class="line">98</span>
<span class="line">99</span>
<span class="line">100</span>
<span class="line">101</span>
<span class="line">102</span>
<span class="line">103</span>
<span class="line">104</span>
<span class="line">105</span>
<span class="line">106</span>
<span class="line">107</span>
<span class="line">108</span>
<span class="line">109</span>
<span class="line">110</span>
<span class="line">111</span>
<span class="line">112</span>
<span class="line">113</span>
<span class="line">114</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span>
<span class="line"> * 该类表示一个后台线程，用来将消息发送到kafka集群中。</span>
<span class="line"> */</span></span>
<span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">Sender</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</span>
<span class="line">	 <span class="comment">/**</span>
<span class="line">     * The main run loop for the sender thread</span>
<span class="line">     */</span></span>
<span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</span>
<span class="line">        log.debug(<span class="string">"Starting Kafka producer I/O thread."</span>);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 主循环，获取待发送的消息，并进行发送</span></span>
<span class="line">        <span class="keyword">while</span> (running) &#123;</span>
<span class="line">            <span class="keyword">try</span> &#123;</span>
<span class="line">                run(time.milliseconds());</span>
<span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">                log.error(<span class="string">"Uncaught error in kafka producer I/O thread: "</span>, e);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        log.debug(<span class="string">"Beginning shutdown of Kafka producer I/O thread, sending remaining records."</span>);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 停止接收发送消息的请求，但是会将缓存区的消息发送完毕，病处理服务端返回的ack</span></span>
<span class="line">        <span class="keyword">while</span> (!forceClose &amp;&amp; (<span class="keyword">this</span>.accumulator.hasUnsent() || <span class="keyword">this</span>.client.inFlightRequestCount() &gt; <span class="number">0</span>)) &#123;</span>
<span class="line">            <span class="keyword">try</span> &#123;</span>
<span class="line">                run(time.milliseconds());</span>
<span class="line">            &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">                log.error(<span class="string">"Uncaught error in kafka producer I/O thread: "</span>, e);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line">		<span class="comment">// 强制关闭</span></span>
<span class="line">        <span class="keyword">if</span> (forceClose) &#123;</span>
<span class="line">            <span class="comment">// We need to fail all the incomplete batches and wake up the threads waiting on</span></span>
<span class="line">            <span class="comment">// the futures.</span></span>
<span class="line">            <span class="keyword">this</span>.accumulator.abortIncompleteBatches();</span>
<span class="line">        &#125;</span>
<span class="line">		<span class="comment">// 关闭网络客户端</span></span>
<span class="line">        <span class="keyword">try</span> &#123;</span>
<span class="line">            <span class="keyword">this</span>.client.close();</span>
<span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span>
<span class="line">            log.error(<span class="string">"Failed to close network client"</span>, e);</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        log.debug(<span class="string">"Shutdown of Kafka producer I/O thread has completed."</span>);</span>
<span class="line">    &#125;</span>
<span class="line"></span>
<span class="line">	 <span class="comment">/**</span>
<span class="line">     * Run a single iteration of sending</span>
<span class="line">     * <span class="doctag">@param</span> now　The current POSIX time in milliseconds</span>
<span class="line">     */</span></span>
<span class="line">    <span class="function"><span class="keyword">void</span> <span class="title">run</span><span class="params">(<span class="keyword">long</span> now)</span> </span>&#123;</span>
<span class="line">		<span class="comment">// 获取元数据</span></span>
<span class="line">        Cluster cluster = metadata.fetch();</span>
<span class="line">        <span class="comment">// 获取可以发送数据的 Partition</span></span>
<span class="line">        RecordAccumulator.ReadyCheckResult result = <span class="keyword">this</span>.accumulator.ready(cluster, now);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 如果任何Partition的Leader不能确定，则需要强制获取最新的Partition的Leader信息。</span></span>
<span class="line">        <span class="keyword">if</span> (result.unknownLeadersExist)</span>
<span class="line">            <span class="keyword">this</span>.metadata.requestUpdate();</span>
<span class="line"></span>
<span class="line">        <span class="comment">// 剔除不可用的节点</span></span>
<span class="line">        Iterator&lt;Node&gt; iter = result.readyNodes.iterator();</span>
<span class="line">        <span class="keyword">long</span> notReadyTimeout = Long.MAX_VALUE;</span>
<span class="line">        <span class="keyword">while</span> (iter.hasNext()) &#123;</span>
<span class="line">            Node node = iter.next();</span>
<span class="line">            <span class="keyword">if</span> (!<span class="keyword">this</span>.client.ready(node, now)) &#123;</span>
<span class="line">                iter.remove();</span>
<span class="line">                notReadyTimeout = Math.min(notReadyTimeout, <span class="keyword">this</span>.client.connectionDelay(node, now));</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        <span class="comment">// create produce requests</span></span>
<span class="line">        Map&lt;Integer, List&lt;RecordBatch&gt;&gt; batches = <span class="keyword">this</span>.accumulator.drain(cluster,</span>
<span class="line">                                                                         result.readyNodes,</span>
<span class="line">                                                                         <span class="keyword">this</span>.maxRequestSize,</span>
<span class="line">                                                                         now);</span>
<span class="line">        <span class="comment">//是否需要保持消息的顺序，max.in.flight.requests.per.connection 的值　＝１　可以保证</span></span>
<span class="line">		<span class="keyword">if</span> (guaranteeMessageOrder) &#123;</span>
<span class="line">            <span class="comment">// Mute all the partitions drained</span></span>
<span class="line">            <span class="keyword">for</span> (List&lt;RecordBatch&gt; batchList : batches.values()) &#123;</span>
<span class="line">                <span class="keyword">for</span> (RecordBatch batch : batchList)</span>
<span class="line">                    <span class="keyword">this</span>.accumulator.mutePartition(batch.topicPartition);</span>
<span class="line">            &#125;</span>
<span class="line">        &#125;</span>
<span class="line"></span>
<span class="line">        List&lt;RecordBatch&gt; expiredBatches = <span class="keyword">this</span>.accumulator.abortExpiredBatches(<span class="keyword">this</span>.requestTimeout, now);</span>
<span class="line">        <span class="comment">// update sensors</span></span>
<span class="line">        <span class="keyword">for</span> (RecordBatch expiredBatch : expiredBatches)</span>
<span class="line">            <span class="keyword">this</span>.sensors.recordErrors(expiredBatch.topicPartition.topic(), expiredBatch.recordCount);</span>
<span class="line"></span>
<span class="line">        sensors.updateProduceRequestMetrics(batches);</span>
<span class="line">		<span class="comment">// 创建需要发送的请求包对象</span></span>
<span class="line">        List&lt;ClientRequest&gt; requests = createProduceRequests(batches, now);</span>
<span class="line">        <span class="comment">// If we have any nodes that are ready to send + have sendable data, poll with 0 timeout so this can immediately</span></span>
<span class="line">        <span class="comment">// loop and try sending more data. Otherwise, the timeout is determined by nodes that have partitions with data</span></span>
<span class="line">        <span class="comment">// that isn't yet sendable (e.g. lingering, backing off). Note that this specifically does not include nodes</span></span>
<span class="line">        <span class="comment">// with sendable data that aren't ready to send since they would cause busy looping.</span></span>
<span class="line">        <span class="keyword">long</span> pollTimeout = Math.min(result.nextReadyCheckDelayMs, notReadyTimeout);</span>
<span class="line">        <span class="keyword">if</span> (result.readyNodes.size() &gt; <span class="number">0</span>) &#123;</span>
<span class="line">            log.trace(<span class="string">"Nodes with data ready to send: &#123;&#125;"</span>, result.readyNodes);</span>
<span class="line">            log.trace(<span class="string">"Created &#123;&#125; produce requests: &#123;&#125;"</span>, requests.size(), requests);</span>
<span class="line">            pollTimeout = <span class="number">0</span>;</span>
<span class="line">        &#125;</span>
<span class="line">		<span class="comment">// 将请求包暂存在待发送队列中</span></span>
<span class="line">        <span class="keyword">for</span> (ClientRequest request : requests)</span>
<span class="line">            client.send(request, now);</span>
<span class="line"></span>
<span class="line">        <span class="comment">// if some partitions are already ready to be sent, the select time would be 0;</span></span>
<span class="line">        <span class="comment">// otherwise if some partition already has some data accumulated but not ready yet,</span></span>
<span class="line">        <span class="comment">// the select time will be the time difference between now and its linger expiry time;</span></span>
<span class="line">        <span class="comment">// otherwise the select time will be the time difference between now and the metadata expiry time;</span></span>
<span class="line">        <span class="comment">// 执行真正的网络ＩＯ操作，发送数据，读取响应，执行请求的回调函数</span></span>
<span class="line">        <span class="keyword">this</span>.client.poll(pollTimeout, now);</span>
<span class="line">    &#125;</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>创建客户端请求对象</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span>
<span class="line">2</span>
<span class="line">3</span>
<span class="line">4</span>
<span class="line">5</span>
<span class="line">6</span>
<span class="line">7</span>
<span class="line">8</span>
<span class="line">9</span>
<span class="line">10</span>
<span class="line">11</span>
<span class="line">12</span>
<span class="line">13</span>
<span class="line">14</span>
<span class="line">15</span>
<span class="line">16</span>
<span class="line">17</span>
<span class="line">18</span>
<span class="line">19</span>
<span class="line">20</span>
</pre></td><td class="code"><pre><span class="line"><span class="comment">// 创建客户端请求对象</span></span>
<span class="line"><span class="function"><span class="keyword">private</span> ClientRequest <span class="title">produceRequest</span><span class="params">(<span class="keyword">long</span> now, <span class="keyword">int</span> destination, <span class="keyword">short</span> acks, <span class="keyword">int</span> timeout, List&lt;RecordBatch&gt; batches)</span> </span>&#123;</span>
<span class="line">	Map&lt;TopicPartition, ByteBuffer&gt; produceRecordsByPartition = <span class="keyword">new</span> HashMap&lt;TopicPartition, ByteBuffer&gt;(batches.size());</span>
<span class="line">	<span class="keyword">final</span> Map&lt;TopicPartition, RecordBatch&gt; recordsByPartition = <span class="keyword">new</span> HashMap&lt;TopicPartition, RecordBatch&gt;(batches.size());</span>
<span class="line">	<span class="keyword">for</span> (RecordBatch batch : batches) &#123;</span>
<span class="line">		TopicPartition tp = batch.topicPartition;</span>
<span class="line">		produceRecordsByPartition.put(tp, batch.records.buffer());</span>
<span class="line">		recordsByPartition.put(tp, batch);</span>
<span class="line">	&#125;</span>
<span class="line">	ProduceRequest request = <span class="keyword">new</span> ProduceRequest(acks, timeout, produceRecordsByPartition);</span>
<span class="line">	RequestSend send = <span class="keyword">new</span> RequestSend(Integer.toString(destination),</span>
<span class="line">										<span class="keyword">this</span>.client.nextRequestHeader(ApiKeys.PRODUCE),</span>
<span class="line">										request.toStruct());</span>
<span class="line">	RequestCompletionHandler callback = <span class="keyword">new</span> RequestCompletionHandler() &#123;</span>
<span class="line">		<span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">onComplete</span><span class="params">(ClientResponse response)</span> </span>&#123;</span>
<span class="line">			handleProduceResponse(response, recordsByPartition, time.milliseconds());</span>
<span class="line">		&#125;</span>
<span class="line">	&#125;;</span>
<span class="line">	<span class="keyword">return</span> <span class="keyword">new</span> ClientRequest(now, acks != <span class="number">0</span>, send, callback);</span>
<span class="line">&#125;</span>
</pre></td></tr></table></figure>
<p>ClientRequest</p>
<pre><code class="java"><span class="keyword">public</span> <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">ClientRequest</span> </span>{
    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">long</span> createdTimeMs;
    <span class="comment">// 需要进行确认</span>
    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> expectResponse;
    <span class="keyword">private</span> <span class="keyword">final</span> RequestSend request;
    <span class="comment">// 回调</span>
    <span class="keyword">private</span> <span class="keyword">final</span> RequestCompletionHandler callback;
    <span class="keyword">private</span> <span class="keyword">final</span> <span class="keyword">boolean</span> isInitiatedByNetworkClient;
    <span class="keyword">private</span> <span class="keyword">long</span> sendTimeMs;
}
</code></pre>
<h2 id="Producer不丢失消息配置"><a href="#Producer不丢失消息配置" class="headerlink" title="Producer不丢失消息配置"></a>Producer不丢失消息配置</h2><ul>
<li>同步发送。 类似：producer.send(record).get();</li>
<li>block.on.buffer.full = true</li>
<li>acks = all</li>
<li>retries = MAX_VALUE</li>
<li>max.in.flight.requests.per.connection = 1</li>
<li>使用KafkaProducer.send(record, callback)</li>
<li>callback逻辑中显式关闭producer：close(0) </li>
<li>replication.factor &gt;= 3</li>
<li>min.insync.replicas &gt; 1 消息至少要被写入到这么多副本才算成功，也是提升数据持久性的一个参数。与acks配合使用<br>保证replication.factor &gt; min.insync.replicas  如果两者相等，当一个副本挂掉了分区也就没法正常工作了。通常设置replication.factor = min.insync.replicas + 1即可</li>
</ul>
<p>解释：</p>
<ol>
<li>block.on.buffer.full ： 使得producer将一直等待缓冲区直至其变为可用</li>
<li>acks ： 所有follower都响应了才认为消息提交成功，即”committed”</li>
<li>retries = MAX ： 无限重试</li>
<li>max.in.flight.requests.per.connection=1 ： 限制客户端在单个连接上能够发送的未响应请求的个数。<br>设置此值是1表示kafka broker在响应请求之前client不能再向同一个broker发送请求。注意：设置此参数是为了避免消息乱序</li>
<li>使用<code>KafkaProducer.send(record, callback)</code>而不是<code>send(record)</code>方法   自定义回调逻辑处理消息发送失败<br>callback逻辑中最好显式关闭<code>producer：close(0)</code></li>
<li>unclean.leader.election.enable=false  关闭unclean leader选举，即不允许非ISR中的副本被选举为leader，以避免数据丢失</li>
<li>replication.factor &gt;= 3 业界通用的设置，每个Partition的副本大于等于3</li>
<li>min.insync.replicas &gt; 1 消息至少要被写入到这么多副本才算成功，也是提升数据持久性的一个参数。与acks配合使用<br>保证replication.factor &gt; min.insync.replicas  如果两者相等，当一个副本挂掉了分区也就没法正常工作了。通常设置replication.factor = min.insync.replicas + 1即可</li>
</ol>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><ol>
<li>Kafka的消息发送是异步的。</li>
<li>Kafka提供了插件机制来扩展消息的发送流程，可以通过配置<code>interceptor.classes</code>来指定消息过滤器，在消息发送前对消息做特殊处理。</li>
<li>Kafka消息在通过网络发送前会累积在内存中（通过<code>RecordAccumulator</code>）。</li>
<li>通过配置<code>max.in.flight.requests.per.connection = 1</code> 可以让Kafka一次只发送一条消息，只有在上条消息ack后才发送下一条消息</li>
</ol>
]]></content>
    
    <summary type="html">
    
      &lt;h2 id=&quot;前言&quot;&gt;&lt;a href=&quot;#前言&quot; class=&quot;headerlink&quot; title=&quot;前言&quot;&gt;&lt;/a&gt;前言&lt;/h2&gt;&lt;p&gt;前面的一篇文章分析了消息发送时topic分区选择的问题，本文就分析一下后续的发送逻辑。&lt;/p&gt;
&lt;h2 id=&quot;消息发送涉及的类&quot;&gt;&lt;a href=&quot;#消息发送涉及的类&quot; class=&quot;headerlink&quot; title=&quot;消息发送涉及的类&quot;&gt;&lt;/a&gt;消息发送涉及的类&lt;/h2&gt;&lt;h3 id=&quot;Producer&quot;&gt;&lt;a href=&quot;#Producer&quot; class=&quot;headerlink&quot; title=&quot;Producer&quot;&gt;&lt;/a&gt;Producer&lt;/h3&gt;&lt;p&gt;&lt;code&gt;Producer&lt;/code&gt;类是Kafka消息的发送的入口&lt;/p&gt;
&lt;h3 id=&quot;ProducerFactory&quot;&gt;&lt;a href=&quot;#ProducerFactory&quot; class=&quot;headerlink&quot; title=&quot;ProducerFactory&quot;&gt;&lt;/a&gt;ProducerFactory&lt;/h3&gt;&lt;p&gt;&lt;code&gt;ProducerFactory&lt;/code&gt; 是一个策略接口，用来创佳&lt;code&gt;Producer&lt;/code&gt;, 默认的实现是：&lt;code&gt;DefaultKafkaProducerFactory&lt;/code&gt;,其创建&lt;br&gt;的&lt;code&gt;Producer&lt;/code&gt;是&lt;code&gt;CloseSafeProducer&lt;/code&gt;, &lt;code&gt;CloseSafeProducer&lt;/code&gt;是&lt;code&gt;KafkaProducer&lt;/code&gt;的一个代理类。&lt;/p&gt;
&lt;p&gt;&lt;code&gt;DefaultKafkaProducerFactory&lt;/code&gt; 的构造方法接收一个Map对象，用来指的创建&lt;code&gt;Producer&lt;/code&gt;的配置。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DefaultKafkaProducerFactory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Map&amp;lt;String, Object&amp;gt; configs)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;(configs, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;, &lt;span class=&quot;keyword&quot;&gt;null&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;DefaultKafkaProducerFactory&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(Map&amp;lt;String, Object&amp;gt; configs, Serializer&amp;lt;K&amp;gt; keySerializer,&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;		Serializer&amp;lt;V&amp;gt; valueSerializer)&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.configs = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;(configs);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.keySerializer = keySerializer;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;this&lt;/span&gt;.valueSerializer = valueSerializer;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h3 id=&quot;KafkaTemplate&quot;&gt;&lt;a href=&quot;#KafkaTemplate&quot; class=&quot;headerlink&quot; title=&quot;KafkaTemplate&quot;&gt;&lt;/a&gt;KafkaTemplate&lt;/h3&gt;&lt;p&gt;&lt;code&gt;KafkaTemplate&lt;/code&gt;是一个模板类，提供了操作Kafka的高级Api。&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; KafkaTemplate&amp;lt;Integer, String&amp;gt; &lt;span class=&quot;title&quot;&gt;createTemplate&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	Map&amp;lt;String, Object&amp;gt; senderProps = senderProps();&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	ProducerFactory&amp;lt;Integer, String&amp;gt; pf =&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;			&lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; DefaultKafkaProducerFactory&amp;lt;&amp;gt;(senderProps);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	KafkaTemplate&amp;lt;Integer, String&amp;gt; template = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; KafkaTemplate&amp;lt;&amp;gt;(pf);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; template;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;发送消息实例&quot;&gt;&lt;a href=&quot;#发送消息实例&quot; class=&quot;headerlink&quot; title=&quot;发送消息实例&quot;&gt;&lt;/a&gt;发送消息实例&lt;/h2&gt;&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;2&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;3&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;4&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;5&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;6&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;7&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;8&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;9&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;10&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;11&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;12&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;13&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;14&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;15&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;16&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;17&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;18&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;19&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;20&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;21&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;22&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;23&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;24&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;25&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 生产者配置项&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;private&lt;/span&gt; Map&amp;lt;String, Object&amp;gt; &lt;span class=&quot;title&quot;&gt;senderProps&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	Map&amp;lt;String, Object&amp;gt; props = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; HashMap&amp;lt;&amp;gt;();&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.BOOTSTRAP_SERVERS_CONFIG, &lt;span class=&quot;string&quot;&gt;&quot;localhost:9092&quot;&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.RETRIES_CONFIG, &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.BATCH_SIZE_CONFIG, &lt;span class=&quot;number&quot;&gt;16384&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.LINGER_MS_CONFIG, &lt;span class=&quot;number&quot;&gt;1&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.BUFFER_MEMORY_CONFIG, &lt;span class=&quot;number&quot;&gt;33554432&lt;/span&gt;);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.KEY_SERIALIZER_CLASS_CONFIG, IntegerSerializer.class);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	props.put(ProducerConfig.VALUE_SERIALIZER_CLASS_CONFIG, StringSerializer.class);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;return&lt;/span&gt; props;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125; &lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;comment&quot;&gt;// 创建生产者工厂实例&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;ProducerFactory&amp;lt;Integer, String&amp;gt; pf = &lt;span class=&quot;keyword&quot;&gt;new&lt;/span&gt; DefaultKafkaProducerFactory&amp;lt;&amp;gt;(senderProps);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt; &lt;span class=&quot;meta&quot;&gt;@Test&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;void&lt;/span&gt; &lt;span class=&quot;title&quot;&gt;testSendMsgSysn&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;()&lt;/span&gt; &lt;span class=&quot;keyword&quot;&gt;throws&lt;/span&gt; Exception &lt;/span&gt;&amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	KafkaTemplate&amp;lt;Integer, String&amp;gt; kafkaTemplate = createTemplate();&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&lt;span class=&quot;keyword&quot;&gt;for&lt;/span&gt; (&lt;span class=&quot;keyword&quot;&gt;int&lt;/span&gt; i = &lt;span class=&quot;number&quot;&gt;0&lt;/span&gt;; i &amp;lt; &lt;span class=&quot;number&quot;&gt;10&lt;/span&gt;; i++) &amp;#123;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// 同步发送&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;//kafkaTemplate.send(topic1, &quot;hello ===&amp;gt; &quot; + i).get();&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;		&lt;span class=&quot;comment&quot;&gt;// 异步发送&lt;/span&gt;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;		kafkaTemplate.send(topic1, &lt;span class=&quot;string&quot;&gt;&quot;hello ===&amp;gt; &quot;&lt;/span&gt; + i);&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;	&amp;#125;&lt;/span&gt;
&lt;span class=&quot;line&quot;&gt;&amp;#125;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;h2 id=&quot;消息发送过程分析&quot;&gt;&lt;a href=&quot;#消息发送过程分析&quot; class=&quot;headerlink&quot; title=&quot;消息发送过程分析&quot;&gt;&lt;/a&gt;消息发送过程分析&lt;/h2&gt;&lt;p&gt;&lt;code&gt;Producer&lt;/code&gt; 的一个重要方法就是&lt;code&gt;send&lt;/code&gt;, 方法签名如下：&lt;/p&gt;
&lt;figure class=&quot;highlight java&quot;&gt;&lt;table&gt;&lt;tr&gt;&lt;td class=&quot;gutter&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;1&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;td class=&quot;code&quot;&gt;&lt;pre&gt;&lt;span class=&quot;line&quot;&gt;&lt;span class=&quot;function&quot;&gt;&lt;span class=&quot;keyword&quot;&gt;public&lt;/span&gt; Future&amp;lt;RecordMetadata&amp;gt; &lt;span class=&quot;title&quot;&gt;send&lt;/span&gt;&lt;span class=&quot;params&quot;&gt;(ProducerRecord&amp;lt;K, V&amp;gt; record, Callback callback)&lt;/span&gt;&lt;/span&gt;;&lt;/span&gt;
&lt;/pre&gt;&lt;/td&gt;&lt;/tr&gt;&lt;/table&gt;&lt;/figure&gt;
&lt;p&gt;从方法的签名我们能够推断出，Kafka的消息发送是异步的。 这个从后面的分析可以得证。&lt;/p&gt;
    
    </summary>
    
      <category term="消息中间件" scheme="https://leokongwq.github.io/categories/%E6%B6%88%E6%81%AF%E4%B8%AD%E9%97%B4%E4%BB%B6/"/>
    
    
      <category term="MQ" scheme="https://leokongwq.github.io/tags/MQ/"/>
    
      <category term="kafka" scheme="https://leokongwq.github.io/tags/kafka/"/>
    
  </entry>
  
</feed>
